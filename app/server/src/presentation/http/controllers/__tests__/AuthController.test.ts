/**
 * AuthController ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹é›†
 * JWTæ¤œè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ POST /api/auth/verify ã®ãƒ†ã‚¹ãƒˆ
 */
import { describe, test, beforeEach, afterEach, expect, mock, spyOn } from 'bun:test';
import type { Context } from 'hono';
import type { Mock } from 'bun:test';
import { AuthController } from '../AuthController';
import type { IAuthenticateUserUseCase } from '@/application/interfaces/IAuthenticateUserUseCase';
import { AuthenticationError } from '@/domain/user/errors/AuthenticationError';
import { ValidationError } from '@/shared/errors/ValidationError';
import { UserEntity } from '@/domain/user/UserEntity';
import type { AuthProvider } from '@/domain/user/AuthProvider';
import { AuthProviders } from '@/domain/user/AuthProvider';
import type { AuthResponse, ErrorResponse } from '@/../../packages/shared-schemas';
import type { AuthenticateUserUseCaseOutput } from '@/application/interfaces/IAuthenticateUserUseCase';

// ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: ãƒ¢ãƒƒã‚¯å‹ã®å®šç¾©
type MockContext = {
  req: {
    json: Mock<() => Promise<any>>;
    header: Mock<(name?: string) => string | undefined>;
    method: string;
    url: string;
  };
  json: Mock<(data: any, status?: number) => any>;
  status: Mock<(code: number) => any>;
};

describe('AuthController', () => {
  let authController: AuthController;
  let mockAuthenticateUserUseCase: IAuthenticateUserUseCase;
  let mockContext: MockContext;

  beforeEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ãƒ¢ãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–
    // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: å‰ã®ãƒ†ã‚¹ãƒˆã®çŠ¶æ…‹ãŒå½±éŸ¿ã—ãªã„ã‚ˆã†ã€æ–°ã—ã„ãƒ¢ãƒƒã‚¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: AuthenticateUserUseCaseOutputã‚’è¿”ã™ã‚ˆã†ä¿®æ­£
    // ãƒ¢ãƒƒã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«ä½œæˆã™ã‚‹ã“ã¨ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã®æ·±åº¦å•é¡Œã‚’å›é¿
    const createMockUser = () => UserEntity.create({
      externalId: 'test123',
      provider: AuthProviders.GOOGLE,
      email: 'test@example.com',
      name: 'Test User'
    });
    mockAuthenticateUserUseCase = {
      execute: mock(() => Promise.resolve({ 
        user: createMockUser(),
        isNewUser: false 
      })),
    } as IAuthenticateUserUseCase;

    authController = new AuthController(mockAuthenticateUserUseCase);

    // ã€Context ãƒ¢ãƒƒã‚¯æº–å‚™ã€‘: Hono ã® Context ã‚’ãƒ¢ãƒƒã‚¯åŒ–
    // ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹æº–å‚™ã€‘: HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹•ä½œã‚’æ¨¡æ“¬
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: MockContextå‹ã‚’ä½¿ç”¨ã—ã¦å‹å®‰å…¨ãªãƒ¢ãƒƒã‚¯ã‚’ä½œæˆ
    mockContext = {
      req: {
        json: mock(() => Promise.resolve({})),
        header: mock(() => undefined),
        method: 'POST',
        url: 'http://localhost:3000/api/auth/verify'
      },
      json: mock((data: any, status?: number) => ({ data, status })),
      status: mock((code: number) => mockContext),
    };
  });

  afterEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†ã€‘: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œã«ãƒ¢ãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
    // ã€çŠ¶æ…‹å¾©å…ƒã€‘: æ¬¡ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã€ãƒ¢ãƒƒã‚¯ã®å‘¼ã³å‡ºã—å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
    mock.restore();
  });

  // ========== æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆ ==========
  test('æœ‰åŠ¹ãªJWTãƒˆãƒ¼ã‚¯ãƒ³ãŒæä¾›ã•ã‚ŒãŸå ´åˆã€èªè¨¼ã«æˆåŠŸã™ã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: æœ‰åŠ¹ãªJWTãƒˆãƒ¼ã‚¯ãƒ³ã§ã®èªè¨¼å‡¦ç†ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: æ­£ã—ã„å½¢å¼ã®JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ã—ã€èªè¨¼UseCaseãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 200ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§èªè¨¼æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹
    // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å®šç¾©æ›¸ã«åŸºã¥ãæ¨™æº–çš„ãªæ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆ

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æœ‰åŠ¹ãªJWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: èªè¨¼ãŒæˆåŠŸã™ã‚‹æ¡ä»¶ã§UseCaseã‚’ãƒ¢ãƒƒã‚¯åŒ–
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: UserEntity.create()ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
    const validJwtToken = 'valid.jwt.token';
    const requestBody = { token: validJwtToken };
    const createExpectedUser = () => UserEntity.create({
      externalId: 'user123',
      provider: AuthProviders.GOOGLE,
      email: 'test@example.com',
      name: 'Test User'
    });
    const expectedUser = createExpectedUser();
    
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: ãƒ¢ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã«é©åˆ‡ãªå‹ã‚’æŒ‡å®š
    mockContext.req.json = mock(() => Promise.resolve(requestBody)) as any;
    mockAuthenticateUserUseCase.execute = mock(() => Promise.resolve({ user: expectedUser, isNewUser: false })) as any;

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: AuthController ã® verifyToken ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—
    // ã€å‡¦ç†å†…å®¹ã€‘: JWTãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã¨èªè¨¼å‡¦ç†ã‚’å®Ÿè¡Œ
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: MockContextã‚’Contextã«ã‚­ãƒ£ã‚¹ãƒˆã—ã¦å‘¼ã³å‡ºã—
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: èªè¨¼æˆåŠŸæ™‚ã®æœŸå¾…å€¤ã¨å®Ÿéš›ã®çµæœã‚’æ¯”è¼ƒ
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹200ã¨æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).toHaveBeenCalledWith({ jwt: validJwtToken }); // ã€ç¢ºèªå†…å®¹ã€‘: UseCaseãŒæ­£ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã§å‘¼ã³å‡ºã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼ ğŸŸ¢
    expect(mockContext.json).toHaveBeenCalledWith({ success: true, user: expectedUser, isNewUser: false }, 200); // ã€ç¢ºèªå†…å®¹ã€‘: 200ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
  });

  test('æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€JITãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã•ã‚Œã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®JWTæ¤œè¨¼æ™‚ã«Just-In-Time ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: åˆå›èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®JWTãƒˆãƒ¼ã‚¯ãƒ³ã§èªè¨¼ã—ã€æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ—ãƒ­ã‚»ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã•ã‚Œã€èªè¨¼æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹
    // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: è¦ä»¶å®šç¾©æ›¸ã§æ˜ç¢ºã«è¦å®šã•ã‚ŒãŸJITãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: JITãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚‹æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãŒæˆåŠŸã™ã‚‹æ¡ä»¶ã‚’è¨­å®š
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: UserEntity.create()ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
    const newUserJwtToken = 'new.user.jwt.token';
    const requestBody = { token: newUserJwtToken };
    const createNewUser = () => UserEntity.create({
      externalId: 'newuser456',
      provider: AuthProviders.GOOGLE,
      email: 'newuser@example.com',
      name: 'New User'
    });
    const newUser = createNewUser();
    
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: ãƒ¢ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã«é©åˆ‡ãªå‹ã‚’æŒ‡å®š
    mockContext.req.json = mock(() => Promise.resolve(requestBody)) as any;
    mockAuthenticateUserUseCase.execute = mock(() => Promise.resolve({ user: newUser, isNewUser: true })) as any;

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®JWTèªè¨¼å‡¦ç†ã‚’å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: JITãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚‹æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã¨èªè¨¼ã‚’åŒæ™‚å®Ÿè¡Œ
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: JITãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãŒæ­£å¸¸ã«å‹•ä½œã—ãŸã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæˆåŠŸã¨èªè¨¼æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).toHaveBeenCalledWith({ jwt: newUserJwtToken }); // ã€ç¢ºèªå†…å®¹ã€‘: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ã§UseCaseãŒå‘¼ã³å‡ºã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    expect(mockContext.json).toHaveBeenCalledWith({ success: true, user: newUser, isNewUser: true }, 200); // ã€ç¢ºèªå†…å®¹ã€‘: JITãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
  });

  test('æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€èªè¨¼ã®ã¿ãŒå®Ÿè¡Œã•ã‚Œã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®JWTèªè¨¼æ™‚ã«æ–°è¦ä½œæˆå‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œãªã„ã“ã¨ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®JWTãƒˆãƒ¼ã‚¯ãƒ³ã§èªè¨¼ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã®ã¿ãŒè¡Œã‚ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¿”ã•ã‚Œã€æ–°è¦ä½œæˆãƒ•ãƒ©ã‚°ãŒè¨­å®šã•ã‚Œãªã„
    // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã¯ä¸€èˆ¬çš„ãªè¦ä»¶ã¨ã—ã¦æ˜ç¢º

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼ãŒæˆåŠŸã™ã‚‹æ¡ä»¶ã‚’è¨­å®š
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: UserEntity.create()ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
    const existingUserJwtToken = 'existing.user.jwt.token';
    const requestBody = { token: existingUserJwtToken };
    const createExistingUser = () => UserEntity.create({
      externalId: 'existing789',
      provider: AuthProviders.GOOGLE,
      email: 'existing@example.com',
      name: 'Existing User'
    });
    const existingUser = createExistingUser();
    
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: ãƒ¢ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã«é©åˆ‡ãªå‹ã‚’æŒ‡å®š
    mockContext.req.json = mock(() => Promise.resolve(requestBody)) as any;
    mockAuthenticateUserUseCase.execute = mock(() => Promise.resolve({ user: existingUser, isNewUser: false })) as any;

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®JWTèªè¨¼å‡¦ç†ã‚’å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚’å®Ÿè¡Œ
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãŒæ­£å¸¸ã«å‹•ä½œã—ãŸã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: æ–°è¦ä½œæˆãƒ•ãƒ©ã‚°ãŒè¨­å®šã•ã‚Œãšã«èªè¨¼æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).toHaveBeenCalledWith({ jwt: existingUserJwtToken }); // ã€ç¢ºèªå†…å®¹ã€‘: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ã§UseCaseãŒå‘¼ã³å‡ºã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    expect(mockContext.json).toHaveBeenCalledWith({ success: true, user: existingUser, isNewUser: false }, 200); // ã€ç¢ºèªå†…å®¹ã€‘: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
  });

  // ========== ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆ ==========
  test('ä¸æ­£ãªJWTãƒˆãƒ¼ã‚¯ãƒ³ãŒæä¾›ã•ã‚ŒãŸå ´åˆã€èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ä¸æ­£ãªå½¢å¼ã‚„æ”¹ã–ã‚“ã•ã‚ŒãŸJWTãƒˆãƒ¼ã‚¯ãƒ³ã«å¯¾ã™ã‚‹é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ç„¡åŠ¹ãªJWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ã—ã€èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 401ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
    // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã¨ã—ã¦æ˜ç¢ºã«å®šç¾©ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ä¸æ­£ãªJWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: AuthenticationErrorãŒç™ºç”Ÿã™ã‚‹æ¡ä»¶ã‚’è¨­å®š
    const invalidJwtToken = 'invalid.jwt.token';
    const requestBody = { token: invalidJwtToken };
    
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: ãƒ¢ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã«é©åˆ‡ãªå‹ã‚’æŒ‡å®š
    mockContext.req.json = mock(() => Promise.resolve(requestBody)) as any;
    mockAuthenticateUserUseCase.execute = mock(() => Promise.reject(new AuthenticationError('Invalid JWT token'))) as any;

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ä¸æ­£ãªJWTãƒˆãƒ¼ã‚¯ãƒ³ã§ã®èªè¨¼å‡¦ç†ã‚’å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: JWTæ¤œè¨¼å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 401ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).toHaveBeenCalledWith({ jwt: invalidJwtToken }); // ã€ç¢ºèªå†…å®¹ã€‘: ä¸æ­£ãƒˆãƒ¼ã‚¯ãƒ³ã§UseCaseãŒå‘¼ã³å‡ºã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    expect(mockContext.json).toHaveBeenCalledWith({ success: false, error: 'Invalid JWT token' }, 401); // ã€ç¢ºèªå†…å®¹ã€‘: 401ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
  });

  test('æœŸé™åˆ‡ã‚Œã®JWTãƒˆãƒ¼ã‚¯ãƒ³ãŒæä¾›ã•ã‚ŒãŸå ´åˆã€èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: æœŸé™åˆ‡ã‚ŒJWTãƒˆãƒ¼ã‚¯ãƒ³ã«å¯¾ã™ã‚‹é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: æœ‰åŠ¹æœŸé™ã‚’éããŸJWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ã—ã€æœŸé™åˆ‡ã‚Œã‚¨ãƒ©ãƒ¼ãŒå‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 401ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§æœŸé™åˆ‡ã‚Œã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
    // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: JWTä»•æ§˜ã«åŸºã¥ãæ¨™æº–çš„ãªã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æœŸé™åˆ‡ã‚Œã®JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: JWTæœŸé™åˆ‡ã‚Œã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹æ¡ä»¶ã‚’è¨­å®š
    const expiredJwtToken = 'expired.jwt.token';
    const requestBody = { token: expiredJwtToken };
    
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: ãƒ¢ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã«é©åˆ‡ãªå‹ã‚’æŒ‡å®š
    mockContext.req.json = mock(() => Promise.resolve(requestBody)) as any;
    mockAuthenticateUserUseCase.execute = mock(() => Promise.reject(new AuthenticationError('JWT token has expired'))) as any;

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: æœŸé™åˆ‡ã‚ŒJWTãƒˆãƒ¼ã‚¯ãƒ³ã§ã®èªè¨¼å‡¦ç†ã‚’å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: JWTæœŸé™åˆ‡ã‚Œæ¤œè¨¼ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: æœŸé™åˆ‡ã‚Œã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 401ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§æœŸé™åˆ‡ã‚Œã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).toHaveBeenCalledWith({ jwt: expiredJwtToken }); // ã€ç¢ºèªå†…å®¹ã€‘: æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã§UseCaseãŒå‘¼ã³å‡ºã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸŸ¢
    expect(mockContext.json).toHaveBeenCalledWith({ success: false, error: 'JWT token has expired' }, 401); // ã€ç¢ºèªå†…å®¹ã€‘: 401ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§æœŸé™åˆ‡ã‚Œã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
  });

  test('tokenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¸è¶³ã«å¯¾ã™ã‚‹é©åˆ‡ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: tokenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒå‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 400ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
    // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: APIä»•æ§˜ã¨ã—ã¦æ˜ç¢ºã«å®šç¾©ã•ã‚ŒãŸå¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: tokenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ¬ è½ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ValidationErrorãŒç™ºç”Ÿã™ã‚‹æ¡ä»¶ã‚’è¨­å®š
    const requestBodyWithoutToken = {};
    
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: ãƒ¢ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã«é©åˆ‡ãªå‹ã‚’æŒ‡å®š
    mockContext.req.json = mock(() => Promise.resolve(requestBodyWithoutToken)) as any;

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: tokenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸è¶³æ™‚ã®å‡¦ç†ã‚’å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 400ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).not.toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: UseCaseãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‰æ®µã§ã®æ‹’å¦ï¼‰ ğŸŸ¢
    expect(mockContext.json).toHaveBeenCalledWith({ success: false, error: 'Token is required' }, 400); // ã€ç¢ºèªå†…å®¹ã€‘: 400ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
  });

  test('ç©ºæ–‡å­—ã®tokenãŒæä¾›ã•ã‚ŒãŸå ´åˆã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ç©ºæ–‡å­—ãƒˆãƒ¼ã‚¯ãƒ³ã«å¯¾ã™ã‚‹é©åˆ‡ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ç©ºæ–‡å­—åˆ—ã®tokenã‚’é€ä¿¡ã—ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒå‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 400ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
    // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ä¸€èˆ¬çš„ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¦ä»¶ã¨ã—ã¦æ¨æ¸¬ã•ã‚Œã‚‹å†…å®¹

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç©ºæ–‡å­—åˆ—ã®tokenã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ç©ºæ–‡å­—ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹æ¡ä»¶ã‚’è¨­å®š
    const requestBodyWithEmptyToken = { token: '' };
    
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: ãƒ¢ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã«é©åˆ‡ãªå‹ã‚’æŒ‡å®š
    mockContext.req.json = mock(() => Promise.resolve(requestBodyWithEmptyToken)) as any;

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ç©ºæ–‡å­—tokenæ™‚ã®å‡¦ç†ã‚’å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: ãƒˆãƒ¼ã‚¯ãƒ³å€¤ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: ç©ºæ–‡å­—ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 400ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ç©ºæ–‡å­—ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).not.toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: UseCaseãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‰æ®µã§ã®æ‹’å¦ï¼‰ ğŸŸ¡
    expect(mockContext.json).toHaveBeenCalledWith({ success: false, error: 'Token cannot be empty' }, 400); // ã€ç¢ºèªå†…å®¹ã€‘: 400ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ç©ºæ–‡å­—ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
  });

  test('ä¸æ­£ãªå½¢å¼ã®JSONãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆã€ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ä¸æ­£ãªJSONå½¢å¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã™ã‚‹é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ãƒ‘ãƒ¼ã‚¹ä¸å¯èƒ½ãªJSONã‚’é€ä¿¡ã—ã€ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒå‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 400ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
    // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: HTTP API ã®ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¦ä»¶ã¨ã—ã¦æ¨æ¸¬

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: JSON ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹æ¡ä»¶ã‚’è¨­å®š
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: ãƒ¢ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã«é©åˆ‡ãªå‹ã‚’æŒ‡å®š
    mockContext.req.json = mock(() => Promise.reject(new Error('Invalid JSON format'))) as any;

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ä¸æ­£JSONæ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: JSONãƒ‘ãƒ¼ã‚¹å‡¦ç†ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 400ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).not.toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: UseCaseãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªï¼ˆJSON ãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ï¼‰ ğŸŸ¡
    expect(mockContext.json).toHaveBeenCalledWith({ success: false, error: 'Invalid JSON format' }, 400); // ã€ç¢ºèªå†…å®¹ã€‘: 400ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
  });

  test('å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: Supabaseç­‰å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 500ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§å†…éƒ¨ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
    // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: å¤–éƒ¨ä¾å­˜ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ã—ã¦ä¸€èˆ¬çš„ãªè¦ä»¶

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æœ‰åŠ¹ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã ãŒå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹æ¡ä»¶ã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹æ¡ä»¶ã‚’è¨­å®š
    const validJwtToken = 'valid.jwt.token';
    const requestBody = { token: validJwtToken };
    
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: ãƒ¢ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã«é©åˆ‡ãªå‹ã‚’æŒ‡å®š
    mockContext.req.json = mock(() => Promise.resolve(requestBody)) as any;
    mockAuthenticateUserUseCase.execute = mock(() => Promise.reject(new Error('External service unavailable'))) as any;

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†ã‚’å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹å‘¼ã³å‡ºã—ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 500ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§å†…éƒ¨ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).toHaveBeenCalledWith({ jwt: validJwtToken }); // ã€ç¢ºèªå†…å®¹ã€‘: UseCaseãŒæ­£å¸¸ã«å‘¼ã³å‡ºã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸŸ¡
    expect(mockContext.json).toHaveBeenCalledWith({ success: false, error: 'Internal server error' }, 500); // ã€ç¢ºèªå†…å®¹ã€‘: 500ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§å†…éƒ¨ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
  });

  test('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€æ±ç”¨ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: æƒ³å®šå¤–ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: äºˆæœŸã—ãªã„ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸéš›ã®æ±ç”¨ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 500ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§æ±ç”¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
    // ğŸ”´ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦æ¨æ¸¬ã•ã‚Œã‚‹å†…å®¹

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹æ¡ä»¶ã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: æƒ³å®šå¤–ã®ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹æ¡ä»¶ã‚’è¨­å®š
    const validJwtToken = 'valid.jwt.token';
    const requestBody = { token: validJwtToken };
    
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: ãƒ¢ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã«é©åˆ‡ãªå‹ã‚’æŒ‡å®š
    mockContext.req.json = mock(() => Promise.resolve(requestBody)) as any;
    mockAuthenticateUserUseCase.execute = mock(() => Promise.reject(new TypeError('Unexpected error'))) as any;

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†ã‚’å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: ä¾‹å¤–æ•æ‰ã¨æ±ç”¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 500ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§æ±ç”¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).toHaveBeenCalledWith({ jwt: validJwtToken }); // ã€ç¢ºèªå†…å®¹ã€‘: UseCaseãŒæ­£å¸¸ã«å‘¼ã³å‡ºã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”´
    expect(mockContext.json).toHaveBeenCalledWith({ success: false, error: 'Internal server error' }, 500); // ã€ç¢ºèªå†…å®¹ã€‘: 500ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§æ±ç”¨ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”´
  });

  // ========== å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ ==========
  test('GETãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸå ´åˆã€405ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: è¨±å¯ã•ã‚Œã¦ã„ãªã„HTTPãƒ¡ã‚½ãƒƒãƒ‰ã«å¯¾ã™ã‚‹é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: POSTä»¥å¤–ã®HTTPãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆGETï¼‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸéš›ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 405ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒ¡ã‚½ãƒƒãƒ‰ä¸è¨±å¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
    // ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: REST API ã®æ¨™æº–çš„ãªHTTPãƒ¡ã‚½ãƒƒãƒ‰åˆ¶é™ã¨ã—ã¦æ˜ç¢º

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: GETãƒ¡ã‚½ãƒƒãƒ‰ã§ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: HTTPãƒ¡ã‚½ãƒƒãƒ‰åˆ¶é™ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹æ¡ä»¶ã‚’è¨­å®š
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: MockContextå‹ã§methodã‚’è¨­å®š
    mockContext = {
      ...mockContext,
      req: {
        ...mockContext.req,
        method: 'GET'
      }
    };

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ä¸è¨±å¯HTTPãƒ¡ã‚½ãƒƒãƒ‰æ™‚ã®å‡¦ç†ã‚’å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: HTTPãƒ¡ã‚½ãƒƒãƒ‰æ¤œè¨¼ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: HTTPãƒ¡ã‚½ãƒƒãƒ‰åˆ¶é™ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 405ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒ¡ã‚½ãƒƒãƒ‰ä¸è¨±å¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).not.toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: UseCaseãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªï¼ˆãƒ¡ã‚½ãƒƒãƒ‰åˆ¶é™å‰æ®µã§ã®æ‹’å¦ï¼‰ ğŸŸ¢
    expect(mockContext.json).toHaveBeenCalledWith({ success: false, error: 'Method not allowed' }, 405); // ã€ç¢ºèªå†…å®¹ã€‘: 405ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒ¡ã‚½ãƒƒãƒ‰ä¸è¨±å¯ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¢
  });

  test('ä¸æ­£ãªContent-Typeã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸå ´åˆã€415ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ä¸é©åˆ‡ãªContent-Typeã«å¯¾ã™ã‚‹é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: application/jsonä»¥å¤–ã®Content-Typeã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸéš›ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 415ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§Content-Typeä¸æ­£ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
    // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: JSON API ã®ä¸€èˆ¬çš„ãªContent-Typeåˆ¶é™ã¨ã—ã¦æ¨æ¸¬

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ä¸æ­£ãªContent-Typeã§ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: Content-Typeåˆ¶é™ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹æ¡ä»¶ã‚’è¨­å®š
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: MockContextå‹ã§headerãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¨­å®š
    mockContext = {
      ...mockContext,
      req: {
        ...mockContext.req,
        header: mock((headerName?: string) => {
          if (headerName && headerName.toLowerCase() === 'content-type') return 'text/plain';
          return undefined;
        })
      }
    };

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ä¸æ­£Content-Typeæ™‚ã®å‡¦ç†ã‚’å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: Content-Typeæ¤œè¨¼ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: Content-Typeåˆ¶é™ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 415ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§Content-Typeä¸æ­£ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).not.toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: UseCaseãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªï¼ˆContent-Typeåˆ¶é™å‰æ®µã§ã®æ‹’å¦ï¼‰ ğŸŸ¡
    expect(mockContext.json).toHaveBeenCalledWith({ success: false, error: 'Content-Type must be application/json' }, 415); // ã€ç¢ºèªå†…å®¹ã€‘: 415ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§Content-Typeä¸æ­£ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
  });

  test('ä¸æ­£ãªURLãƒ‘ã‚¹ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸå ´åˆã€404ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: å­˜åœ¨ã—ãªã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã™ã‚‹é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: /api/auth/verifyä»¥å¤–ã®URLãƒ‘ã‚¹ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸéš›ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 404ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸å­˜åœ¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
    // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: REST API ã®ä¸€èˆ¬çš„ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ã—ã¦æ¨æ¸¬

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ä¸æ­£ãªURLãƒ‘ã‚¹ã§ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹æ¡ä»¶ã‚’è¨­å®š
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: MockContextå‹ã§URLã‚’è¨­å®š
    mockContext = {
      ...mockContext,
      req: {
        ...mockContext.req,
        url: 'http://localhost:3000/api/auth/invalid-path'
      }
    };

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ä¸æ­£URLãƒ‘ã‚¹æ™‚ã®å‡¦ç†ã‚’å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: URLãƒ‘ã‚¹æ¤œè¨¼ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: URLãƒ‘ã‚¹ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 404ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸å­˜åœ¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).not.toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: UseCaseãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªï¼ˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å‰æ®µã§ã®æ‹’å¦ï¼‰ ğŸŸ¡
    expect(mockContext.json).toHaveBeenCalledWith({ success: false, error: 'Endpoint not found' }, 404); // ã€ç¢ºèªå†…å®¹ã€‘: 404ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸å­˜åœ¨ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
  });

  test('éå¸¸ã«é•·ã„ãƒˆãƒ¼ã‚¯ãƒ³æ–‡å­—åˆ—ãŒæä¾›ã•ã‚ŒãŸå ´åˆã€é©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: æ¥µç«¯ã«é•·ã„ãƒˆãƒ¼ã‚¯ãƒ³æ–‡å­—åˆ—ã«å¯¾ã™ã‚‹é©åˆ‡ãªå‡¦ç†ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰åˆ¶é™ã‚’è¶…ãˆã‚‹é•·ã•ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ã—ã€é©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 400ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒˆãƒ¼ã‚¯ãƒ³é•·åˆ¶é™ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
    // ğŸ”´ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: å…·ä½“çš„ãªåˆ¶é™å€¤ãŒè¦ä»¶å®šç¾©ã«ãªã„ãŸã‚æ¨æ¸¬ã•ã‚Œã‚‹å†…å®¹

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç•°å¸¸ã«é•·ã„ãƒˆãƒ¼ã‚¯ãƒ³æ–‡å­—åˆ—ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ãƒˆãƒ¼ã‚¯ãƒ³é•·åˆ¶é™ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹æ¡ä»¶ã‚’è¨­å®š
    const veryLongToken = 'a'.repeat(10000); // 10KB ã®ãƒˆãƒ¼ã‚¯ãƒ³æ–‡å­—åˆ—
    const requestBody = { token: veryLongToken };
    
    // ğŸŸ¢ ã€å‹å®‰å…¨æ€§æ”¹å–„ã€‘: ãƒ¢ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã«é©åˆ‡ãªå‹ã‚’æŒ‡å®š
    mockContext.req.json = mock(() => Promise.resolve(requestBody)) as any;

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: é•·ã„ãƒˆãƒ¼ã‚¯ãƒ³æ™‚ã®å‡¦ç†ã‚’å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: ãƒˆãƒ¼ã‚¯ãƒ³é•·åˆ¶é™æ¤œè¨¼ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
    const result = await authController.verifyToken(mockContext as unknown as Context);

    // ã€çµæœæ¤œè¨¼ã€‘: ãƒˆãƒ¼ã‚¯ãƒ³é•·åˆ¶é™ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 400ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒˆãƒ¼ã‚¯ãƒ³é•·åˆ¶é™ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(mockAuthenticateUserUseCase.execute).not.toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: UseCaseãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªï¼ˆãƒˆãƒ¼ã‚¯ãƒ³é•·åˆ¶é™å‰æ®µã§ã®æ‹’å¦ï¼‰ ğŸ”´
    expect(mockContext.json).toHaveBeenCalledWith({ success: false, error: 'Token is too long' }, 400); // ã€ç¢ºèªå†…å®¹ã€‘: 400ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒˆãƒ¼ã‚¯ãƒ³é•·åˆ¶é™ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”´
  });
});