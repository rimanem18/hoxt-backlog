/**
 * JWTæ¤œè¨¼ã‚µãƒ¼ãƒ“ã‚¹
 *
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: JWTãƒˆãƒ¼ã‚¯ãƒ³ã®æ§‹é€ çš„æ¤œè¨¼ã‚’è¡Œã†å°‚é–€ã‚µãƒ¼ãƒ“ã‚¹
 * ã€SOLIDåŸå‰‡é©ç”¨ã€‘: Single Responsibility Principle - JWTæ¤œè¨¼ã®ã¿ã«è²¬å‹™ã‚’é›†ä¸­
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: æš—å·å­¦çš„æ¤œè¨¼å‰ã®é«˜é€Ÿãªäº‹å‰ãƒã‚§ãƒƒã‚¯ã‚’æä¾›ã—ã€ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ—©æœŸã«æ’é™¤
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã€‘: CPUè² è·ã®é«˜ã„æš—å·æ¤œè¨¼å‰ã«åŸºæœ¬çš„ãªæ§‹é€ ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
 *
 * ğŸŸ¢ DDD Clean Architecture + SOLIDåŸå‰‡å¼·åŒ–ã®ãŸã‚ã®Refactorãƒ•ã‚§ãƒ¼ã‚ºæ”¹å–„
 */

/**
 * JWTæ¤œè¨¼çµæœ
 *
 * ã€å‹å®šç¾©ã€‘: JWTæ¤œè¨¼ã®çµæœã‚’è¡¨ç¾ã™ã‚‹å‹
 * ã€è¨­è¨ˆæ€æƒ³ã€‘: æˆåŠŸãƒ»å¤±æ•—ã®è©³ç´°æƒ…å ±ã‚’å«ã‚€çµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
export interface JwtValidationResult {
  /** æ¤œè¨¼æˆåŠŸãƒ•ãƒ©ã‚° */
  readonly isValid: boolean;
  /** æ¤œè¨¼å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
  readonly errorMessage?: string;
  /** æ¤œè¨¼å¤±æ•—ã®è©³ç´°ç†ç”±ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ */
  readonly failureReason?: 'EMPTY' | 'TOO_LONG' | 'INVALID_FORMAT';
}

/**
 * JWTæ¤œè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®š
 *
 * ã€è¨­å®šé …ç›®ã€‘: JWTæ¤œè¨¼ã«å¿…è¦ãªè¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
 * ã€å¤–éƒ¨åŒ–ã€‘: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é¿ã‘ã€è¨­å®šã‚’å¤–éƒ¨ã‹ã‚‰æ³¨å…¥å¯èƒ½ã«
 */
export interface JwtValidationConfig {
  /** JWTæœ€å¤§é•·åˆ¶é™ï¼ˆãƒã‚¤ãƒˆæ•°ï¼‰ */
  readonly maxLength: number;
}

/**
 * JWTæ¤œè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
 *
 * ã€æŠ½è±¡åŒ–ã€‘: Dependency Inversion Principle - å…·è±¡ã§ã¯ãªãæŠ½è±¡ã«ä¾å­˜
 * ã€ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã€‘: ãƒ¢ãƒƒã‚¯ä½œæˆã‚’å®¹æ˜“ã«ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©
 * ã€æ‹¡å¼µæ€§ã€‘: å°†æ¥çš„ãªæ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯æ‹¡å¼µã«å¯¾å¿œ
 */
export interface IJwtValidationService {
  /**
   * JWTæ§‹é€ æ¤œè¨¼
   *
   * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: JWTãƒˆãƒ¼ã‚¯ãƒ³ã®åŸºæœ¬çš„ãªæ§‹é€ æ¤œè¨¼ã‚’å®Ÿè¡Œ
   * ã€æ¤œè¨¼é …ç›®ã€‘: ç©ºæ–‡å­—ãƒ»é•·ã•åˆ¶é™ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
   * ã€æˆ»ã‚Šå€¤ã€‘: æ¤œè¨¼çµæœã¨å¤±æ•—ç†ç”±ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   *
   * @param jwt - æ¤œè¨¼å¯¾è±¡ã®JWTãƒˆãƒ¼ã‚¯ãƒ³
   * @returns æ¤œè¨¼çµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  validateStructure(jwt: string): JwtValidationResult;
}

/**
 * JWTæ¤œè¨¼ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…
 *
 * ã€è²¬å‹™ã€‘: JWTãƒˆãƒ¼ã‚¯ãƒ³ã®æ§‹é€ çš„æ¤œè¨¼ã®ã¿ã‚’æ‹…å½“
 * ã€ç¯„å›²ã€‘: æš—å·å­¦çš„æ¤œè¨¼ã¯å¯¾è±¡å¤–ï¼ˆIAuthProviderãŒæ‹…å½“ï¼‰
 * ã€æœ€é©åŒ–ã€‘: é«˜é€Ÿãªäº‹å‰ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚Šç„¡åŠ¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ—©æœŸæ’é™¤
 * ã€ä¿å®ˆæ€§ã€‘: æ¤œè¨¼ãƒ«ãƒ¼ãƒ«ãŒä¸€ç®‡æ‰€ã«é›†ç´„ã•ã‚Œã€å¤‰æ›´æ™‚ã®å½±éŸ¿ç¯„å›²ã‚’é™å®š
 *
 * ğŸŸ¢ AuthenticateUserUseCase ã‹ã‚‰åˆ†é›¢ã—ã¦SRPå¼·åŒ–
 */
export class JwtValidationService implements IJwtValidationService {
  private readonly config: JwtValidationConfig;

  /**
   * JWTæ¤œè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
   *
   * ã€ä¾å­˜æ€§æ³¨å…¥ã€‘: è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¤–éƒ¨ã‹ã‚‰æ³¨å…¥
   * ã€è¨­å®šç®¡ç†ã€‘: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®æä¾›ã¨å¤–éƒ¨è¨­å®šã®ãƒãƒ¼ã‚¸
   *
   * @param config - JWTæ¤œè¨¼è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   */
  constructor(config: JwtValidationConfig) {
    // ã€è¨­å®šåˆæœŸåŒ–ã€‘: å¤–éƒ¨è¨­å®šã‚’å†…éƒ¨è¨­å®šã¨ã—ã¦ä¿æŒ
    this.config = config;
  }

  /**
   * JWTæ§‹é€ æ¤œè¨¼å®Ÿè£…
   *
   * ã€å‡¦ç†ãƒ•ãƒ­ãƒ¼ã€‘:
   * 1. ç©ºæ–‡å­—ãƒ»nullãƒ»undefined ãƒã‚§ãƒƒã‚¯
   * 2. é•·ã•åˆ¶é™ãƒã‚§ãƒƒã‚¯
   * 3. JWTå½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆHeader.Payload.Signatureæ§‹é€ ï¼‰
   *
   * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®ã€‘: è»½ã„é †ã«ãƒã‚§ãƒƒã‚¯ã—ã¦æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
   * ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€‘: è©³ç´°ãªå¤±æ•—ç†ç”±ã‚’æä¾›ã—ã¦ãƒ‡ãƒãƒƒã‚°ã‚’æ”¯æ´
   *
   * @param jwt - æ¤œè¨¼å¯¾è±¡ã®JWTãƒˆãƒ¼ã‚¯ãƒ³
   * @returns æ¤œè¨¼çµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  validateStructure(jwt: string): JwtValidationResult {
    // ã€ç©ºæ–‡å­—ãƒã‚§ãƒƒã‚¯ã€‘: nullã€undefinedã€ç©ºæ–‡å­—åˆ—ã€ç©ºç™½æ–‡å­—ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
    // ã€æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã€‘: æœ€ã‚‚è»½ã„å‡¦ç†ã‹ã‚‰é–‹å§‹ã—ã¦ç„¡åŠ¹ãªå ´åˆã¯å³åº§ã«çµ‚äº†
    if (!jwt || jwt.trim() === '') {
      return {
        isValid: false,
        errorMessage: 'JWTãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™',
        failureReason: 'EMPTY',
      };
    }

    // ã€é•·ã•åˆ¶é™ãƒã‚§ãƒƒã‚¯ã€‘: è¨­å®šå€¤ã«åŸºã¥ãæœ€å¤§é•·ãƒã‚§ãƒƒã‚¯
    // ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‘: é•·å¤§ãªãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªæ”»æ’ƒã‚„DDoSæ”»æ’ƒã‚’é˜²æ­¢
    // ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: æ­£è¦è¡¨ç¾å‡¦ç†å‰ã«é•·ã•ã§äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if (jwt.length > this.config.maxLength) {
      return {
        isValid: false,
        errorMessage: 'JWTã‚µã‚¤ã‚ºãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™',
        failureReason: 'TOO_LONG',
      };
    }

    // ã€JWTå½¢å¼ãƒã‚§ãƒƒã‚¯ã€‘: Header.Payload.Signature ã®3éƒ¨æ§‹æˆã‚’ãƒã‚§ãƒƒã‚¯
    // ã€æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘: Base64URLæ–‡å­—ã®çµ„ã¿åˆã‚ã›ã‚’ãƒ‰ãƒƒãƒˆåŒºåˆ‡ã‚Šã§æ¤œè¨¼
    // ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã€‘: æš—å·å­¦çš„æ¤œè¨¼å‰ã®é«˜é€Ÿãªæ§‹é€ ãƒã‚§ãƒƒã‚¯
    const jwtStructurePattern =
      /^[a-zA-Z0-9\-_]+\.[a-zA-Z0-9\-_]+\.([a-zA-Z0-9\-_]+)?$/;

    if (!jwtStructurePattern.test(jwt)) {
      return {
        isValid: false,
        errorMessage: 'JWTã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“',
        failureReason: 'INVALID_FORMAT',
      };
    }

    // ã€æ¤œè¨¼æˆåŠŸã€‘: ã™ã¹ã¦ã®æ§‹é€ ãƒã‚§ãƒƒã‚¯ã‚’é€šé
    return {
      isValid: true,
    };
  }

  /**
   * JWTéƒ¨åˆ†åˆ¥å–å¾—ï¼ˆæ‹¡å¼µæ©Ÿèƒ½ï¼‰
   *
   * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: JWTã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã€ç½²åã«åˆ†å‰²
   * ã€ç”¨é€”ã€‘: ãƒ‡ãƒãƒƒã‚°ã‚„ãƒ­ã‚°å‡ºåŠ›ã§ã®è©³ç´°æƒ…å ±æä¾›
   * ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‘: ç½²åéƒ¨åˆ†ã¯å«ã‚ãšã«å®‰å…¨ã«æƒ…å ±ã‚’æŠ½å‡º
   *
   * @param jwt - åˆ†å‰²å¯¾è±¡ã®JWTãƒˆãƒ¼ã‚¯ãƒ³
   * @returns JWTå„éƒ¨åˆ†ã®é…åˆ—ï¼ˆç„¡åŠ¹ãªå ´åˆã¯nullï¼‰
   */
  splitJwtParts(
    jwt: string,
  ): { header: string; payload: string; signature: string } | null {
    // ã€äº‹å‰æ¤œè¨¼ã€‘: æ§‹é€ æ¤œè¨¼ã‚’å…ˆã«å®Ÿè¡Œ
    const validationResult = this.validateStructure(jwt);
    if (!validationResult.isValid) {
      return null;
    }

    // ã€å®‰å…¨ãªåˆ†å‰²ã€‘: æ§‹é€ æ¤œè¨¼æ¸ˆã¿ã®JWTã‚’åˆ†å‰²
    const parts = jwt.split('.');

    return {
      header: parts[0] || '',
      payload: parts[1] || '',
      signature: parts[2] || '', // ç½²åãŒãªã„å ´åˆã‚‚å¯¾å¿œ
    };
  }
}

/**
 * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆJWTæ¤œè¨¼è¨­å®š
 *
 * ã€è¨­å®šå€¤ã€‘: ä¸€èˆ¬çš„ãªJWTãƒˆãƒ¼ã‚¯ãƒ³ã‚µã‚¤ã‚ºã‚’è€ƒæ…®ã—ãŸé©åˆ‡ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
 * ã€æ ¹æ‹ ã€‘: RFC 7519 + å®Ÿé‹ç”¨ã§ã®çµŒé¨“å€¤ã«åŸºã¥ãè¨­å®š
 */
export const DEFAULT_JWT_VALIDATION_CONFIG: JwtValidationConfig = {
  // ã€æœ€å¤§é•·è¨­å®šã€‘: ä¸€èˆ¬çš„ãªJWTã‚µã‚¤ã‚º + ååˆ†ãªãƒãƒ¼ã‚¸ãƒ³ã‚’è€ƒæ…®
  // ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ©ãƒ³ã‚¹ã€‘: æ­£å¸¸ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨±å¯ã—ã¤ã¤æ”»æ’ƒã‚’é˜²æ­¢
  maxLength: 2048,
};
