import { test, expect } from '@playwright/test';
import { 
  cleanupTestState 
} from './helpers/test-setup';

test.describe('T008: Google OAuthèªè¨¼å¤±æ•—ã‚¨ãƒ©ãƒ¼è¡¨ç¤º E2Eãƒ†ã‚¹ãƒˆ', () => {
  test.afterEach(async ({ page }) => {
    // ã€ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†ã€‘: å„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
    // ã€çŠ¶æ…‹å¾©å…ƒã€‘: æ¬¡ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã€ã‚·ã‚¹ãƒ†ãƒ ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
    await cleanupTestState(page);
  });

  test('Google OAuthèªè¨¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º', async ({ page }) => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒGoogle OAuthèªè¨¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’é¸æŠã—ãŸéš›ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: èªè¨¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸæ™‚ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã€å†è©¦è¡Œå¯èƒ½ãªçŠ¶æ…‹ãŒç¶­æŒã•ã‚Œã‚‹
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦ã§ã¯ãªãæƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦æ‰±ã„ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ç•™ã¾ã£ã¦å†è©¦è¡Œå¯èƒ½ãªçŠ¶æ…‹ã«ã™ã‚‹
    // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: OAuthæ¨™æº–ãƒ•ãƒ­ãƒ¼ã¨ã—ã¦å¦¥å½“ãªæ¨æ¸¬ãƒ™ãƒ¼ã‚¹

    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’åé›†ã—ã¦ãƒ‡ãƒãƒƒã‚°ã«æ´»ç”¨
    page.on('console', (msg) => {
      if (msg.text().includes('T008-cancel')) {
        console.log('Page Console (OAuth Cancel):', msg.text());
      }
    });

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: Google OAuthèªè¨¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«çŠ¶æ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã®è¨­å®š
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: OAuthèªè¨¼ç”»é¢ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸçŠ¶æ…‹ã‚’æ¨¡æ“¬
    // ã€å‰ææ¡ä»¶ç¢ºèªã€‘: èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‹ã‚‰ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«é€šçŸ¥ãŒæ­£å¸¸ã«å—ä¿¡ã§ãã‚‹çŠ¶æ…‹

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: OAuthèªè¨¼å¤±æ•—ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†
    // ã€å‡¦ç†å†…å®¹ã€‘: Supabase OAuthèªè¨¼ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«çŠ¶æ³ã‚’APIãƒ¢ãƒƒã‚¯ã§å†ç¾
    // ã€å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‘: èªè¨¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç›´å¾Œ

    // Google OAuthèªè¨¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹APIãƒ¢ãƒƒã‚¯
    await page.route('**/auth/v1/authorize**', async (route) => {
      // OAuthèªè¨¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”å´
      await route.fulfill({
        status: 400,
        contentType: 'application/json',
        body: JSON.stringify({
          error: 'access_denied',
          error_description: 'User denied access to the authorization server',
          error_code: 'auth_cancelled',
          provider: 'google'
        }),
      });
    });

    // ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’æ¢ã™
    await page.goto('/');
    await page.waitForLoadState('networkidle');

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®å­˜åœ¨ç¢ºèª
    const loginButton = page.getByRole('button', { name: /ãƒ­ã‚°ã‚¤ãƒ³|login/i });
    await expect(loginButton).toBeVisible({ timeout: 10000 });

    // ã€å®Ÿè¡Œã€‘: ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§OAuthèªè¨¼é–‹å§‹
    await loginButton.click();

    // OAuthèªè¨¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å‡¦ç†ï¼ˆPlaywrightã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å‡¦ç†ï¼‰
    const [popup] = await Promise.all([
      page.waitForEvent('popup'),
      // ã“ã“ã§OAuthèªè¨¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã
    ]);

    // ã€çµæœæ¤œè¨¼ã€‘: ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ãŒé©åˆ‡ã«è¡Œã‚ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å„ªã—ã„UXãŒæä¾›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã§ã¯ãªãæƒ…å ±é€šçŸ¥ã¨ã—ã¦æ‰±ã„ã€å†èªè¨¼ã¸ã®å°ç·šãŒç¢ºä¿ã•ã‚Œã‚‹
    // ã€å“è³ªä¿è¨¼ã€‘: Google OAuth UXã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«æ²¿ã£ãŸé©åˆ‡ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®æä¾›

    // OAuthèªè¨¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¢ºèª
    const cancelMessage = page.getByText('Googleãƒ­ã‚°ã‚¤ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', { exact: false });
    await expect(cancelMessage).toBeVisible({ timeout: 5000 }); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ğŸŸ¢

    // ã‚¨ãƒ©ãƒ¼æ‰±ã„ã§ã¯ãªãæƒ…å ±æ‰±ã„ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼è‰²ã§ã¯ãªãæƒ…å ±è‰²ï¼‰
    const messageContainer = page.locator('[data-testarea="auth-message"]');
    await expect(messageContainer).toHaveClass(/info|success/); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼æ‰±ã„ã§ã¯ãªãæƒ…å ±æ‰±ã„ ğŸŸ¡

    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ç•™ã¾ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page).toHaveURL('/', { timeout: 5000 }); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ç•™ã¾ã‚Šå†è©¦è¡Œã‚’ä¿ƒã™ ğŸŸ¢

    // å†è©¦è¡ŒãŒå¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ãŒã¾ã è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ï¼‰
    const retryLoginButton = page.getByRole('button', { name: /ãƒ­ã‚°ã‚¤ãƒ³|login/i });
    await expect(retryLoginButton).toBeVisible(); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾Œã®å†èªè¨¼ãŒå¯èƒ½ ğŸŸ¢

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
    const errorMessage = page.locator('[data-testarea="error-message"]');
    await expect(errorMessage).not.toBeVisible(); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œãªã„ ğŸŸ¡
  });

  test('Google OAuthæ¥ç¶šã‚¨ãƒ©ãƒ¼æ™‚ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã¨ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½', async ({ page }) => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: Google OAuthã‚µãƒ¼ãƒ“ã‚¹ã¸ã®æ¥ç¶šå¤±æ•—æ™‚ã®å …ç‰¢ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚„ä¸€æ™‚çš„ãªGoogleå´éšœå®³æ™‚ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: æŠ€è¡“çš„ã‚¨ãƒ©ãƒ¼ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›ã—ã€è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã‚’æä¾›
    // ğŸŸ¡ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ä¸€èˆ¬çš„ãªWebã‚¢ãƒ—ãƒªè¦ä»¶ã¨ã—ã¦å¦¥å½“ãªæ¨æ¸¬

    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’åé›†ã—ã¦ãƒ‡ãƒãƒƒã‚°ã«æ´»ç”¨
    page.on('console', (msg) => {
      if (msg.text().includes('T008-connection')) {
        console.log('Page Console (Connection Error):', msg.text());
      }
    });

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: Google OAuthæ¥ç¶šå¤±æ•—æ™‚ã®å…¸å‹çš„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚’æ¨¡æ“¬
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: Google OAuthã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¿œç­”ã—ãªã„ã€ã¾ãŸã¯æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆçŠ¶æ…‹
    // ã€å‰ææ¡ä»¶ç¢ºèªã€‘: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºå¯èƒ½ã§é©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ãã‚‹çŠ¶æ…‹

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: OAuthæ¥ç¶šå¤±æ•—ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†
    // ã€å‡¦ç†å†…å®¹ã€‘: GoogleOAuthProviderã®signInãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè¡Œä¸­ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¾‹å¤–ã‚’é©åˆ‡ã«å‡¦ç†
    // ã€å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‘: Google OAuthã‚µãƒ¼ãƒ“ã‚¹ã¸ã®åˆå›æ¥ç¶šè©¦è¡Œã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒç™ºç”Ÿã—ãŸæ™‚ç‚¹

    // Google OAuthæ¥ç¶šã‚¨ãƒ©ãƒ¼ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹APIãƒ¢ãƒƒã‚¯
    await page.route('**/auth/v1/authorize**', async (route) => {
      // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šå¤±æ•—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      await route.abort('failed');
    });

    // ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’æ¢ã™
    await page.goto('/');
    await page.waitForLoadState('networkidle');

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®å­˜åœ¨ç¢ºèª
    const loginButton = page.getByRole('button', { name: /ãƒ­ã‚°ã‚¤ãƒ³|login/i });
    await expect(loginButton).toBeVisible({ timeout: 10000 });

    // ã€å®Ÿè¡Œã€‘: ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§OAuthèªè¨¼é–‹å§‹ï¼ˆæ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿï¼‰
    await loginButton.click();

    // ã€çµæœæ¤œè¨¼ã€‘: æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ˜ç¢ºãªçŠ¶æ³èª¬æ˜ã¨è§£æ±ºç­–ãŒæç¤ºã•ã‚Œã‚‹
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: æŠ€è¡“çš„è©³ç´°ã‚’éš ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã€ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã‚’æä¾›
    // ã€å“è³ªä¿è¨¼ã€‘: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸å®‰å®šãªç’°å¢ƒã§ã‚‚å®‰å®šã—ãŸèªè¨¼UXã‚’æä¾›

    // æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¢ºèª
    const connectionErrorMessage = page.getByText('Googleã¨ã®æ¥ç¶šã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ', { exact: false });
    await expect(connectionErrorMessage).toBeVisible({ timeout: 10000 }); // ã€ç¢ºèªå†…å®¹ã€‘: å…·ä½“çš„ã§å®Ÿç”¨çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ğŸŸ¡

    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šç¢ºèªã®ä¿ƒé€²ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const networkCheckMessage = page.getByText('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„', { exact: false });
    await expect(networkCheckMessage).toBeVisible({ timeout: 5000 }); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼é€šçŸ¥ ğŸŸ¢

    // å†è©¦è¡Œãƒœã‚¿ãƒ³ã®è¡¨ç¤ºç¢ºèª
    const retryButton = page.getByRole('button', { name: /å†è©¦è¡Œ|retry|ã‚‚ã†ä¸€åº¦/i });
    await expect(retryButton).toBeVisible({ timeout: 5000 }); // ã€ç¢ºèªå†…å®¹ã€‘: æ¥ç¶šã‚¨ãƒ©ãƒ¼å¾Œã®å†è©¦è¡ŒãŒå¯èƒ½ ğŸŸ¡

    // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã¨ã—ã¦é©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼è‰²ï¼‰
    const errorContainer = page.locator('[data-testarea="auth-error"]');
    await expect(errorContainer).toHaveClass(/error|danger/); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼é€šçŸ¥ ğŸŸ¡

    // ã€ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã€‘: å†è©¦è¡Œãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ©Ÿèƒ½ç¢ºèª
    // ã€å‡¦ç†å†…å®¹ã€‘: å†è©¦è¡Œãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§å†æ¥ç¶šã‚’è©¦è¡Œ
    if (await retryButton.isVisible()) {
      await retryButton.click();

      // å†è©¦è¡Œå®Ÿè¡Œä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ç¢ºèª
      const loadingIndicator = page.locator('[data-testarea="auth-loading"]');
      await expect(loadingIndicator).toBeVisible({ timeout: 2000 }); // ã€ç¢ºèªå†…å®¹ã€‘: å†è©¦è¡Œä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º ğŸŸ¡
    }
  });

  test('Google OAuthè¨­å®šã‚¨ãƒ©ãƒ¼æ™‚ã®é–‹ç™ºè€…å‘ã‘ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', async ({ page }) => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: Google OAuthè¨­å®šä¸å‚™ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDæœªè¨­å®šç­‰ï¼‰ã®é©åˆ‡ãªæ¤œå‡ºã¨é€šçŸ¥
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: é–‹ç™ºç’°å¢ƒã§ã®è¨­å®šä¸å‚™ã‚’æ—©æœŸæ¤œå‡ºã—ã€é–‹ç™ºè€…ã«å…·ä½“çš„ãªä¿®æ­£ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’æä¾›
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: è¨­å®šã‚¨ãƒ©ãƒ¼ã‚’æ˜ç¢ºã«è­˜åˆ¥ã—ã€ä¿®æ­£æ–¹æ³•ã‚’å«ã‚€è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    // ğŸ”´ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ã‚¿ã‚¹ã‚¯ä»•æ§˜ã«ãªã„æ¨æ¸¬ãƒ™ãƒ¼ã‚¹ã€ã—ã‹ã—é–‹ç™ºå“è³ªå‘ä¸Šã«é‡è¦

    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’åé›†ã—ã¦ãƒ‡ãƒãƒƒã‚°ã«æ´»ç”¨
    page.on('console', (msg) => {
      if (msg.text().includes('T008-config')) {
        console.log('Page Console (Config Error):', msg.text());
      }
    });

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: Google OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šã®ä¸å‚™ã‚’æ¨¡æ“¬ï¼ˆç’°å¢ƒå¤‰æ•°æœªè¨­å®šãªã©ï¼‰
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: å¿…é ˆã®OAuthè¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã¾ãŸã¯ç„¡åŠ¹ãªçŠ¶æ…‹
    // ã€å‰ææ¡ä»¶ç¢ºèªã€‘: è¨­å®šæ¤œè¨¼æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã€è¨­å®šä¸å‚™ã‚’æ¤œå‡ºã§ãã‚‹çŠ¶æ…‹

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: OAuthè¨­å®šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§è¨­å®šä¸å‚™ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†
    // ã€å‡¦ç†å†…å®¹ã€‘: GoogleOAuthProviderã®åˆæœŸåŒ–æ™‚ã¾ãŸã¯signInå®Ÿè¡Œæ™‚ã®è¨­å®šæ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†
    // ã€å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‘: OAuthèªè¨¼åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹ã§è¨­å®šã®æ¤œè¨¼ãŒå®Ÿè¡Œã•ã‚ŒãŸæ™‚ç‚¹

    // Google OAuthè¨­å®šã‚¨ãƒ©ãƒ¼ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹APIãƒ¢ãƒƒã‚¯
    await page.route('**/auth/v1/authorize**', async (route) => {
      // OAuthè¨­å®šã‚¨ãƒ©ãƒ¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”å´
      await route.fulfill({
        status: 400,
        contentType: 'application/json',
        body: JSON.stringify({
          error: 'invalid_client',
          error_description: 'Google OAuth client configuration is invalid or missing',
          error_code: 'oauth_config_error',
          details: {
            missingParams: ['NEXT_PUBLIC_GOOGLE_CLIENT_ID'],
            invalidParams: ['NEXT_PUBLIC_SITE_URL']
          }
        }),
      });
    });

    // ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’æ¢ã™
    await page.goto('/');
    await page.waitForLoadState('networkidle');

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®å­˜åœ¨ç¢ºèª
    const loginButton = page.getByRole('button', { name: /ãƒ­ã‚°ã‚¤ãƒ³|login/i });
    await expect(loginButton).toBeVisible({ timeout: 10000 });

    // ã€å®Ÿè¡Œã€‘: ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§OAuthèªè¨¼é–‹å§‹ï¼ˆè¨­å®šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿï¼‰
    await loginButton.click();

    // ã€çµæœæ¤œè¨¼ã€‘: è¨­å®šã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«æ¤œå‡ºã•ã‚Œã€é–‹ç™ºè€…ã«å…·ä½“çš„ãªä¿®æ­£æŒ‡ç¤ºãŒæä¾›ã•ã‚Œã‚‹
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: è¨­å®šå•é¡Œã®è©³ç´°ã¨ä¿®æ­£æ‰‹é †ã‚’å«ã‚€é–‹ç™ºè€…å‘ã‘ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç”Ÿæˆã•ã‚Œã‚‹
    // ã€å“è³ªä¿è¨¼ã€‘: é–‹ç™ºåŠ¹ç‡å‘ä¸Šã¨æœ¬ç•ªç’°å¢ƒã§ã®è¨­å®šãƒŸã‚¹é˜²æ­¢ã«è²¢çŒ®

    // è¨­å®šã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¢ºèª
    const configErrorMessage = page.getByText('Google OAuthè¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™', { exact: false });
    await expect(configErrorMessage).toBeVisible({ timeout: 10000 }); // ã€ç¢ºèªå†…å®¹ã€‘: è¨­å®šå•é¡Œã®æ˜ç¢ºãªé€šçŸ¥ ğŸ”´

    // é–‹ç™ºè€…å‘ã‘è¨­å®šã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã®ç¢ºèªï¼ˆé–‹ç™ºç’°å¢ƒã§ã®ã¿è¡¨ç¤ºï¼‰
    const devInfo = page.locator('[data-testarea="development-info"]');
    if (process.env.NODE_ENV === 'development') {
      await expect(devInfo).toBeVisible(); // ã€ç¢ºèªå†…å®¹ã€‘: é–‹ç™ºç’°å¢ƒã§ã®è©³ç´°ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹è¡¨ç¤º ğŸ”´
      
      // .env.localè¨­å®šã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
      const envGuideText = page.getByText('.env.local', { exact: false });
      await expect(envGuideText).toBeVisible(); // ã€ç¢ºèªå†…å®¹ã€‘: å…·ä½“çš„ãªè¨­å®šä¿®æ­£ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ ğŸ”´

      // ä¸è¶³è¨­å®šã®å…·ä½“çš„ãªæŒ‡æ‘˜
      const missingVarText = page.getByText('NEXT_PUBLIC_GOOGLE_CLIENT_ID', { exact: false });
      await expect(missingVarText).toBeVisible(); // ã€ç¢ºèªå†…å®¹ã€‘: ä¸è¶³è¨­å®šã®å…·ä½“çš„ãªæŒ‡æ‘˜ ğŸ”´
    }

    // è¨­å®šä¿®æ­£ã¾ã§ã¯ãƒªãƒˆãƒ©ã‚¤ã§ããªã„ã“ã¨ã‚’ç¢ºèª
    const retryButton = page.getByRole('button', { name: /å†è©¦è¡Œ|retry/i });
    await expect(retryButton).not.toBeVisible(); // ã€ç¢ºèªå†…å®¹ã€‘: è¨­å®šä¿®æ­£ã¾ã§ã¯ãƒªãƒˆãƒ©ã‚¤ä¸å¯ ğŸŸ¡

    // è¨­å®šã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã¨ã—ã¦é©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    const configErrorContainer = page.locator('[data-testarea="config-error"]');
    await expect(configErrorContainer).toHaveClass(/error|warning/); // ã€ç¢ºèªå†…å®¹ã€‘: è¨­å®šã‚¨ãƒ©ãƒ¼ã¨ã—ã¦é©åˆ‡ã«åˆ†é¡ ğŸ”´
  });
});