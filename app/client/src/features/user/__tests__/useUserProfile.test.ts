import { afterEach, beforeEach, describe, expect, test, mock } from 'bun:test';
import { renderHook, waitFor } from '@testing-library/react';
import type { User } from '@/packages/shared-schemas/src/auth';

// ã€æ”¹å–„å†…å®¹ã€‘: ãƒ†ã‚¹ãƒˆåˆ†é›¢ã®ãŸã‚å›ºæœ‰ã®ãƒ¢ãƒƒã‚¯ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä½œæˆ
// ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: useUserProfileãƒ•ãƒƒã‚¯å°‚ç”¨ã®ãƒ¢ãƒƒã‚¯ç’°å¢ƒã‚’æ§‹ç¯‰
// ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ãƒ†ã‚¹ãƒˆåˆ†æçµæœã«åŸºã¥ãç¢ºå®Ÿãªä¿®æ­£
const mockGetUserProfile = mock().mockName('useUserProfile-getUserProfile');

// ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¢ãƒƒã‚¯æ”¹å–„ã€‘: å›ºæœ‰ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¢ãƒƒã‚¯IDã§åˆ†é›¢
// ã€å®‰å®šæ€§ç¢ºä¿ã€‘: ä»–ã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã®å¹²æ¸‰ã‚’å®Œå…¨ã«æ’é™¤
mock.module('../services/userService', () => ({
  userService: {
    getUserProfile: mockGetUserProfile,
  }
}));

// ã€å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€‘: ãƒ¢ãƒƒã‚¯è¨­å®šå¾Œã«ãƒ•ãƒƒã‚¯ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãƒ¢ãƒƒã‚¯é©ç”¨ã‚’ç¢ºå®Ÿã«ã™ã‚‹
// ã€ãƒ†ã‚¹ãƒˆç’°å¢ƒæœ€é©åŒ–ã€‘: ãƒ¢ãƒƒã‚¯ç«¶åˆã‚’é¿ã‘ã‚‹ãŸã‚ã®é…å»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const { useUserProfile } = await import('../hooks/useUserProfile');

describe('useUserProfile ãƒ•ãƒƒã‚¯', () => {
  beforeEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: ãƒ•ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ãƒªã‚»ãƒƒãƒˆ
    // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: ãƒ¢ãƒƒã‚¯é–¢æ•°ã®å®Œå…¨ãªãƒªã‚»ãƒƒãƒˆ
    // ã€æ”¹å–„ç‚¹ã€‘: mockClearã¨mockResetã®ä¸¡æ–¹ã‚’å®Ÿè¡Œã—ã¦ãƒ¢ãƒƒã‚¯çŠ¶æ…‹ã‚’å®Œå…¨ã«åˆæœŸåŒ–
    mockGetUserProfile.mockClear();
    mockGetUserProfile.mockReset();
  });

  afterEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†ã€‘: éåŒæœŸå‡¦ç†ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    // ã€çŠ¶æ…‹å¾©å…ƒã€‘: æ¬¡ãƒ†ã‚¹ãƒˆã¸ã®å‰¯ä½œç”¨ã‚’é˜²æ­¢
    // ã€å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã€‘: ãƒ¢ãƒƒã‚¯å®Ÿè£…ã®å¾©å…ƒ
    mockGetUserProfile.mockRestore();
  });

  test('åˆæœŸçŠ¶æ…‹ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã«ãªã‚‹', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒ•ãƒƒã‚¯åˆæœŸåŒ–æ™‚ã®çŠ¶æ…‹ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: useUserProfileå‘¼ã³å‡ºã—ç›´å¾Œã®loadingçŠ¶æ…‹æ¤œè¨¼
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: åˆæœŸçŠ¶æ…‹ã§loading: trueã€ãƒ‡ãƒ¼ã‚¿ãªã—ã€ã‚¨ãƒ©ãƒ¼ãªã—
    // ã€æ”¹å–„å†…å®¹ã€‘: éåŒæœŸåˆæœŸåŒ–å‡¦ç†ã‚’è€ƒæ…®ã—ãŸãƒ†ã‚¹ãƒˆè¨­è¨ˆ
    // ğŸŸ¢ ãƒ†ã‚¹ãƒˆåˆ†æçµæœã«åŸºã¥ãç¢ºå®Ÿãªä¿®æ­£

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: APIã‚³ãƒ¼ãƒ«å‰ã®åˆæœŸçŠ¶æ…‹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: æ°¸ç¶šçš„ã«pendingçŠ¶æ…‹ã‚’ç¶­æŒã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’ç¢ºèª
    // ã€æ”¹å–„ç‚¹ã€‘: ã‚ˆã‚Šç¢ºå®ŸãªPending Promiseä½œæˆ
    mockGetUserProfile.mockImplementation(() => new Promise(() => {})); // æ°¸ç¶šçš„ã«pending

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: useUserProfileãƒ•ãƒƒã‚¯ã®åˆæœŸåŒ–
    // ã€å‡¦ç†å†…å®¹ã€‘: ãƒ•ãƒƒã‚¯å‘¼ã³å‡ºã—ã¨APIé€šä¿¡é–‹å§‹
    const { result } = renderHook(() => useUserProfile());

    // ã€éåŒæœŸå‡¦ç†å¾…æ©Ÿã€‘: useEffectå†…ã§ã®åˆæœŸåŒ–å‡¦ç†ãŒé–‹å§‹ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    // ã€æ”¹å–„å†…å®¹ã€‘: åˆæœŸçŠ¶æ…‹ã®ç¢ºèªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æœ€é©åŒ–
    await waitFor(() => {
      expect(result.current.loading).toBe(true); // ã€ç¢ºèªå†…å®¹ã€‘: åˆæœŸçŠ¶æ…‹ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã§ã‚ã‚‹ã“ã¨ ğŸŸ¢
    });
    
    expect(result.current.user).toBe(null); // ã€ç¢ºèªå†…å®¹ã€‘: åˆæœŸçŠ¶æ…‹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒnullã§ã‚ã‚‹ã“ã¨ ğŸŸ¢
    expect(result.current.error).toBe(null); // ã€ç¢ºèªå†…å®¹ã€‘: åˆæœŸçŠ¶æ…‹ã§ã‚¨ãƒ©ãƒ¼ãŒnullã§ã‚ã‚‹ã“ã¨ ğŸŸ¢
    expect(typeof result.current.refetch).toBe('function'); // ã€ç¢ºèªå†…å®¹ã€‘: refetché–¢æ•°ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ ğŸŸ¢
  });

  test('APIæˆåŠŸæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸å–å¾—', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: æ­£å¸¸ç³»ã®APIé€šä¿¡ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: userService.getUserProfileæˆåŠŸæ™‚ã®çŠ¶æ…‹é·ç§»
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: loadingçµ‚äº†ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿è¨­å®šã€ã‚¨ãƒ©ãƒ¼ã‚¯ãƒªã‚¢
    // ğŸŸ¢ æ—¢å­˜APIå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ãé«˜ä¿¡é ¼æ€§

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æ­£å¸¸ãªAPI ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: å®Œå…¨ãªUserå‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã®æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
    const mockUser: User = {
      id: '550e8400-e29b-41d4-a716-446655440000',
      externalId: 'google_123456789',
      provider: 'google' as const,
      email: 'user@example.com',
      name: 'å±±ç”°å¤ªéƒ',
      avatarUrl: 'https://example.com/avatar.jpg',
      createdAt: '2025-08-29T10:30:00.000Z',
      updatedAt: '2025-08-29T10:30:00.000Z',
      lastLoginAt: '2025-09-01T10:30:00.000Z'
    };

    // ã€æ”¹å–„ç‚¹ã€‘: ãƒ¢ãƒƒã‚¯åã‚’çµ±ä¸€ã—ã€ç¢ºå®Ÿãªãƒ¬ã‚¹ãƒãƒ³ã‚¹è¨­å®š
    mockGetUserProfile.mockResolvedValue(mockUser);

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: useUserProfileãƒ•ãƒƒã‚¯ã®æˆåŠŸã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: APIæˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†ã®ç¢ºèª
    const { result } = renderHook(() => useUserProfile());

    // ã€çµæœæ¤œè¨¼ã€‘: APIæˆåŠŸæ™‚ã®çŠ¶æ…‹é·ç§»ç¢ºèª
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: æ­£å¸¸ãªãƒ‡ãƒ¼ã‚¿å–å¾—ã¨çŠ¶æ…‹æ›´æ–°
    await waitFor(() => {
      expect(result.current.loading).toBe(false); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®çµ‚äº†ç¢ºèª ğŸŸ¢
    });

    expect(result.current.user).toEqual(mockUser); // ã€ç¢ºèªå†…å®¹ã€‘: å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒæ­£ç¢ºã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ ğŸŸ¢
    expect(result.current.error).toBe(null); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ã“ã¨ ğŸŸ¢
    expect(mockGetUserProfile).toHaveBeenCalledTimes(1); // ã€ç¢ºèªå†…å®¹ã€‘: userServiceãŒ1å›å‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ ğŸŸ¢
  });

  test('APIå¤±æ•—æ™‚ã«ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’æ­£å¸¸è¨­å®š', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®é©åˆ‡æ€§ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: userService.getUserProfileå¤±æ•—æ™‚ã®çŠ¶æ…‹é·ç§»
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: loadingçµ‚äº†ã€ã‚¨ãƒ©ãƒ¼æƒ…å ±è¨­å®šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
    // ğŸŸ¡ ä¸€èˆ¬çš„ãªAPI ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ã®å¦¥å½“ãªæ¨æ¸¬

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: API ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ï¼ˆ500ï¼‰ç™ºç”Ÿæ™‚ã®çŠ¶æ…‹
    const mockError = new Error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    // ã€æ”¹å–„ç‚¹ã€‘: ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒƒã‚¯è¨­å®šã‚’çµ±ä¸€ã—ã€ç¢ºå®Ÿãªã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    mockGetUserProfile.mockRejectedValue(mockError);

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: useUserProfileãƒ•ãƒƒã‚¯ã®ã‚¨ãƒ©ãƒ¼ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: API ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†ã®ç¢ºèª
    const { result } = renderHook(() => useUserProfile());

    // ã€çµæœæ¤œè¨¼ã€‘: API ã‚¨ãƒ©ãƒ¼æ™‚ã®çŠ¶æ…‹é·ç§»ç¢ºèª
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨çŠ¶æ…‹æ›´æ–°
    await waitFor(() => {
      expect(result.current.loading).toBe(false); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®çµ‚äº†ç¢ºèª ğŸŸ¡
    });

    expect(result.current.user).toBe(null); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒnullã§ã‚ã‚‹ã“ã¨ ğŸŸ¡
    expect(result.current.error).toEqual(mockError); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼æƒ…å ±ãŒæ­£ç¢ºã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ ğŸŸ¡
    expect(mockGetUserProfile).toHaveBeenCalledTimes(1); // ã€ç¢ºèªå†…å®¹ã€‘: userServiceãŒ1å›å‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ ğŸŸ¡
  });

  test('refetché–¢æ•°ã«ã‚ˆã‚‹å†å–å¾—æ©Ÿèƒ½', async () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: refetché–¢æ•°å‘¼ã³å‡ºã—æ™‚ã®APIå†å®Ÿè¡Œ
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: æ‰‹å‹•ã§ã®ãƒ‡ãƒ¼ã‚¿å†å–å¾—ã¨ã‚¨ãƒ©ãƒ¼å›å¾©
    // ğŸŸ¡ ä¸€èˆ¬çš„ãªãƒªãƒˆãƒ©ã‚¤ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ã®å¦¥å½“ãªæ¨æ¸¬

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: åˆå›å¤±æ•—ã€å†è©¦è¡ŒæˆåŠŸã®ã‚·ãƒŠãƒªã‚ª
    // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: æœ€åˆã¯ã‚¨ãƒ©ãƒ¼ã€refetchå¾Œã¯æˆåŠŸãƒ‡ãƒ¼ã‚¿
    const mockUser: User = {
      id: '550e8400-e29b-41d4-a716-446655440000',
      externalId: 'google_123456789',
      provider: 'google' as const,
      email: 'user@example.com',
      name: 'å±±ç”°å¤ªéƒ',
      avatarUrl: 'https://example.com/avatar.jpg',
      createdAt: '2025-08-29T10:30:00.000Z',
      updatedAt: '2025-08-29T10:30:00.000Z',
      lastLoginAt: '2025-09-01T10:30:00.000Z'
    };

    // ã€æ”¹å–„ç‚¹ã€‘: ã‚ˆã‚Šç¢ºå®Ÿãªrefetchãƒ†ã‚¹ãƒˆã®ãŸã‚ã®æ®µéšçš„ãƒ¢ãƒƒã‚¯è¨­å®š
    // åˆå›ã¯å¿…ãšã‚¨ãƒ©ãƒ¼ã€2å›ç›®ä»¥é™ã¯æˆåŠŸãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ã‚ˆã†è¨­å®š
    mockGetUserProfile.mockRejectedValueOnce(new Error('Network Error'));

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: useUserProfileãƒ•ãƒƒã‚¯ã®refetchæ©Ÿèƒ½å®Ÿè¡Œ
    // ã€å‡¦ç†å†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿå¾Œã®å†è©¦è¡Œå‡¦ç†ç¢ºèª
    const { result } = renderHook(() => useUserProfile());

    // åˆå›ã‚¨ãƒ©ãƒ¼ç¢ºèª
    await waitFor(() => {
      expect(result.current.error).toBeTruthy(); // ã€ç¢ºèªå†…å®¹ã€‘: åˆå›APIå‘¼ã³å‡ºã—ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç¢ºèª ğŸŸ¡
    });
    
    // refetchç”¨ã®ãƒ¢ãƒƒã‚¯æˆåŠŸè¨­å®šã‚’è¿½åŠ 
    mockGetUserProfile.mockResolvedValueOnce(mockUser);

    // refetchå®Ÿè¡Œ
    await result.current.refetch();

    // ã€çµæœæ¤œè¨¼ã€‘: refetchå¾Œã®çŠ¶æ…‹å›å¾©ç¢ºèª
    // ã€æœŸå¾…å€¤ç¢ºèªã€‘: å†è©¦è¡Œã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼å›å¾©ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—
    await waitFor(() => {
      expect(result.current.loading).toBe(false); // ã€ç¢ºèªå†…å®¹ã€‘: refetchå®Œäº†å¾Œã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº† ğŸŸ¡
    });

    expect(result.current.user).toEqual(mockUser); // ã€ç¢ºèªå†…å®¹ã€‘: refetchæˆåŠŸã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¨­å®šã•ã‚Œã‚‹ã“ã¨ ğŸŸ¡
    expect(result.current.error).toBe(null); // ã€ç¢ºèªå†…å®¹ã€‘: refetchæˆåŠŸã§ã‚¨ãƒ©ãƒ¼ãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ã“ã¨ ğŸŸ¡
    expect(mockGetUserProfile).toHaveBeenCalledTimes(2); // ã€ç¢ºèªå†…å®¹ã€‘: userServiceãŒ2å›ï¼ˆåˆå›+refetchï¼‰å‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ ğŸŸ¡
  });
});