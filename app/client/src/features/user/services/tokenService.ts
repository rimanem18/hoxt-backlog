/**
 * TASK-302: ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰
 * ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ç›®çš„ã€‘: localStorageç›´æŽ¥ã‚¢ã‚¯ã‚»ã‚¹ã®ä¾å­˜æ€§é€†è»¢åŽŸå‰‡ï¼ˆDIPï¼‰æ”¹å–„
 * ã€è¨­è¨ˆæ”¹å–„ã€‘: ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã®æŠ½è±¡åŒ–ã«ã‚ˆã‚‹ç–Žçµåˆã¨ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§å‘ä¸Š
 * ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šã€‘: ãƒˆãƒ¼ã‚¯ãƒ³æ“ä½œã®é›†ä¸­ç®¡ç†ã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
 * ðŸŸ¢ å“è³ªå‘ä¸Š: SOLIDåŽŸå‰‡ã®å®Œå…¨æº–æ‹ 
 */

/**
 * ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©ã€‘: ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã®æŠ½è±¡åŒ–ã«ã‚ˆã‚‹ä¾å­˜æ€§é€†è»¢
 * ã€è¨­è¨ˆæ„å›³ã€‘: å…·è±¡ï¼ˆlocalStorageï¼‰ã§ã¯ãªãæŠ½è±¡ï¼ˆinterfaceï¼‰ã«ä¾å­˜
 * ã€æ‹¡å¼µæ€§ã€‘: å°†æ¥çš„ãªHttpOnly Cookieãƒ»ã‚»ã‚­ãƒ¥ã‚¢ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ç§»è¡Œã‚’å®¹æ˜“ã«
 */
export interface TokenService {
  /**
   * èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
   * @returns {string | null} JWTèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆæœªå­˜åœ¨æ™‚ã¯nullï¼‰
   */
  getToken(): string | null;

  /**
   * èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
   * @param {string} token - ä¿å­˜ã™ã‚‹JWTãƒˆãƒ¼ã‚¯ãƒ³
   */
  setToken(token: string): void;

  /**
   * èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
   */
  removeToken(): void;

  /**
   * ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼
   * @returns {boolean} ãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã—æœ‰åŠ¹ãªå ´åˆtrue
   */
  isTokenValid(): boolean;
}

/**
 * ã€LocalStorageå®Ÿè£…ã€‘: ç¾åœ¨ã®å®Ÿè£…ã¨ã®äº’æ›æ€§ã‚’ä¿ã¤TokenServiceå®Ÿè£…
 * ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æˆ¦ç•¥ã€‘: æ—¢å­˜ã®å‹•ä½œã‚’ä¿ã¡ãªãŒã‚‰æŠ½è±¡åŒ–ã‚’å°Žå…¥
 * ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®ã€‘: å°†æ¥çš„ãªã‚»ã‚­ãƒ¥ã‚¢å®Ÿè£…ã¸ã®ç§»è¡Œæº–å‚™
 * ðŸŸ¢ æ”¹å–„ç‚¹: ä¾å­˜æ€§ã®æ³¨å…¥ãŒå¯èƒ½ãªè¨­è¨ˆ
 */
class LocalStorageTokenService implements TokenService {
  private readonly TOKEN_KEY = 'authToken';

  /**
   * ã€ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã€‘: localStorageã‹ã‚‰JWTèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®‰å…¨ã«å–å¾—
   * ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€‘: localStorageä¾‹å¤–ã®é©åˆ‡ãªå‡¦ç†
   * ã€æˆ»ã‚Šå€¤ä¿è¨¼ã€‘: å¿…ãšstring | nullã‚’è¿”å´
   */
  getToken(): string | null {
    try {
      return localStorage.getItem(this.TOKEN_KEY);
    } catch (error) {
      // ã€ä¾‹å¤–å‡¦ç†ã€‘: localStorageç„¡åŠ¹æ™‚ã‚„ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°å¯¾å¿œ
      console.warn('ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
      return null;
    }
  }

  /**
   * ã€ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ã€‘: JWTèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã«å®‰å…¨ã«ä¿å­˜
   * ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€‘: ç©ºæ–‡å­—åˆ—ãƒ»ä¸æ­£å€¤ã®äº‹å‰ãƒã‚§ãƒƒã‚¯
   * ã€ä¾‹å¤–å‡¦ç†ã€‘: localStorageåˆ¶é™æ™‚ã®é©åˆ‡ãªå‡¦ç†
   */
  setToken(token: string): void {
    if (!token || typeof token !== 'string') {
      throw new Error('æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™');
    }

    try {
      localStorage.setItem(this.TOKEN_KEY, token);
    } catch (error) {
      // ã€ä¾‹å¤–å‡¦ç†ã€‘: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡åˆ¶é™ãƒ»ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°å¯¾å¿œ
      console.error('ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
      throw new Error('ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  /**
   * ã€ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤ã€‘: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã‹ã‚‰å®‰å…¨ã«å‰Šé™¤
   * ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‘: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã®ç¢ºå®Ÿãªãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤
   * ã€ä¾‹å¤–å‡¦ç†ã€‘: localStorageç„¡åŠ¹æ™‚ã®é©åˆ‡ãªå‡¦ç†
   */
  removeToken(): void {
    try {
      localStorage.removeItem(this.TOKEN_KEY);
    } catch (error) {
      // ã€ä¾‹å¤–å‡¦ç†ã€‘: localStorageä¾‹å¤–æ™‚ã§ã‚‚å‡¦ç†ç¶™ç¶š
      console.warn('ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    }
  }

  /**
   * ã€ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æ€§æ¤œè¨¼ã€‘: ãƒˆãƒ¼ã‚¯ãƒ³ã®å­˜åœ¨ã¨åŸºæœ¬çš„ãªå½¢å¼ãƒã‚§ãƒƒã‚¯
   * ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‘: ä¸æ­£ãªãƒˆãƒ¼ã‚¯ãƒ³ã®æ—©æœŸæ¤œå‡º
   * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã€‘: JWTãƒ‘ãƒ¼ã‚¹ã‚’é¿ã‘ãŸè»½é‡ãªäº‹å‰ãƒã‚§ãƒƒã‚¯
   */
  isTokenValid(): boolean {
    const token = this.getToken();

    if (!token) {
      return false;
    }

    // ã€JWTåŸºæœ¬å½¢å¼ãƒã‚§ãƒƒã‚¯ã€‘: "xxxxxx.xxxxxx.xxxxxx"å½¢å¼ã®ç¢ºèª
    // ã€æ³¨æ„ã€‘: å®Œå…¨ãªç½²åæ¤œè¨¼ã¯è¡Œã‚ãšã€å½¢å¼ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
    const jwtPattern = /^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$/;
    return jwtPattern.test(token);
  }
}

/**
 * ã€ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‘: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§å˜ä¸€ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
 * ã€è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘: ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹å®Ÿè£…åˆ‡ã‚Šæ›¿ãˆå®¹æ˜“æ€§
 * ã€å°†æ¥æ‹¡å¼µã€‘: ç’°å¢ƒã«å¿œã˜ãŸTokenServiceå®Ÿè£…ã®åˆ‡ã‚Šæ›¿ãˆãŒå¯èƒ½
 */
export const tokenService: TokenService = new LocalStorageTokenService();

/**
 * ã€ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼é–¢æ•°ã€‘: ãƒ†ã‚¹ãƒˆç”¨ã¾ãŸã¯ç•°ãªã‚‹å®Ÿè£…ã®TokenServiceä½œæˆ
 * ã€ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã€‘: ä¾å­˜æ€§æ³¨å…¥ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§å‘ä¸Š
 * ã€æ‹¡å¼µæ€§ã€‘: å°†æ¥çš„ãªSecureTokenServiceç­‰ã®åˆ‡ã‚Šæ›¿ãˆã‚’å®¹æ˜“ã«
 */
export const createTokenService = (
  implementation?: TokenService,
): TokenService => {
  return implementation || new LocalStorageTokenService();
};
