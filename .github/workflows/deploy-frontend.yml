name: Deploy Frontend

on:
  workflow_call:
    inputs:
      environment-type:
        description: 'Environment type (production or preview)'
        required: false
        type: string
        default: 'production'
      next-public-api-base-url:
        description: 'Next.js API base URL'
        required: true
        type: string
      next-public-site-url:
        description: 'Next.js site URL'
        required: true
        type: string
      next-public-trusted-domains:
        description: 'Next.js trusted domains'
        required: true
        type: string
      cloudflare-project-name:
        description: 'CloudFlare Pages project name'
        required: false
        type: string
        default: ''
    outputs:
      deployment-url:
        description: 'CloudFlare Pages deployment URL'
        value: ${{ jobs.deploy-frontend.outputs.deployment-url }}

jobs:
  deploy-frontend:
    name: Deploy Frontend Application
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      deployment-url: ${{ steps.deploy.outputs.deployment_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun Workspace
        uses: ./.github/actions/setup-bun-workspace
        with:
          working-directory: './app/client'
          cache-key-suffix: 'frontend'

      - name: Debug Environment Variables
        working-directory: ./app/client
        env:
          INPUT_API_BASE_URL: ${{ inputs.next-public-api-base-url }}
          INPUT_SITE_URL: ${{ inputs.next-public-site-url }}
          INPUT_TRUSTED_DOMAINS: ${{ inputs.next-public-trusted-domains }}
          INPUT_ENV_TYPE: ${{ inputs.environment-type }}
        run: |
          echo "ðŸ” Frontend Environment Variables Debug:"
          echo "Input next-public-api-base-url: $INPUT_API_BASE_URL"
          echo "Input next-public-site-url: $INPUT_SITE_URL"
          echo "Input next-public-trusted-domains: $INPUT_TRUSTED_DOMAINS"
          echo "Environment type: $INPUT_ENV_TYPE"

      - name: Build Frontend Application
        working-directory: ./app/client
        env:
          # ç’°å¢ƒåˆ¥Next.jsè¨­å®š
          NEXT_PUBLIC_API_BASE_URL: ${{ inputs.next-public-api-base-url }}
          NEXT_PUBLIC_SITE_URL: ${{ inputs.next-public-site-url }}
          NEXT_PUBLIC_TRUSTED_DOMAINS: ${{ inputs.next-public-trusted-domains }}
          # Supabaseè¨­å®š
          NEXT_PUBLIC_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          echo "ðŸ” Build-time Environment Variables:"
          echo "NEXT_PUBLIC_API_BASE_URL: $NEXT_PUBLIC_API_BASE_URL"
          echo "NEXT_PUBLIC_SITE_URL: $NEXT_PUBLIC_SITE_URL"
          echo "NEXT_PUBLIC_TRUSTED_DOMAINS: $NEXT_PUBLIC_TRUSTED_DOMAINS"
          echo ""
          echo "ðŸš€ Starting Next.js build..."
          bun run build

      - name: Deploy to CloudFlare Pages
        id: deploy
        working-directory: ./app/client
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_PROJECT_INPUT: ${{ inputs.cloudflare-project-name }}
          DEFAULT_PROJECT_NAME: ${{ vars.PROJECT_NAME }}
          # UTF-8ãƒ­ã‚±ãƒ¼ãƒ«è¨­å®šã§wranglerãŒæ—¥æœ¬èªžã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ­£ã—ãå‡¦ç†
          LANG: C.UTF-8
        run: |
          # ãƒ‡ãƒãƒƒã‚°: ç’°å¢ƒå¤‰æ•°ã®å­˜åœ¨ç¢ºèªï¼ˆå€¤ã¯è¡¨ç¤ºã—ãªã„ï¼‰
          echo "=== ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ ==="
          [ -n "$CLOUDFLARE_API_TOKEN" ] && echo "âœ… CLOUDFLARE_API_TOKEN: è¨­å®šæ¸ˆã¿" || echo "âŒ CLOUDFLARE_API_TOKEN: æœªè¨­å®š"
          [ -n "$CLOUDFLARE_ACCOUNT_ID" ] && echo "âœ… CLOUDFLARE_ACCOUNT_ID: è¨­å®šæ¸ˆã¿" || echo "âŒ CLOUDFLARE_ACCOUNT_ID: æœªè¨­å®š"
          [ -n "$CLOUDFLARE_PROJECT_INPUT" ] && echo "âœ… CLOUDFLARE_PROJECT_INPUT: è¨­å®šæ¸ˆã¿" || echo "âš ï¸ CLOUDFLARE_PROJECT_INPUT: æœªè¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½¿ç”¨ï¼‰"
          [ -n "$DEFAULT_PROJECT_NAME" ] && echo "âœ… DEFAULT_PROJECT_NAME: è¨­å®šæ¸ˆã¿" || echo "âŒ DEFAULT_PROJECT_NAME: æœªè¨­å®š"

          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’æ±ºå®šï¼ˆå…¥åŠ›ãŒãªã„å ´åˆã¯varsã‹ã‚‰å–å¾—ï¼‰
          PROJECT_NAME="${CLOUDFLARE_PROJECT_INPUT:-$DEFAULT_PROJECT_NAME}"
          [ -n "$PROJECT_NAME" ] && echo "âœ… æœ€çµ‚PROJECT_NAME: è¨­å®šæ¸ˆã¿" || { echo "âŒ PROJECT_NAME: æœªè¨­å®š"; exit 1; }

          # outãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª
          echo ""
          echo "=== out ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒã‚§ãƒƒã‚¯ ==="
          if [ -d "out" ]; then
            echo "âœ… out/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå­˜åœ¨"
            ls -la out/ | head -5
          else
            echo "âŒ out/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            ls -la
            exit 1
          fi

          # ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
          echo ""
          echo "=== CloudFlare Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­... ==="
          if ! DEPLOYMENT_OUTPUT=$(npx --yes wrangler@4.61.0 pages deploy out \
            --project-name "$PROJECT_NAME" \
            --branch "${{ github.ref_name == 'main' && 'main' || 'preview' }}" \
            --commit-dirty=true 2>&1); then
            echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
            echo "Output:"
            echo "$DEPLOYMENT_OUTPUT"
            exit 1
          fi

          echo "$DEPLOYMENT_OUTPUT"

          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆURLã‚’æŠ½å‡ºï¼ˆwranglerå‡ºåŠ›ã‹ã‚‰ https:// ã§å§‹ã¾ã‚‹URLã‚’å–å¾—ï¼‰
          DEPLOYMENT_URL=$(echo "$DEPLOYMENT_OUTPUT" | grep -o 'https://[^[:space:]]*' | head -1)

          if [ -n "$DEPLOYMENT_URL" ]; then
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆURL: $DEPLOYMENT_URL"
            echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆURLã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            echo "deployment_url=" >> $GITHUB_OUTPUT
          fi
