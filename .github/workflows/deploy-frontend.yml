name: Deploy Frontend

on:
  workflow_call:
    inputs:
      environment-type:
        description: 'Environment type (production or preview)'
        required: false
        type: string
        default: 'production'
      next-public-api-base-url:
        description: 'Next.js API base URL'
        required: true
        type: string
      next-public-site-url:
        description: 'Next.js site URL'
        required: true
        type: string
      next-public-trusted-domains:
        description: 'Next.js trusted domains'
        required: true
        type: string
      cloudflare-project-name:
        description: 'CloudFlare Pages project name'
        required: false
        type: string
        default: ''
    outputs:
      deployment-url:
        description: 'CloudFlare Pages deployment URL'
        value: ${{ jobs.deploy-frontend.outputs.deployment-url }}

jobs:
  deploy-frontend:
    name: Deploy Frontend Application
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      deployment-url: ${{ steps.deploy.outputs.deployment_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun Workspace
        uses: ./.github/actions/setup-bun-workspace
        with:
          working-directory: './app/client'
          cache-key-suffix: 'frontend'

      - name: Debug Environment Variables
        working-directory: ./app/client
        env:
          INPUT_API_BASE_URL: ${{ inputs.next-public-api-base-url }}
          INPUT_SITE_URL: ${{ inputs.next-public-site-url }}
          INPUT_TRUSTED_DOMAINS: ${{ inputs.next-public-trusted-domains }}
          INPUT_ENV_TYPE: ${{ inputs.environment-type }}
        run: |
          echo "ðŸ” Frontend Environment Variables Debug:"
          echo "Input next-public-api-base-url: $INPUT_API_BASE_URL"
          echo "Input next-public-site-url: $INPUT_SITE_URL"
          echo "Input next-public-trusted-domains: $INPUT_TRUSTED_DOMAINS"
          echo "Environment type: $INPUT_ENV_TYPE"

      - name: Build Frontend Application
        working-directory: ./app/client
        env:
          # ç’°å¢ƒåˆ¥Next.jsè¨­å®š
          NEXT_PUBLIC_API_BASE_URL: ${{ inputs.next-public-api-base-url }}
          NEXT_PUBLIC_SITE_URL: ${{ inputs.next-public-site-url }}
          NEXT_PUBLIC_TRUSTED_DOMAINS: ${{ inputs.next-public-trusted-domains }}
          # Supabaseè¨­å®š
          NEXT_PUBLIC_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          echo "ðŸ” Build-time Environment Variables:"
          echo "NEXT_PUBLIC_API_BASE_URL: $NEXT_PUBLIC_API_BASE_URL"
          echo "NEXT_PUBLIC_SITE_URL: $NEXT_PUBLIC_SITE_URL"
          echo "NEXT_PUBLIC_TRUSTED_DOMAINS: $NEXT_PUBLIC_TRUSTED_DOMAINS"
          echo ""
          echo "ðŸš€ Starting Next.js build..."
          bun run build

      - name: Deploy to CloudFlare Pages
        id: deploy
        working-directory: ./app/client
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          # UTF-8ãƒ­ã‚±ãƒ¼ãƒ«è¨­å®šã§wranglerãŒæ—¥æœ¬èªžã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ­£ã—ãå‡¦ç†
          LANG: C.UTF-8
        run: |
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’æ±ºå®šï¼ˆå…¥åŠ›ãŒãªã„å ´åˆã¯varsã‹ã‚‰å–å¾—ï¼‰
          PROJECT_NAME="${{ inputs.cloudflare-project-name }}"
          if [ -z "$PROJECT_NAME" ]; then
            PROJECT_NAME="${{ vars.PROJECT_NAME }}"
          fi

          echo "CloudFlare Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
          DEPLOYMENT_OUTPUT=$(npx --yes wrangler@latest pages deploy out \
            --project-name "$PROJECT_NAME" \
            --branch "${{ github.ref_name == 'main' && 'main' || 'preview' }}" \
            --commit-dirty=true 2>&1)
          
          echo "$DEPLOYMENT_OUTPUT"
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆURLã‚’æŠ½å‡ºï¼ˆwranglerå‡ºåŠ›ã‹ã‚‰ https:// ã§å§‹ã¾ã‚‹URLã‚’å–å¾—ï¼‰
          DEPLOYMENT_URL=$(echo "$DEPLOYMENT_OUTPUT" | grep -o 'https://[^[:space:]]*' | head -1)
          
          if [ -n "$DEPLOYMENT_URL" ]; then
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆURL: $DEPLOYMENT_URL"
            echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆURLã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            echo "ãƒ‡ãƒãƒƒã‚°ç”¨å‡ºåŠ›:"
            echo "$DEPLOYMENT_OUTPUT"
            echo "deployment_url=" >> $GITHUB_OUTPUT
          fi
