name: Deploy Frontend

on:
  workflow_call:
    inputs:
      environment-type:
        description: 'Environment type (production or preview)'
        required: false
        type: string
        default: 'production'
      next-public-api-base-url:
        description: 'Next.js API base URL'
        required: true
        type: string
      next-public-site-url:
        description: 'Next.js site URL'
        required: true
        type: string
      next-public-trusted-domains:
        description: 'Next.js trusted domains'
        required: true
        type: string
      cloudflare-project-name:
        description: 'CloudFlare Pages project name'
        required: false
        type: string
        default: ''
    outputs:
      deployment-url:
        description: 'CloudFlare Pages deployment URL'
        value: ${{ jobs.deploy-frontend.outputs.deployment-url }}

jobs:
  deploy-frontend:
    name: Deploy Frontend Application
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      deployment-url: ${{ steps.deploy.outputs.deployment_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun Workspace
        uses: ./.github/actions/setup-bun-workspace
        with:
          working-directory: './app/client'
          cache-key-suffix: 'frontend'

      - name: Build Frontend Application
        working-directory: ./app/client
        env:
          # ç’°å¢ƒåˆ¥Next.jsè¨­å®š
          NEXT_PUBLIC_API_BASE_URL: ${{ inputs.next-public-api-base-url }}
          NEXT_PUBLIC_SITE_URL: ${{ inputs.next-public-site-url }}
          NEXT_PUBLIC_TRUSTED_DOMAINS: ${{ inputs.next-public-trusted-domains }}
          # Supabaseè¨­å®š
          NEXT_PUBLIC_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: bun run build

      - name: Deploy to CloudFlare Pages
        id: deploy
        working-directory: ./app/client
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          # UTF-8ãƒ­ã‚±ãƒ¼ãƒ«è¨­å®šã§wranglerãŒæ—¥æœ¬èªžã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ­£ã—ãå‡¦ç†
          LANG: C.UTF-8
        run: |
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’æ±ºå®šï¼ˆå…¥åŠ›ãŒãªã„å ´åˆã¯varsã‹ã‚‰å–å¾—ï¼‰
          PROJECT_NAME="${{ inputs.cloudflare-project-name }}"
          if [ -z "$PROJECT_NAME" ]; then
            PROJECT_NAME="${{ vars.PROJECT_NAME }}"
          fi

          echo "CloudFlare Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
          DEPLOYMENT_OUTPUT=$(npx --yes wrangler@latest pages deploy out \
            --project-name "$PROJECT_NAME" \
            --branch "${{ github.ref_name }}" \
            --commit-message "" \
            --commit-dirty=true \
            --output json 2>&1)

          # ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã‚’è§£æžã—ã¦URLã‚’æŠ½å‡º
          if echo "$DEPLOYMENT_OUTPUT" | grep -q "deployment_url"; then
            DEPLOYMENT_URL=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.deployment_url')
            echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
            echo "âœ… CloudFlare Pages ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
            echo "ðŸ“± ãƒ‡ãƒ—ãƒ­ã‚¤URL: $DEPLOYMENT_URL"
          else
            echo "âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å®Œäº†ã—ã¾ã—ãŸãŒã€URLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "deployment_url=https://$PROJECT_NAME.pages.dev" >> $GITHUB_OUTPUT
          fi