name: Security Scanning

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
  workflow_dispatch:

# Fork PRã‹ã‚‰ã®å®Ÿè¡Œã‚’åˆ¶é™ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼‰
permissions:
  contents: read
  pull-requests: write  # ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚³ãƒ¡ãƒ³ãƒˆç”¨

concurrency:
  group: security-scan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Forkåˆ¶é™ãƒã‚§ãƒƒã‚¯
  fork-check:
    name: Fork Repository Check
    runs-on: ubuntu-latest
    outputs:
      is-fork: ${{ steps.fork.outputs.is-fork }}
      can-scan: ${{ steps.fork.outputs.can-proceed }}
    steps:
      - name: Determine checkout ref for fork safety
        id: checkout_ref
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            IS_FORK="${{ github.event.pull_request.head.repo.full_name != github.repository }}"
            if [ "$IS_FORK" = "true" ]; then
              # Fork PR: main ãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ç”¨ï¼ˆæ”¹ã–ã‚“å¯¾ç­–ï¼‰
              echo "ref=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
              echo "ğŸ“Œ Fork PR detected: using base branch for security"
            else
              # åŒä¸€ãƒªãƒã‚¸ãƒˆãƒª PR: ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã‚’ä½¿ç”¨ï¼ˆå®Ÿéš›ã®PRæŒ™å‹•ã‚’å†ç¾ï¼‰
              echo "ref=${{ github.sha }}" >> $GITHUB_OUTPUT
              echo "ğŸ“Œ Same-repo PR: using merge commit"
            fi
          else
            # push/workflow_dispatch: ç¾åœ¨ã®ã‚³ãƒŸãƒƒãƒˆï¼ˆå®Ÿéš›ã®ãƒãƒ¼ã‚¸æŒ™å‹•ã‚’å†ç¾ï¼‰
            echo "ref=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ Non-PR event: using current commit"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.checkout_ref.outputs.ref }}
          persist-credentials: false

      - name: Check Fork Status
        id: fork
        uses: ./.github/actions/fork-check

  # TruffleHog Secret Scanning
  trufflehog:
    name: TruffleHog Secret Scan
    needs: fork-check
    if: needs.fork-check.outputs.can-scan == 'true'
    runs-on: ubuntu-latest
    outputs:
      severity: ${{ steps.scan.outputs.severity }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Gitå±¥æ­´å…¨ã‚¹ã‚­ãƒ£ãƒ³ã®ãŸã‚å…¨å±¥æ­´å–å¾—

      - name: Run TruffleHog Scan
        id: scan
        uses: ./.github/actions/trufflehog-scan
        with:
          base-branch: ${{ github.event.repository.default_branch }}

      - name: Check Critical Findings
        if: steps.scan.outputs.severity == 'critical'
        run: |
          echo "âŒ Critical: æ¤œè¨¼æ¸ˆã¿ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          exit 1

  # Semgrep SAST
  semgrep:
    name: Semgrep SAST Scan
    needs: fork-check
    if: needs.fork-check.outputs.can-scan == 'true'
    runs-on: ubuntu-latest
    outputs:
      severity: ${{ steps.scan.outputs.severity }}
      high_critical_count: ${{ steps.scan.outputs.high_critical_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Semgrep Scan
        id: scan
        uses: ./.github/actions/semgrep-scan

      - name: Check Critical Findings
        if: steps.scan.outputs.severity == 'critical'
        run: |
          echo "âŒ Critical: High/Critical ã®è„†å¼±æ€§ãŒ ${HIGH_CRITICAL_COUNT} ä»¶æ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          exit 1
        env:
          HIGH_CRITICAL_COUNT: ${{ steps.scan.outputs.high_critical_count }}

  # ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚µãƒãƒªãƒ¼
  security-summary:
    name: Security Scan Summary
    needs: [fork-check, trufflehog, semgrep]
    if: always() && needs.fork-check.outputs.can-scan == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # TruffleHogçµæœ
          echo "### ğŸ”‘ TruffleHog Secret Scanning" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.trufflehog.result }}" = "success" ]; then
            echo "âœ… æ¤œè¨¼æ¸ˆã¿ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ æ¤œè¨¼æ¸ˆã¿ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Semgrepçµæœ
          echo "### ğŸ›¡ï¸ Semgrep SAST" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.semgrep.result }}" = "success" ]; then
            echo "âœ… Critical/High ã®è„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Critical/High ã®è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # ç·åˆåˆ¤å®š
          echo "### ğŸ“‹ ç·åˆåˆ¤å®š" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.trufflehog.result }}" = "success" ] && [ "${{ needs.semgrep.result }}" = "success" ]; then
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã«åˆæ ¼ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã«ä¸åˆæ ¼ã§ã™ã€‚ä¸Šè¨˜ã®æ¤œå‡ºé …ç›®ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          fi

  # Forkè­¦å‘Šã‚³ãƒ¡ãƒ³ãƒˆ
  comment-fork-warning:
    name: Comment Fork Warning
    needs: fork-check
    if: needs.fork-check.outputs.can-scan == 'false'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Comment Fork Warning
        uses: actions/github-script@v7
        with:
          script: |
            const forkWarning = `## âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚¹ã‚­ãƒƒãƒ—

            ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãƒ•ã‚©ãƒ¼ã‚¯ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ã‚¹ã‚­ãƒ£ãƒ³ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸï¼š

            ### ğŸ”’ ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸã‚¹ã‚­ãƒ£ãƒ³
            - ğŸ”‘ TruffleHog Secret Scanning
            - ğŸ›¡ï¸ Semgrep SAST

            ### ğŸ“ å¯¾å¿œæ–¹æ³•
            - ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã«æ‰‹å‹•ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½ã—ã¾ã™
            - ãƒãƒ¼ã‚¸å¾Œã«æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã¾ã™

            ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ ğŸ™`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: forkWarning,
            });
