name: CI

on:
  pull_request:
    branches:
      - main
    # Fork PRのみ実行（同一リポジトリPRはpreview.ymlでテスト）
  workflow_call:
    inputs:
      concurrency_suffix:
        description: 'Concurrency group suffix to avoid conflicts'
        required: false
        type: string
      cancel_in_progress:
        description: 'Cancel in progress runs'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

concurrency:
  group: ${{ github.event_name == 'workflow_call' && inputs.concurrency_suffix || format('{0}-{1}', github.workflow, github.ref) }}
  cancel-in-progress: ${{ github.event_name != 'workflow_call' || inputs.cancel_in_progress != false }}

env:
  # CI最適化設定
  ACTIONS_RUNNER_DEBUG: false
  ACTIONS_STEP_DEBUG: false

jobs:
  # Client (Next.js) のユニットテスト
  client-test:
    name: Client Unit Tests
    # workflow_call時は無条件実行、pull_request時はFork PRのみ実行
    if: github.event_name == 'workflow_call' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository)
    uses: ./.github/workflows/client-test.yml
    with:
      working-directory: ./app/client

  # Server (Hono) のユニット/結合テスト
  server-test:
    name: Server Unit Tests
    # workflow_call時は無条件実行、pull_request時はFork PRのみ実行
    if: github.event_name == 'workflow_call' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository)
    uses: ./.github/workflows/server-test.yml
    with:
      working-directory: ./app/server

  # E2E (Playwright) テスト
  e2e-test:
    name: E2E Tests
    # workflow_call時は無条件実行、pull_request時はFork PRのみ実行
    if: github.event_name == 'workflow_call' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository)
    # 完全並行にするか、依存関係を維持するかはプロジェクトの方針次第
    # needs: [client-test, server-test]  # コスト効率重視の場合
    uses: ./.github/workflows/e2e-test.yml
    with:
      concurrency_suffix: ${{ inputs.concurrency_suffix || '' }}
      cancel_in_progress: ${{ inputs.cancel_in_progress != null && inputs.cancel_in_progress || inputs.cancel_in_progress == null }}

  # 全テスト成功の明示的チェック
  all-tests-passed:
    name: All Tests Passed
    runs-on: ubuntu-latest
    # workflow_call時は無条件実行、pull_request時はFork PRのみ実行
    if: github.event_name == 'workflow_call' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository)
    needs: [client-test, server-test, e2e-test]
    steps:
      - name: Check all tests passed
        run: echo "✅ All tests (client, server, e2e) passed successfully"
