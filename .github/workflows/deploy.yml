name: Production Deployment

on:
  push:
    branches:
      - main    # REQ-104æº–æ‹ : mainãƒãƒ¼ã‚¸ã§productionæ›´æ–°
      - HOXBL-27-main-deploy-workflow  # ãƒ†ã‚¹ãƒˆç”¨: ãƒ–ãƒ©ãƒ³ãƒã§ç›´æ¥ãƒ†ã‚¹ãƒˆ
  workflow_dispatch: {}  # æ‰‹å‹•å®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: ap-northeast-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  # Phase 0: ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹è¨˜éŒ²
  log-deployment-start:
    name: Log Deployment Start
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Record Deployment Start
        uses: ./.github/actions/deployment-logger
        with:
          event-type: 'start'
          component: 'full-stack'
          environment: ${{ github.ref_name == 'main' && 'production' || 'preview' }}
          details: 'Starting full stack deployment'

  # Phase 1: ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: [log-deployment-start]
    permissions:
      id-token: write
      contents: read
    uses: ./.github/workflows/deploy-infra.yml
    with:
      terraform-version: ${{ vars.TERRAFORM_VERSION }}
      aws-region: ${{ vars.AWS_REGION }}
    secrets: inherit

  # Phase 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  deploy-database:
    name: Deploy Database
    needs: [deploy-infrastructure]
    uses: ./.github/workflows/deploy-database.yml
    with:
      timeout-minutes: 10
    secrets: inherit

  # Phase 3: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆdatabaseå®Œäº†å¾Œã€frontendã¨ä¸¦è¡Œå®Ÿè¡Œï¼‰
  deploy-backend:
    name: Deploy Backend
    needs: [deploy-database]
    permissions:
      id-token: write
      contents: read
    uses: ./.github/workflows/deploy-backend.yml
    with:
      lambda-function-name: ${{ github.ref_name == 'main' && needs.deploy-infrastructure.outputs.lambda-function-name-production || needs.deploy-infrastructure.outputs.lambda-function-name-preview }}
      environment-type: ${{ github.ref_name == 'main' && 'production' || 'preview' }}
      aws-region: ${{ vars.AWS_REGION }}
      cors-allow-origin: ${{ github.ref_name == 'main' && needs.deploy-infrastructure.outputs.access-allow-origin-production || needs.deploy-infrastructure.outputs.access-allow-origin-preview }}
    secrets: inherit

  # Phase 4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆinfrastructureå®Œäº†å¾Œã€backendã¨ä¸¦è¡Œå®Ÿè¡Œï¼‰
  deploy-frontend:
    name: Deploy Frontend
    needs: [deploy-infrastructure]
    uses: ./.github/workflows/deploy-frontend.yml
    with:
      environment-type: ${{ github.ref_name == 'main' && 'production' || 'preview' }}
      next-public-api-base-url: ${{ github.ref_name == 'main' && needs.deploy-infrastructure.outputs.next-public-api-base-url-production || needs.deploy-infrastructure.outputs.next-public-api-base-url-preview }}
      next-public-site-url: ${{ github.ref_name == 'main' && needs.deploy-infrastructure.outputs.next-public-site-url-production || needs.deploy-infrastructure.outputs.next-public-site-url-preview }}
      next-public-trusted-domains: ${{ github.ref_name == 'main' && needs.deploy-infrastructure.outputs.next-public-trusted-domains-production || needs.deploy-infrastructure.outputs.next-public-trusted-domains-preview }}
      cloudflare-project-name: ${{ vars.PROJECT_NAME }}
    secrets: inherit

  # Phase 5: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
  notify-success:
    name: Notify Deployment Success
    if: success()
    needs: [deploy-infrastructure, deploy-database, deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Record Deployment Success
        uses: ./.github/actions/deployment-logger
        with:
          event-type: 'success'
          component: 'full-stack'
          environment: ${{ github.ref_name == 'main' && 'production' || 'preview' }}
          details: 'All components deployed successfully'

      - name: Generate Deployment Summary
        uses: ./.github/actions/deployment-summary
        with:
          environment-type: ${{ github.ref_name == 'main' && 'production' || 'preview' }}
          lambda-function-url: ${{ github.ref_name == 'main' && needs.deploy-infrastructure.outputs.next-public-api-base-url-production || needs.deploy-infrastructure.outputs.next-public-api-base-url-preview }}
          cloudflare-deployment-url: ${{ needs.deploy-frontend.outputs.deployment-url }}
          lambda-version: ${{ needs.deploy-backend.outputs.deployed-version }}
          terraform-outputs: ${{ needs.deploy-infrastructure.outputs.terraform-outputs }}
          commit-sha: ${{ github.sha }}
          branch-name: ${{ github.ref_name }}

      - name: Send Success Notification
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'success'
          title: 'ğŸš€ Production Deployment Completed Successfully!'
          components: 'âœ… Infrastructure (Terraform)\nâœ… Database (drizzle-kit)\nâœ… Backend (AWS Lambda)\nâœ… Frontend (CloudFlare Pages)'
          commit-sha: ${{ github.sha }}
          branch-name: ${{ github.ref_name }}
          actor: ${{ github.actor }}
          repository: ${{ github.repository }}
          run-id: ${{ github.run_id }}

  # Phase 6: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
  notify-failure:
    name: Notify Deployment Failure
    if: failure()
    needs: [deploy-infrastructure, deploy-database, deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Record Deployment Failure
        uses: ./.github/actions/deployment-logger
        with:
          event-type: 'failure'
          component: 'full-stack'
          environment: ${{ github.ref_name == 'main' && 'production' || 'preview' }}
          details: 'Deployment failed - check logs for details'

      - name: Send Failure Notification
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'failure'
          title: 'âŒ Production Deployment Failed!'
          commit-sha: ${{ github.sha }}
          branch-name: ${{ github.ref_name }}
          actor: ${{ github.actor }}
          repository: ${{ github.repository }}
          run-id: ${{ github.run_id }}