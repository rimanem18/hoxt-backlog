name: Deploy Database

on:
  workflow_call:
    inputs:
      timeout-minutes:
        description: 'Timeout for database migration in minutes'
        required: false
        type: number
        default: 10
      database-url:
        description: 'Database URL for migration'
        required: false
        type: string
      environment-type:
        description: 'Environment type (production or preview)'
        required: false
        type: string
        default: 'production'
    outputs:
      migration-status:
        description: 'Database migration status'
        value: ${{ jobs.migrate-database.outputs.migration-status }}

jobs:
  migrate-database:
    name: Database Migration (drizzle-kit)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      migration-status: ${{ steps.migrate.outputs.status }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun Workspace
        uses: ./.github/actions/setup-bun-workspace
        with:
          working-directory: './app/server'
          cache-key-suffix: 'database'

      - name: Run Database Migration
        id: migrate
        working-directory: ./app/server
        timeout-minutes: ${{ inputs.timeout-minutes }}
        env:
          TIMEOUT_MINUTES: ${{ inputs.timeout-minutes }}
          DATABASE_URL_INPUT: ${{ inputs.database-url }}
          DATABASE_URL_PROD: ${{ secrets.DATABASE_URL_MIGRATE }}
          DATABASE_URL_PREVIEW: ${{ secrets.DATABASE_URL_MIGRATE_PREVIEW }}
          PROJECT_NAME: ${{ vars.PROJECT_NAME }}
          ENVIRONMENT_TYPE: ${{ inputs.environment-type }}
        run: |
          set -euo pipefail

          # environment-type ã®å³å¯†ãªæ¤œè¨¼ã¨ç’°å¢ƒå¤‰æ•°è¨­å®š
          case "${ENVIRONMENT_TYPE}" in
            production)
              export BASE_SCHEMA="app_${PROJECT_NAME}"
              MIGRATION_CMD="db:migrate:production"
              DB_URL="${DATABASE_URL_INPUT:-${DATABASE_URL_PROD}}"
              export DATABASE_URL="${DB_URL}"
              ;;
            preview)
              export BASE_SCHEMA="app_${PROJECT_NAME}_preview"
              MIGRATION_CMD="db:migrate:preview"
              DB_URL="${DATABASE_URL_INPUT:-${DATABASE_URL_PREVIEW}}"
              export DATABASE_URL="${DB_URL}"
              ;;
            *)
              echo "âŒ Error: Invalid environment-type '${ENVIRONMENT_TYPE}'"
              echo "   Valid values: 'production', 'preview'"
              exit 1
              ;;
          esac

          echo "=== ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ==="
          echo "Environment: ${ENVIRONMENT_TYPE}"
          echo "BASE_SCHEMA: ${BASE_SCHEMA}"
          echo "Command: bun run ${MIGRATION_CMD}"

          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œé–¢æ•°ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã®ä¸€å…ƒåŒ–ï¼‰
          run_with_timeout() {
            local cmd="$1"
            local description="$2"

            if timeout "${TIMEOUT_MINUTES}m" bun run "${cmd}"; then
              echo "âœ… ${description}ãŒå®Œäº†ã—ã¾ã—ãŸ"
              return 0
            else
              local exit_code=$?
              echo "status=failed" >> "$GITHUB_OUTPUT"

              if [ $exit_code -eq 124 ]; then
                echo "âŒ ${description}ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆ${TIMEOUT_MINUTES}åˆ†ï¼‰"
              else
                echo "âŒ ${description}ãŒå¤±æ•—ã—ã¾ã—ãŸï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰: $exit_codeï¼‰"
              fi

              return $exit_code
            fi
          }

          # 1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
          if ! run_with_timeout "${MIGRATION_CMD}" "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"; then
            exit 1
          fi

          # 2. RLSãƒãƒªã‚·ãƒ¼é©ç”¨
          if ! run_with_timeout "db:setup" "RLSãƒãƒªã‚·ãƒ¼é©ç”¨"; then
            exit 1
          fi

          echo "status=success" >> "$GITHUB_OUTPUT"
          echo "=== ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº† ==="

      - name: Migration Completion Log
        if: steps.migrate.outputs.status == 'success'
        shell: bash
        run: |
          echo "ğŸ¯ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é‹ç”¨ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
