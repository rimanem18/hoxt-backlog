name: 'Deployment Summary'
description: 'Generate comprehensive deployment summary with URLs and metadata for easy access'

inputs:
  environment-type:
    description: 'Environment type (production or preview)'
    required: true
  lambda-function-url:
    description: 'Lambda function URL'
    required: false
  cloudflare-deployment-url:
    description: 'CloudFlare Pages deployment URL'
    required: false
  lambda-version:
    description: 'Deployed Lambda version'
    required: false
  terraform-outputs:
    description: 'JSON string of Terraform outputs'
    required: false
  commit-sha:
    description: 'Git commit SHA'
    required: false
    default: ${{ github.sha }}
  branch-name:
    description: 'Git branch name'
    required: false
    default: ${{ github.ref_name }}

runs:
  using: 'composite'
  steps:
    - name: Generate Deployment Summary
      shell: bash
      run: |
        # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µãƒžãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        SUMMARY_FILE="deployment-summary-$(date +%Y%m%d-%H%M%S).md"
        COMMIT_SHORT=$(echo "${{ inputs.commit-sha }}" | cut -c1-8)
        
        # ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§ã‚µãƒžãƒªãƒ¼ã‚’ç”Ÿæˆ
        cat > "$SUMMARY_FILE" << 'EOF'
        # ðŸš€ Deployment Summary
        
        ## ðŸ“‹ Basic Information
        - **Environment**: ${{ inputs.environment-type }}
        - **Commit**: ${{ inputs.commit-sha }} (`$COMMIT_SHORT`)
        - **Branch**: ${{ inputs.branch-name }}
        - **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - **Actor**: ${{ github.actor }}
        
        ## ðŸŒ Deployment URLs
        EOF
        
        # Lambda URLæƒ…å ±ã‚’è¿½åŠ 
        if [ -n "${{ inputs.lambda-function-url }}" ]; then
          echo "- **ðŸ”— API Endpoint**: ${{ inputs.lambda-function-url }}" >> "$SUMMARY_FILE"
        fi
        
        # CloudFlare URLæƒ…å ±ã‚’è¿½åŠ   
        if [ -n "${{ inputs.cloudflare-deployment-url }}" ]; then
          echo "- **ðŸ“± Frontend URL**: ${{ inputs.cloudflare-deployment-url }}" >> "$SUMMARY_FILE"
        fi
        
        # Lambda ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¿½åŠ 
        if [ -n "${{ inputs.lambda-version }}" ]; then
          echo "" >> "$SUMMARY_FILE"
          echo "## âš™ï¸ Technical Details" >> "$SUMMARY_FILE"
          echo "- **Lambda Version**: ${{ inputs.lambda-version }}" >> "$SUMMARY_FILE"
        fi
        
        # Terraformå‡ºåŠ›æƒ…å ±ã‚’è¿½åŠ 
        if [ -n "${{ inputs.terraform-outputs }}" ]; then
          echo "- **Infrastructure**: Updated via Terraform" >> "$SUMMARY_FILE"
        fi
        
        # GitHub Actionsã‚µãƒžãƒªãƒ¼ã«è¡¨ç¤º
        echo "## ðŸŽ¯ ${{ inputs.environment-type }} Deployment Completed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        cat "$SUMMARY_FILE" >> $GITHUB_STEP_SUMMARY
        
        # è¿½åŠ ã®ä¾¿åˆ©æƒ…å ±
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ”§ Quick Actions" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${{ inputs.lambda-function-url }}" ]; then
          echo "- [ðŸ§ª Test API Endpoint](${{ inputs.lambda-function-url }}/health)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "${{ inputs.cloudflare-deployment-url }}" ]; then
          echo "- [ðŸ‘€ View Frontend](${{ inputs.cloudflare-deployment-url }})" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "- [ðŸ“Š View Deployment Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        
        echo "âœ… Deployment summary generated: $SUMMARY_FILE"

    - name: Upload Deployment Summary
      uses: actions/upload-artifact@v4
      with:
        name: deployment-summary-${{ inputs.environment-type }}-${{ github.run_id }}
        path: deployment-summary-*.md
        retention-days: 90