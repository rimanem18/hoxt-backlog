name: 'Discord Notification'
description: 'Send deployment status notifications to Discord with customizable embeds'

inputs:
  webhook-url:
    description: 'Discord webhook URL'
    required: true
  status:
    description: 'Deployment status (success or failure)'
    required: true
  title:
    description: 'Notification title'
    required: false
    default: ''
  components:
    description: 'List of deployed components'
    required: false
    default: ''
  commit-sha:
    description: 'Git commit SHA'
    required: false
    default: ${{ github.sha }}
  branch-name:
    description: 'Git branch name'
    required: false
    default: ${{ github.ref_name }}
  actor:
    description: 'GitHub actor who triggered the deployment'
    required: false
    default: ${{ github.actor }}
  repository:
    description: 'GitHub repository'
    required: false
    default: ${{ github.repository }}
  run-id:
    description: 'GitHub Actions run ID'
    required: false
    default: ${{ github.run_id }}
  repository-url:
    description: 'Full repository URL'
    required: false
    default: ''
  frontend-url:
    description: 'Frontend production URL'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Prepare notification content
      id: prepare
      shell: bash
      run: |
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸè¨­å®š
        if [ "${{ inputs.status }}" = "success" ]; then
          TITLE="${{ inputs.title }}"
          if [ -z "$TITLE" ]; then
            TITLE="ğŸš€ Production Deployment Completed Successfully!"
          fi
          COLOR=65280  # ç·‘è‰²
          
          COMPONENTS="${{ inputs.components }}"
          if [ -z "$COMPONENTS" ]; then
            COMPONENTS="âœ… Infrastructure (Terraform)\\nâœ… Database (drizzle-kit)\\nâœ… Backend (AWS Lambda)\\nâœ… Frontend (CloudFlare Pages)"
          fi
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "components=$COMPONENTS" >> $GITHUB_OUTPUT
        else
          TITLE="${{ inputs.title }}"
          if [ -z "$TITLE" ]; then
            TITLE="âŒ Production Deployment Failed!"
          fi
          COLOR=16711680  # èµ¤è‰²
          
          ACTION_MESSAGE="Please check the [job logs](${{ github.server_url }}/${{ inputs.repository }}/actions/runs/${{ inputs.run-id }}) for details and retry the deployment."
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "action_message=$ACTION_MESSAGE" >> $GITHUB_OUTPUT
        fi

    - name: Send Discord notification
      shell: bash
      run: |
        # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç”Ÿæˆ
        TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)

        # æˆåŠŸæ™‚ã¨å¤±æ•—æ™‚ã§ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’åˆ†å²
        if [ "${{ inputs.status }}" = "success" ]; then
          # åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ§‹ç¯‰
          FIELDS='[
            {"name": "Commit", "value": "${{ inputs.commit-sha }}", "inline": true},
            {"name": "Branch", "value": "${{ inputs.branch-name }}", "inline": true},
            {"name": "Actor", "value": "${{ inputs.actor }}", "inline": true},
            {"name": "Repository", "value": "${{ inputs.repository }}", "inline": false},
            {"name": "Components Deployed", "value": "${{ steps.prepare.outputs.components }}", "inline": false}'

          # Repository URLãŒç©ºã§ãªã„å ´åˆã¯è¿½åŠ 
          if [ -n "${{ inputs.repository-url }}" ]; then
            FIELDS="$FIELDS"',
            {"name": "ğŸ”— Repository URL", "value": "${{ inputs.repository-url }}", "inline": false}'
          fi

          # Frontend URLãŒç©ºã§ãªã„å ´åˆã¯è¿½åŠ 
          if [ -n "${{ inputs.frontend-url }}" ]; then
            FIELDS="$FIELDS"',
            {"name": "ğŸŒ Frontend URL", "value": "${{ inputs.frontend-url }}", "inline": false}'
          fi

          # ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é…åˆ—ã‚’é–‰ã˜ã‚‹
          FIELDS="$FIELDS"']'

          PAYLOAD=$(cat <<EOF
        {
          "embeds": [{
            "title": "${{ steps.prepare.outputs.title }}",
            "color": ${{ steps.prepare.outputs.color }},
            "fields": $FIELDS,
            "timestamp": "$TIMESTAMP"
          }]
        }
        EOF
          )
        else
          PAYLOAD=$(cat <<EOF
        {
          "embeds": [{
            "title": "${{ steps.prepare.outputs.title }}",
            "color": ${{ steps.prepare.outputs.color }},
            "fields": [
              {"name": "Commit", "value": "${{ inputs.commit-sha }}", "inline": true},
              {"name": "Branch", "value": "${{ inputs.branch-name }}", "inline": true},
              {"name": "Actor", "value": "${{ inputs.actor }}", "inline": true},
              {"name": "Repository", "value": "${{ inputs.repository }}", "inline": false},
              {"name": "Action", "value": "${{ steps.prepare.outputs.action_message }}", "inline": false}
            ],
            "timestamp": "$TIMESTAMP"
          }]
        }
        EOF
          )
        fi
        
        # Discord Webhookã«é€šçŸ¥ã‚’é€ä¿¡
        curl -H "Content-Type: application/json" \
             -d "$PAYLOAD" \
             "${{ inputs.webhook-url }}" \
             --fail --silent --show-error
        
        echo "âœ… Discordé€šçŸ¥ã‚’æ­£å¸¸ã«é€ä¿¡ã—ã¾ã—ãŸ"