name: 'Discord Notification'
description: 'Send deployment status notifications to Discord with customizable embeds'

inputs:
  webhook-url:
    description: 'Discord webhook URL'
    required: true
  status:
    description: 'Deployment status (success or failure)'
    required: true
  title:
    description: 'Notification title'
    required: false
    default: ''
  components:
    description: 'List of deployed components'
    required: false
    default: ''
  commit-sha:
    description: 'Git commit SHA'
    required: false
    default: ${{ github.sha }}
  branch-name:
    description: 'Git branch name'
    required: false
    default: ${{ github.ref_name }}
  actor:
    description: 'GitHub actor who triggered the deployment'
    required: false
    default: ${{ github.actor }}
  repository:
    description: 'GitHub repository'
    required: false
    default: ${{ github.repository }}
  run-id:
    description: 'GitHub Actions run ID'
    required: false
    default: ${{ github.run_id }}
  repository-url:
    description: 'Full repository URL'
    required: false
    default: ''
  frontend-url:
    description: 'Frontend production URL'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Prepare notification content
      id: prepare
      shell: bash
      env:
        INPUT_STATUS: ${{ inputs.status }}
        INPUT_TITLE: ${{ inputs.title }}
        INPUT_COMPONENTS: ${{ inputs.components }}
        GITHUB_SERVER_URL: ${{ github.server_url }}
        INPUT_REPOSITORY: ${{ inputs.repository }}
        INPUT_RUN_ID: ${{ inputs.run-id }}
      run: |
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸè¨­å®š
        if [ "$INPUT_STATUS" = "success" ]; then
          TITLE="$INPUT_TITLE"
          if [ -z "$TITLE" ]; then
            TITLE="ğŸš€ Production Deployment Completed Successfully!"
          fi
          COLOR=65280  # ç·‘è‰²

          COMPONENTS="$INPUT_COMPONENTS"
          if [ -z "$COMPONENTS" ]; then
            COMPONENTS="âœ… Infrastructure (Terraform)\\nâœ… Database (drizzle-kit)\\nâœ… Backend (AWS Lambda)\\nâœ… Frontend (CloudFlare Pages)"
          fi

          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "color=$COLOR" >> "$GITHUB_OUTPUT"
          echo "components=$COMPONENTS" >> "$GITHUB_OUTPUT"
        else
          TITLE="$INPUT_TITLE"
          if [ -z "$TITLE" ]; then
            TITLE="âŒ Production Deployment Failed!"
          fi
          COLOR=16711680  # èµ¤è‰²

          ACTION_MESSAGE="Please check the [job logs](${GITHUB_SERVER_URL}/${INPUT_REPOSITORY}/actions/runs/${INPUT_RUN_ID}) for details and retry the deployment."

          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "color=$COLOR" >> "$GITHUB_OUTPUT"
          echo "action_message=$ACTION_MESSAGE" >> "$GITHUB_OUTPUT"
        fi

    - name: Send Discord notification
      shell: bash
      env:
        INPUT_STATUS: ${{ inputs.status }}
        INPUT_COMMIT_SHA: ${{ inputs.commit-sha }}
        INPUT_BRANCH_NAME: ${{ inputs.branch-name }}
        INPUT_ACTOR: ${{ inputs.actor }}
        INPUT_REPOSITORY: ${{ inputs.repository }}
        INPUT_REPOSITORY_URL: ${{ inputs.repository-url }}
        INPUT_FRONTEND_URL: ${{ inputs.frontend-url }}
        INPUT_WEBHOOK_URL: ${{ inputs.webhook-url }}
        PREPARE_TITLE: ${{ steps.prepare.outputs.title }}
        PREPARE_COLOR: ${{ steps.prepare.outputs.color }}
        PREPARE_COMPONENTS: ${{ steps.prepare.outputs.components }}
        PREPARE_ACTION_MESSAGE: ${{ steps.prepare.outputs.action_message }}
      run: |
        # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç”Ÿæˆ
        TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)

        # æˆåŠŸæ™‚ã¨å¤±æ•—æ™‚ã§ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’åˆ†å²
        if [ "$INPUT_STATUS" = "success" ]; then
          # åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ§‹ç¯‰
          FIELDS='[
            {"name": "Commit", "value": "'"$INPUT_COMMIT_SHA"'", "inline": true},
            {"name": "Branch", "value": "'"$INPUT_BRANCH_NAME"'", "inline": true},
            {"name": "Actor", "value": "'"$INPUT_ACTOR"'", "inline": true},
            {"name": "Repository", "value": "'"$INPUT_REPOSITORY"'", "inline": false},
            {"name": "Components Deployed", "value": "'"$PREPARE_COMPONENTS"'", "inline": false}'

          # Repository URLãŒç©ºã§ãªã„å ´åˆã¯è¿½åŠ 
          if [ -n "$INPUT_REPOSITORY_URL" ]; then
            FIELDS="$FIELDS"',
            {"name": "ğŸ”— Repository URL", "value": "'"$INPUT_REPOSITORY_URL"'", "inline": false}'
          fi

          # Frontend URLãŒç©ºã§ãªã„å ´åˆã¯è¿½åŠ 
          if [ -n "$INPUT_FRONTEND_URL" ]; then
            FIELDS="$FIELDS"',
            {"name": "ğŸŒ Frontend URL", "value": "'"$INPUT_FRONTEND_URL"'", "inline": false}'
          fi

          # ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é…åˆ—ã‚’é–‰ã˜ã‚‹
          FIELDS="$FIELDS"']'

          PAYLOAD=$(cat <<EOF
        {
          "embeds": [{
            "title": "$PREPARE_TITLE",
            "color": $PREPARE_COLOR,
            "fields": $FIELDS,
            "timestamp": "$TIMESTAMP"
          }]
        }
        EOF
          )
        else
          PAYLOAD=$(cat <<EOF
        {
          "embeds": [{
            "title": "$PREPARE_TITLE",
            "color": $PREPARE_COLOR,
            "fields": [
              {"name": "Commit", "value": "$INPUT_COMMIT_SHA", "inline": true},
              {"name": "Branch", "value": "$INPUT_BRANCH_NAME", "inline": true},
              {"name": "Actor", "value": "$INPUT_ACTOR", "inline": true},
              {"name": "Repository", "value": "$INPUT_REPOSITORY", "inline": false},
              {"name": "Action", "value": "$PREPARE_ACTION_MESSAGE", "inline": false}
            ],
            "timestamp": "$TIMESTAMP"
          }]
        }
        EOF
          )
        fi

        # Discord Webhookã«é€šçŸ¥ã‚’é€ä¿¡
        curl -H "Content-Type: application/json" \
             -d "$PAYLOAD" \
             "$INPUT_WEBHOOK_URL" \
             --fail --silent --show-error

        echo "âœ… Discordé€šçŸ¥ã‚’æ­£å¸¸ã«é€ä¿¡ã—ã¾ã—ãŸ"