name: 'Semgrep SAST Scanning'
description: 'Static application security testing with Semgrep using official recommended rules'

outputs:
  severity:
    description: 'Scan severity: none (no issues), warning (Medium/Low findings), or critical (High/Critical findings)'
    value: ${{ steps.analyze.outputs.severity }}
  high_critical_count:
    description: 'Number of High/Critical severity findings'
    value: ${{ steps.analyze.outputs.high_critical_count }}
  medium_low_count:
    description: 'Number of Medium/Low severity findings'
    value: ${{ steps.analyze.outputs.medium_low_count }}

runs:
  using: 'composite'
  steps:
    - name: Run Semgrep SAST
      shell: bash
      run: |
        # Composite actionã§ã¯job-level containerãŒä½¿ãˆãªã„ãŸã‚ã€
        # Docker run ã‚’ç›´æ¥å®Ÿè¡Œã—ã¦Semgrepã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ©ç”¨

        echo "ğŸ›¡ï¸ Semgrep SAST ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¾ã™..."

        # bash -e ãƒ¢ãƒ¼ãƒ‰ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼ˆexit code 1ã‚’è¨±å®¹ã™ã‚‹ãŸã‚ï¼‰
        set +e

        # å…¬å¼æ¨å¥¨è»½é‡ãƒ«ãƒ¼ãƒ«ã®ã¿ä½¿ç”¨ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ãªã—ï¼‰
        # --config=auto: SemgrepãŒè‡ªå‹•ã§é©åˆ‡ãªãƒ«ãƒ¼ãƒ«ã‚»ãƒƒãƒˆã‚’é¸æŠ
        docker run --rm \
          -v "$PWD:/src" \
          returntocorp/semgrep:latest \
          semgrep scan \
          --config=auto \
          --json \
          --output=/src/semgrep-results.json \
          /src

        SEMGREP_EXIT=$?

        # bash -e ãƒ¢ãƒ¼ãƒ‰ã‚’å†æœ‰åŠ¹åŒ–
        set -e

        # Semgrepã®exit codeã‚’åˆ¤å®š
        # 0: ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆè„†å¼±æ€§ãªã—ï¼‰
        # 1: è„†å¼±æ€§æ¤œå‡º
        # 2+: ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¤ãƒ³ãƒ•ãƒ©/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ç­‰ï¼‰
        if [ $SEMGREP_EXIT -eq 0 ] || [ $SEMGREP_EXIT -eq 1 ]; then
          echo "âœ… Semgrep ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ï¼ˆexit code: $SEMGREP_EXITï¼‰"
        else
          echo "âŒ Semgrep å®Ÿè¡Œã‚¨ãƒ©ãƒ¼ï¼ˆexit code: $SEMGREP_EXITï¼‰"
          exit $SEMGREP_EXIT
        fi

    - name: Analyze Semgrep Results
      id: analyze
      shell: bash
      run: |
        echo "ğŸ” Semgrep çµæœã‚’åˆ†æä¸­..."

        # çµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ç©ºã®å ´åˆ
        if [ ! -f semgrep-results.json ] || [ ! -s semgrep-results.json ]; then
          echo "âœ… è„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          echo "severity=none" >> $GITHUB_OUTPUT
          echo "high_critical_count=0" >> $GITHUB_OUTPUT
          echo "medium_low_count=0" >> $GITHUB_OUTPUT
          exit 0
        fi

        # jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€äº‹å‰ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if ! command -v jq &> /dev/null; then
          echo "ğŸ“¦ jqã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          sudo apt-get update -qq && sudo apt-get install -y -qq jq
        fi

        # é‡è¦åº¦åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
        # Semgrepã®é‡è¦åº¦: ERROR (High/Criticalç›¸å½“), WARNING (Mediumç›¸å½“), INFO (Lowç›¸å½“)
        HIGH_CRITICAL_COUNT=$(cat semgrep-results.json | jq '[.results[] | select(.extra.severity == "ERROR" or .extra.severity == "CRITICAL")] | length' 2>/dev/null || echo "0")
        MEDIUM_LOW_COUNT=$(cat semgrep-results.json | jq '[.results[] | select(.extra.severity == "WARNING" or .extra.severity == "INFO")] | length' 2>/dev/null || echo "0")

        echo "ğŸ“Š æ¤œå‡ºçµæœ:"
        echo "  - High/Critical: ${HIGH_CRITICAL_COUNT}ä»¶"
        echo "  - Medium/Low: ${MEDIUM_LOW_COUNT}ä»¶"

        # å‡ºåŠ›è¨­å®š
        echo "high_critical_count=${HIGH_CRITICAL_COUNT}" >> $GITHUB_OUTPUT
        echo "medium_low_count=${MEDIUM_LOW_COUNT}" >> $GITHUB_OUTPUT

        # é‡è¦åº¦åˆ¤å®š
        if [ "$HIGH_CRITICAL_COUNT" -gt 0 ]; then
          echo "âŒ High/Critical ã®è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          echo "severity=critical" >> $GITHUB_OUTPUT

          # æ¤œå‡ºå†…å®¹ã®è©³ç´°è¡¨ç¤º
          echo "ğŸ”´ æ¤œå‡ºã•ã‚ŒãŸ High/Critical è„†å¼±æ€§:"
          cat semgrep-results.json | jq -r '.results[] | select(.extra.severity == "ERROR" or .extra.severity == "CRITICAL") | "  âš ï¸ [\(.extra.severity)] \(.check_id): \(.path):\(.start.line)"' 2>/dev/null || echo "  è©³ç´°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼"

        elif [ "$MEDIUM_LOW_COUNT" -gt 0 ]; then
          echo "âš ï¸ Medium/Low ã®è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆè­¦å‘Šãƒ¬ãƒ™ãƒ«ï¼‰"
          echo "severity=warning" >> $GITHUB_OUTPUT

          # æ¤œå‡ºå†…å®¹ã®è©³ç´°è¡¨ç¤º
          echo "ğŸŸ¡ æ¤œå‡ºã•ã‚ŒãŸ Medium/Low è„†å¼±æ€§:"
          cat semgrep-results.json | jq -r '.results[] | select(.extra.severity == "WARNING" or .extra.severity == "INFO") | "  â„¹ï¸ [\(.extra.severity)] \(.check_id): \(.path):\(.start.line)"' 2>/dev/null || echo "  è©³ç´°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼"

        else
          echo "âœ… è„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          echo "severity=none" >> $GITHUB_OUTPUT
        fi

        # Composite actionã¯å¸¸ã«æˆåŠŸã•ã›ã€å‘¼ã³å‡ºã—å´ã§åˆ¤å®š
        exit 0

    - name: Upload Semgrep Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: semgrep-results
        path: semgrep-results.json
        retention-days: 30
        if-no-files-found: ignore
