# 継続的デプロイフロー 要件定義書

作成日：2025年09月12日  
最終更新：2025年09月12日

## 概要

GitHub Actions と Terraform を使用した継続的デプロイフローを構築し、フロントエンドを CloudFlare Pages、バックエンドを AWS Lambda、データベースを Supabase マイグレーションで運用する統合デプロイメントシステムを実現する。

## ユーザストーリー

### ストーリー1: 開発者としての自動デプロイ

- **である** 開発者 **として**
- **私は** コードをmainブランチにプッシュするだけで、全サービス（フロント・API・DB）が安全かつ自動的にデプロイされる **をしたい**
- **そうすることで** 手動デプロイの手間を削減し、デプロイエラーによる障害リスクを最小化できる

### ストーリー2: チームリーダーとしての品質保証

- **である** チームリーダー **として**
- **私は** PRごとにプレビュー環境が自動生成され、破壊的変更は承認フローで制御される **をしたい**
- **そうすることで** 安全なリリースプロセスを確保し、本番環境への影響を最小化できる

### ストーリー3: 運用担当者としての基本監視

- **である** 運用担当者 **として**
- **私は** デプロイ操作の基本履歴（実行者・日時・対象）が記録される **をしたい**
- **そうすることで** 問題発生時に最低限の原因追跡ができる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは mainブランチへのプッシュ時に自動的に継続的デプロイフローを開始しなければならない
- REQ-002: システムは Terraform による基盤構築を最優先で実行しなければならない
- REQ-003: システムは Supabase マイグレーションを基盤構築後に実行しなければならない
- REQ-004: システムは AWS Lambda デプロイをマイグレーション完了後に実行しなければならない
- REQ-005: システムは CloudFlare Pages デプロイを Lambda デプロイ完了後に実行しなければならない
- REQ-006: システムは GitHub OIDC を使用したシークレットレス認証を実装しなければならない

### 条件付き要件

- REQ-101: プルリクエスト作成時の場合、システムは プレビュー環境（CloudFlare Preview + Lambda $LATEST + Supabase branch）を自動生成しなければならない
- REQ-102: Terraform plan で破壊的変更が検出された場合、システムは 承認フローを必須とし自動適用を停止しなければならない
- REQ-103: マイグレーション実行時にDBロックが発生した場合、システムは タイムアウト設定に従って処理を中止しなければならない

### 状態要件

- REQ-201: デプロイ実行中の状態にある場合、システムは 重複実行を防止し待機キューに登録しなければならない

### オプション要件

- オプション要件はない

### 制約要件

- REQ-401: システムは AWS IAM最小権限原則に従ったロール設計を実装しなければならない
- REQ-402: システムは シークレット情報をソースコードに含めてはならない
- REQ-403: システムは データベースマイグレーションでのロールバック非対応（Forward-onlyポリシー）を遵守しなければならない

## 非機能要件

### セキュリティ

- NFR-001: GitHub OIDC + IAM条件付きロールによる認証を実装すること
- NFR-002: Terraform state ファイルを暗号化ストレージ（S3+KMS）に保存すること  
- NFR-003: Supabase RLS（Row-Level Security）を必須とすること
- NFR-004: Secret Scanning を有効化し機密情報漏洩を防止すること

### 監査・ログ

- NFR-005: デプロイ操作の基本ログ（実行者・日時・対象）を記録すること

## Edgeケース

### インフラストラクチャエラー

- EDGE-001: AWS API制限超過時は指数バックオフで再試行し、最大5回まで実行
- EDGE-002: Terraform state ロック競合時は最大10分間待機後、強制ロック解除オプションを提供

### データベース関連

- EDGE-101: マイグレーション中の長時間トランザクション検出時は管理者アラートと手動介入オプションを提供

### 認証・認可エラー

- EDGE-201: GitHub OIDC トークン期限切れ時は自動リフレッシュと再試行を実行

## 受け入れ基準

### 基盤構築テスト

- [ ] Terraform による AWS、CloudFlare リソース作成が成功すること
- [ ] GitHub OIDC認証でAWS/CloudFlare/Supabaseアクセスが成功すること
- [ ] IAM ロール最小権限設定が適切に機能すること
- [ ] Secrets 管理が GitHub Environment 単位で動作すること

### デプロイフローテスト

- [ ] main ブランチプッシュで全サービスが正常順序でデプロイされること
- [ ] プルリクエストでプレビュー環境が自動生成されること
- [ ] マイグレーション時DBロック発生でタイムアウト処理が動作すること

### 品質保証テスト

- [ ] Terraform plan で破壊的変更検出時に承認フローが動作すること
- [ ] データベースマイグレーション失敗時に適切にエラー処理されること
- [ ] 同時デプロイ実行時に待機キューが正常動作すること

### 監査・ログテスト

- [ ] デプロイ操作の基本ログ（実行者・日時・対象）が記録されること
- [ ] Secret Scanning でのソースコード機密情報検出が動作すること

### エラーハンドリングテスト

- [ ] AWS API制限超過時の指数バックオフ再試行が動作すること
- [ ] Terraform state ロック競合時の解決手順が提供されること
- [ ] データベース長時間トランザクション時のアラート機能が動作すること
- [ ] GitHub OIDC トークン期限切れ時の自動更新が動作すること

### セキュリティテスト

- [ ] シークレットレス認証（GitHub OIDC）が全サービスで動作すること
- [ ] Terraform state の暗号化保存が実装されること
- [ ] Supabase RLS が適切に設定されること
