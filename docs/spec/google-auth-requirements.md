# Supabase Google認証 要件定義書

## 概要

Supabaseを認証基盤として活用し、Googleアカウントによるソーシャルログイン機能を実装する。
ユーザーはGoogleアカウントを使用してワンクリックでアプリケーションにログインでき、安全で快適な認証体験を提供する。

## ユーザストーリー

### ストーリー1: Googleアカウントログイン

- **である** アプリケーション利用者 **として**
- **私は** Googleアカウントを使ってワンクリックでログイン **をしたい**
- **そうすることで** 新しいアカウント作成やパスワード記憶の手間を省き、すぐにサービスを利用できる

### ストーリー2: 安全なログアウト

- **である** 認証済みユーザー **として**
- **私は** アプリケーションから安全にログアウト **をしたい**
- **そうすることで** セキュリティを保ちながら他者との端末共有ができる

### ストーリー3: 認証状態の確認

- **である** アプリケーション利用者 **として**
- **私は** 自分のログイン状態を確認 **をしたい**
- **そうすることで** 認証が必要なページにアクセスする際の混乱を避けられる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムはGoogleOAuth2.0プロバイダーを通じてユーザー認証を行わなければならない
- REQ-002: システムはSupabaseAuthを使用してセッション管理を行わなければならない
- REQ-003: システムは認証済みユーザーの基本プロフィール情報（名前、メールアドレス、アバター画像）を取得しなければならない
- REQ-004: システムはログアウト機能を提供しなければならない
- REQ-005: システムは認証状態をリアルタイムで監視し、UIに反映しなければならない

### 条件付き要件

- REQ-101: ユーザーが未認証の場合、システムはGoogleログインボタンを表示しなければならない
- REQ-102: ユーザーがGoogleログインボタンをクリックした場合、システムはGoogleの認証フローにリダイレクトしなければならない
- REQ-103: Google認証が成功した場合、システムはユーザーをアプリケーションのメインページにリダイレクトしなければならない
- REQ-104: ユーザーが認証済みの場合、システムはユーザー情報とログアウトボタンを表示しなければならない
- REQ-105: ユーザーがログアウトボタンをクリックした場合、システムはセッションを終了し、未認証状態に戻さなければならない

### 状態要件

- REQ-201: 認証処理中の場合、システムはローディング状態を表示しなければならない
- REQ-202: 認証エラーが発生している場合、システムは適切なエラーメッセージを表示しなければならない
- REQ-203: セッションが期限切れの場合、システムは自動的にログアウト処理を実行しなければならない

### オプション要件

- REQ-301: システムはユーザーのログイン履歴を記録してもよい
- REQ-302: システムは「ログイン状態を保持する」オプションを提供してもよい
- REQ-303: システムは他のソーシャルログインプロバイダー（GitHub、Twitter等）を追加してもよい

### 制約要件

- REQ-401: システムはSupabaseの認証機能のみを使用しなければならない
- REQ-402: システムはGoogleのOAuth2.0仕様に準拠しなければならない
- REQ-403: システムはユーザーのパスワードを保存してはならない
- REQ-404: システムは認証トークンを適切に暗号化して保存しなければならない

## 非機能要件

### パフォーマンス

- NFR-001: 認証フローは5秒以内に完了しなければならない
- NFR-002: 認証状態の確認は1秒以内に完了しなければならない
- NFR-003: ページ遷移時の認証チェックはUX阻害を起こしてはならない

### セキュリティ

- NFR-101: すべての認証通信はHTTPS経由で行われなければならない
- NFR-102: 認証トークンはSecureフラグ付きCookieまたはセキュアストレージに保存されなければならない
- NFR-103: CSRFトークンによる攻撃防止機能を実装しなければならない
- NFR-104: セッション固定攻撃に対する保護機能を実装しなければならない

### ユーザビリティ

- NFR-201: Googleログインボタンは直感的で分かりやすいデザインでなければならない
- NFR-202: 認証エラーは分かりやすい日本語で表示されなければならない
- NFR-203: モバイルデバイスでも快適に操作できなければならない
- NFR-204: アクセシビリティ（WCAG 2.1 AA準拠）に配慮されなければならない

### 可用性

- NFR-301: 認証システムの可用性は99.9%以上でなければならない
- NFR-302: Googleサービス障害時の適切なフォールバック機能を提供しなければならない

## Edgeケース

### エラー処理

- EDGE-001: Googleアカウントアクセス拒否時は適切なメッセージを表示し、再試行を促す
- EDGE-002: ネットワークエラー発生時は一定回数のリトライを実行する
- EDGE-003: Supabaseサービス障害時は適切な障害メッセージを表示する
- EDGE-004: 未対応ブラウザ使用時は代替認証方法を案内する

### 境界値

- EDGE-101: セッション期限（デフォルト24時間）到達時の自動ログアウト処理
- EDGE-102: 同時ログインセッション数の上限（設定値）到達時の古いセッション無効化
- EDGE-103: 認証試行回数の上限到達時の一時的なアカウントロック

### 特殊状況

- EDGE-201: ユーザーがGoogle側でアカウントを削除した場合の処理
- EDGE-202: 複数タブで同時ログアウトした場合の状態同期
- EDGE-203: ページリロード時の認証状態復元処理

## 受け入れ基準

### 機能テスト

- [ ] GoogleログインボタンをクリックしてGoogle認証ページに遷移できる
- [ ] Googleアカウントでログイン後、アプリケーションに戻ってこれる  
- [ ] 認証後にユーザー名、メールアドレス、アバター画像が表示される
- [ ] ログアウトボタンをクリックして正常にログアウトできる
- [ ] ログアウト後、認証が必要なページにアクセスできない
- [ ] ページリロード後も認証状態が維持される
- [ ] セッション期限切れ時に自動ログアウトされる

### セキュリティテスト

- [ ] HTTPS通信でのみ認証処理が行われる
- [ ] 認証トークンが適切に暗号化されて保存される
- [ ] CSRF攻撃に対して適切に防御される
- [ ] XSS攻撃に対して適切に防御される

### ユーザビリティテスト

- [ ] モバイルデバイスでスムーズに認証できる
- [ ] 認証エラー時に分かりやすいメッセージが表示される
- [ ] ローディング状態が適切に表示される
- [ ] アクセシビリティガイドラインに準拠している

### パフォーマンステスト

- [ ] 認証フローが5秒以内に完了する
- [ ] 認証状態確認が1秒以内に完了する
- [ ] 同時接続100ユーザーでも正常に動作する

## 技術実装要件

### フロントエンド（Next.js）

- Supabase JavaScript SDKの導入
- 認証状態管理（Context API またはRedux）
- 認証ガード機能の実装
- UI コンポーネント（ログインボタン、ユーザープロファイル）

### バックエンド設定

- Supabase プロジェクトのセットアップ
- Google OAuth アプリケーションの設定
- 環境変数の設定（API キー、リダイレクトURL）
- RLS（Row Level Security）ポリシーの設定

### 依存関係

- @supabase/supabase-js
- 適切な型定義ファイル
- 環境変数管理ライブラリ