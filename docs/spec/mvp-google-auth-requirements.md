# MVP Google認証（バックエンドAPI経由 + DDD学習） 要件定義書

## 概要

SupabaseとGoogle OAuthを使用した認証機能を、バックエンドAPI経由で実装し、DDD（ドメイン駆動設計）+ クリーンアーキテクチャの学習を目的とする。フロントエンドでGoogle認証を実行後、取得したJWTをバックエンドAPIで検証し、ドメイン層でユーザー管理を行う構成とする。学習効果を最大化するため3-4時間の実装時間を想定する。

## ユーザストーリー

### ストーリー1: Googleアカウントでログイン

- **である** アプリケーション利用者 **として**
- **私は** Googleアカウントを使ってワンクリックでログイン **をしたい**
- **そうすることで** 面倒な会員登録なしにすぐアプリを使い始められる

### ストーリー2: バックエンドAPIでのユーザー情報取得

- **である** ログイン済みユーザー **として**
- **私は** バックエンドAPIから自分のユーザー情報を取得して画面に表示される **ことを確認したい**
- **そうすることで** フロントエンドとバックエンドが正常に連携できていることがわかる

### ストーリー3: ログアウト

- **である** ログイン済みユーザー **として**
- **私は** 簡単にログアウト **をしたい**
- **そうすることで** セッションを終了して安心できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: フロントエンドはSupabase AuthとGoogle OAuth 2.0を使用してJWT取得を行わなければならない
- REQ-002: バックエンドはJWTを検証してユーザー認証を行わなければならない
- REQ-003: バックエンドはDDDアーキテクチャでユーザードメインを管理しなければならない
- REQ-004: システムはJIT（Just-In-Time）プロビジョニングでユーザー作成を行わなければならない
- REQ-005: バックエンドAPIは認証済みユーザーのプロフィール情報を返却しなければならない
- REQ-006: システムはログアウト機能を提供しなければならない

### 条件付き要件

- REQ-101: ユーザーが未認証の場合、システムはGoogleログインボタンを表示しなければならない
- REQ-102: ユーザーがGoogleログインボタンをクリックした場合、システムはGoogleの認証フローにリダイレクトしなければならない
- REQ-103: Google認証が成功した場合、システムはユーザーをアプリケーションのメインページにリダイレクトしなければならない
- REQ-104: ユーザーが認証済みの場合、システムはユーザー情報とログアウトボタンを表示しなければならない
- REQ-105: ユーザーがログアウトボタンをクリックした場合、システムはセッションを終了し、未認証状態に戻さなければならない

### 状態要件

- REQ-201: 認証処理中の場合、システムはローディング状態を表示しなければならない
- REQ-202: 認証エラーが発生している場合、システムは基本的なエラーメッセージを表示しなければならない

### オプション要件

- REQ-301: システムは「ログイン状態を保持する」機能を提供してもよい（Supabaseデフォルト動作）

### 制約要件

- REQ-401: フロントエンドはSupabase AuthのJavaScript SDKを使用しなければならない
- REQ-402: バックエンドはHono フレームワークを使用しなければならない
- REQ-403: バックエンドはDDD + クリーンアーキテクチャパターンを適用しなければならない
- REQ-404: バックエンドは独自のPostgreSQLテーブルを使用してユーザー管理を行わなければならない
- REQ-405: DBのテーブル名には、接頭辞を環境変数で付与できるようにしなければならない
- REQ-406: システムはGoogleのOAuth2.0仕様に準拠しなければならない
- REQ-407: バックエンドは以下の層構造を実装しなければならない：
  - Presentation層（HTTP controllers, middleware）
  - Application層（Use cases, Application services）
  - Domain層（Entities, Aggregates, Domain services）
  - Infrastructure層（Repository implementations, External services）

## 非機能要件

### パフォーマンス

- NFR-001: 認証フローは10秒以内に完了しなければならない
- NFR-002: バックエンドAPIの認証チェックは1秒以内に完了しなければならない
- NFR-003: JIT プロビジョニングは2秒以内に完了しなければならない

### セキュリティ

- NFR-101: すべての認証通信はHTTPS経由で行われなければならない（Supabaseが自動対応）
- NFR-102: 認証トークンはSupabaseが管理するSecure Cookieに保存されなければならない

### ユーザビリティ

- NFR-201: Googleログインボタンは見つけやすい位置に配置されなければならない
- NFR-202: 認証エラーは理解しやすい日本語で表示されなければならない
- NFR-203: モバイルデバイスでも認証フローが動作しなければならない

### 開発効率・学習効果

- NFR-301: 実装は4時間以内に完了しなければならない（DDD学習込み）
- NFR-302: DDD + クリーンアーキテクチャの各層が明確に分離されていなければならない
- NFR-303: 外部依存関係は学習目的に必要な範囲で使用してもよい
- NFR-304: ドメイン層はビジネスロジックのみを含み、技術的関心事を含んではならない

## Edgeケース

### エラー処理

- EDGE-001: Googleアカウントアクセス拒否時は「認証がキャンセルされました」メッセージを表示する
- EDGE-002: JWT検証失敗時はバックエンドが401エラーを返却する
- EDGE-003: バックエンドAPI通信エラー時は「APIサーバーとの通信に失敗しました」メッセージを表示する
- EDGE-004: Supabaseサービス障害時は「認証サービスが一時的に利用できません」メッセージを表示する

### 境界値

- EDGE-101: 長いユーザー名（50文字以上）の場合は適切に省略表示する
- EDGE-102: アバター画像が取得できない場合はデフォルト画像を表示する

### 特殊状況

- EDGE-201: ページリロード時の認証状態復元処理を正しく行う
- EDGE-202: 複数タブでの認証状態同期は考慮しない（今回のMVPでは対象外）

## 受け入れ基準

### 機能テスト

- [ ] GoogleログインボタンをクリックしてGoogle認証ページに遷移できる
- [ ] Googleアカウントでログイン後、元のページに戻ってこれる
- [ ] JWT検証を正常に実行できる
- [ ] ユーザー情報を取得して画面に表示される
- [ ] ログアウトボタンをクリックして正常にログアウトできる
- [ ] ログアウト後、再度ログインボタンが表示される
- [ ] ページリロード後も認証状態が維持される

### セキュリティテスト

- [ ] HTTPS通信でのみ認証処理が行われる
- [ ] 認証トークンが適切にブラウザに保存される

### ユーザビリティテスト

- [ ] モバイルデバイスでスムーズに認証できる
- [ ] 認証エラー時に分かりやすいメッセージが表示される
- [ ] ローディング状態が適切に表示される

### DDD学習効果テスト

- [ ] 実装時間が4時間以内である（学習込み）
- [ ] Domain層が技術的関心事から分離されている
- [ ] UserAggregateが適切にビジネスルールを管理している  
- [ ] Application層がUse Caseを明確に表現している
- [ ] Infrastructure層がDomain層に依存していない（依存性逆転）
- [ ] 各層の責務が明確に分離されている

## 技術実装要件

### フロントエンド（Next.js）

- Supabase JavaScript SDKの導入（@supabase/supabase-js）
- JWT取得とバックエンドAPI通信機能
- 認証状態管理（Context API またはRedux）
- UIコンポーネント（ログインボタン、ユーザープロファイル表示）

### バックエンド（Hono API + PostgreSQL）

- Hono フレームワーク
- JWT検証ミドルウェア（Supabase JWT Secret使用）
- DDD + クリーンアーキテクチャの層構造実装：
  - Presentation層: HTTP controllers, middleware
  - Application層: Use cases, Application services
  - Domain層: User entity, UserAggregate, Domain services
  - Infrastructure層: PostgreSQL repository, Supabase client
- ユーザー管理用PostgreSQLテーブル
- JIT プロビジョニング機能

### 環境設定

- Supabaseプロジェクトのセットアップ
- Google OAuth アプリケーションの設定
- PostgreSQL データベースのセットアップ
- 環境変数：
  - フロントエンド: NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY
  - バックエンド: SUPABASE_JWT_SECRET, DATABASE_URL

### 依存関係

- フロントエンド: @supabase/supabase-js, Next.js 15, Tailwind CSS
- バックエンド: Hono, PostgreSQL client, JWT verification library

## DDD学習のポイント

今回のMVPで習得できるDDD + クリーンアーキテクチャの要素：

### Domain層
- **User Entity**: ユーザーの基本属性とビジネスルール
- **UserAggregate**: ユーザー作成・更新の整合性管理
- **Domain Services**: 認証ドメインロジック（必要に応じて）

### Application層  
- **AuthenticateUserUseCase**: JWT検証→ユーザー作成・取得の流れ
- **GetUserProfileUseCase**: 認証済みユーザー情報の取得
- **Application Services**: 横断的関心事の調整

### Infrastructure層
- **UserRepository**: PostgreSQLでのユーザーデータ永続化
- **SupabaseAuthProvider**: JWT検証の外部サービス連携
- **依存性注入**: 抽象化インターフェースの実装

### Presentation層
- **AuthController**: HTTP リクエスト/レスポンスの処理
- **AuthMiddleware**: リクエスト前のJWT検証処理

## MVP後の拡張予定（対象外）

以下は今回のMVPでは実装せず、将来的な拡張として考慮する：

- 監査ログ機能（auth_logs テーブル）
- セッション管理機能（user_sessions テーブル）  
- 権限管理機能（RBAC）
- イベントソーシング（domain_events テーブル）
- 複数認証プロバイダー対応
- 高度なセキュリティ機能
