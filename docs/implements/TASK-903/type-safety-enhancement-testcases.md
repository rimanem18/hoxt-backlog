# TDDテストケース一覧: ユーザー管理エンドポイントのOpenAPI対応化

**作成日**: 2025-10-19
**タスクID**: TASK-903
**機能名**: ユーザー管理エンドポイントのOpenAPI対応化

---

## 開発言語・フレームワーク

### 🟢 信頼性レベル: 青信号（プロジェクトCLAUDE.mdとpackage.jsonに基づく）

- **プログラミング言語**: TypeScript 5.9.2
  - **言語選択の理由**: プロジェクト全体でTypeScriptを採用しており、型安全性を最大限活用できる
  - **テストに適した機能**: 型推論によるテストデータの型安全性、Zodスキーマの型定義活用

- **テストフレームワーク**: Bun標準テストランナー
  - **フレームワーク選択の理由**: プロジェクトCLAUDE.mdで「必須: テストはBun標準を使用する」と明記
  - **テスト実行環境**: Dockerコンテナ内（`docker compose exec server bun test`）

---

## テストケースの概要

### テストの分類構成

1. **単体テスト**: OpenAPIルート定義の検証（3エンドポイント）（9ケース）
2. **統合テスト**: ユーザー管理APIの全体フロー検証（27ケース）
3. **境界値テスト**: 入力値の境界条件検証（6ケース）

**合計**: 42テストケース

---

## 1. 正常系テストケース（基本的な動作）

### エンドポイント共通: OpenAPIルート定義の正常登録

#### 1-1. GET /users/{id} のOpenAPIルート定義が正常に登録される

**🟢 信頼性レベル: 青信号（@hono/zod-openapiの公式ドキュメントに基づく）**

- **テスト名**: GET /users/{id} のOpenAPIルートが正常に登録される
  - **何をテストするか**: `app.openapi(createRoute(...))`でルートが正常に登録されること
  - **期待される動作**: ルート定義がHonoアプリに登録され、OpenAPI仕様に含まれる

- **入力値**:
  ```typescript
  createRoute({
    method: 'get',
    path: '/users/{id}',
    request: {
      params: z.object({ id: z.string().uuid() }),
    },
    responses: {
      200: {
        content: {
          'application/json': {
            schema: getUserResponseSchema,
          },
        },
        description: 'ユーザー情報取得成功',
      },
    },
  })
  ```
  - **入力データの意味**: OpenAPIルート定義オブジェクト。Zodスキーマでパスパラメータとレスポンスを定義

- **期待される結果**: ルート定義が正常に登録され、エラーが発生しない
  - **期待結果の理由**: @hono/zod-openapiの仕様に従った正しいルート定義であるため

- **テストの目的**: OpenAPIルート定義の基本的な動作確認
  - **確認ポイント**: createRouteの戻り値が正常にapp.openapiに渡されること

#### 1-2. GET /users のOpenAPIルート定義が正常に登録される

**🟢 信頼性レベル: 青信号（@hono/zod-openapiの公式ドキュメントに基づく）**

- **テスト名**: GET /users のOpenAPIルートが正常に登録される
  - **何をテストするか**: クエリパラメータを含むルート定義が正常に登録されること
  - **期待される動作**: ページネーション・フィルタリングパラメータがOpenAPI仕様に含まれる

- **入力値**:
  ```typescript
  createRoute({
    method: 'get',
    path: '/users',
    request: {
      query: listUsersQuerySchema,
    },
    responses: {
      200: {
        content: {
          'application/json': {
            schema: listUsersResponseSchema,
          },
        },
        description: 'ユーザー一覧取得成功',
      },
    },
  })
  ```
  - **入力データの意味**: クエリパラメータ（provider, limit, offset）を含むルート定義

- **期待される結果**: ルート定義が正常に登録され、エラーが発生しない
  - **期待結果の理由**: クエリパラメータが正しくZodスキーマで定義されているため

- **テストの目的**: クエリパラメータを含むOpenAPIルート定義の確認
  - **確認ポイント**: listUsersQuerySchemaがクエリパラメータとして認識されること

#### 1-3. PUT /users/{id} のOpenAPIルート定義が正常に登録される

**🟢 信頼性レベル: 青信号（@hono/zod-openapiの公式ドキュメントに基づく）**

- **テスト名**: PUT /users/{id} のOpenAPIルートが正常に登録される
  - **何をテストするか**: パスパラメータとボディを含むルート定義が正常に登録されること
  - **期待される動作**: 更新リクエストボディとレスポンススキーマがOpenAPI仕様に含まれる

- **入力値**:
  ```typescript
  createRoute({
    method: 'put',
    path: '/users/{id}',
    request: {
      params: z.object({ id: z.string().uuid() }),
      body: {
        content: {
          'application/json': {
            schema: updateUserBodySchema,
          },
        },
      },
    },
    responses: {
      200: {
        content: {
          'application/json': {
            schema: updateUserResponseSchema,
          },
        },
        description: 'ユーザー情報更新成功',
      },
    },
  })
  ```
  - **入力データの意味**: パスパラメータとボディスキーマを含むルート定義

- **期待される結果**: ルート定義が正常に登録され、エラーが発生しない
  - **期待結果の理由**: パスパラメータとボディが正しく定義されているため

- **テストの目的**: 複数の入力スキーマを含むOpenAPIルート定義の確認
  - **確認ポイント**: パスパラメータとボディスキーマの両方が認識されること

### GET /users/{id} の正常系

#### 1-4. ユーザー情報取得成功（Google認証ユーザー）

**🟢 信頼性レベル: 青信号（要件定義書のシナリオ1に基づく）**

- **テスト名**: 有効なUUID v4でユーザー情報が正常に取得される
  - **何をテストするか**: JWKS認証成功後、ユーザーIDでユーザー情報が取得されること
  - **期待される動作**: GetUserUseCaseが呼ばれ、ユーザー情報がレスポンスされる

- **入力値**:
  ```http
  GET /users/550e8400-e29b-41d4-a716-446655440000
  Authorization: Bearer <valid_jwt_token>
  ```
  - **入力データの意味**: 有効なUUID v4形式のユーザーID
  - **実際の発生シナリオ**: フロントエンドがログインユーザーの詳細情報を取得する場合

- **期待される結果**:
  ```json
  {
    "success": true,
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "externalId": "google-1234567890",
      "provider": "google",
      "email": "user@example.com",
      "name": "User Name",
      "avatarUrl": "https://lh3.googleusercontent.com/a/default-user",
      "createdAt": "2025-10-19T10:00:00Z",
      "updatedAt": "2025-10-19T10:00:00Z",
      "lastLoginAt": "2025-10-19T10:00:00Z"
    }
  }
  ```
  - **期待結果の理由**: 有効なJWTトークンとUUID v4形式のIDで正常にユーザーが取得される
  - **HTTPステータス**: 200 OK

- **テストの目的**: ユーザー情報取得の正常フローを確認
  - **確認ポイント**:
    - JWKS認証ミドルウェアが成功すること
    - パスパラメータのZodバリデーションが成功すること
    - GetUserUseCaseが正しい引数で呼ばれること
    - レスポンススキーマがgetUserResponseSchemaに一致すること

#### 1-5. ユーザー情報取得成功（GitHub認証ユーザー、avatarUrlなし）

**🟢 信頼性レベル: 青信号（要件定義書に基づく）**

- **テスト名**: avatarUrlがnullのユーザー情報が正常に取得される
  - **何をテストするか**: avatarUrlがnullでも正常にレスポンスが返ること
  - **期待される動作**: avatarUrlがnullのユーザーデータがそのまま返される

- **入力値**:
  ```http
  GET /users/660e8400-e29b-41d4-a716-446655440001
  Authorization: Bearer <valid_jwt_token>
  ```
  - **入力データの意味**: avatarUrlがnullのユーザーのUUID
  - **実際の発生シナリオ**: アバター画像を設定していないユーザーの情報を取得する場合

- **期待される結果**:
  ```json
  {
    "success": true,
    "data": {
      "id": "660e8400-e29b-41d4-a716-446655440001",
      "externalId": "github-existing-user",
      "provider": "github",
      "email": "existinguser@example.com",
      "name": "Existing User",
      "avatarUrl": null,
      "createdAt": "2025-10-10T10:00:00Z",
      "updatedAt": "2025-10-18T10:00:00Z",
      "lastLoginAt": "2025-10-18T10:00:00Z"
    }
  }
  ```
  - **期待結果の理由**: avatarUrlがnullでも型定義上有効（nullable）なため正常にレスポンスされる
  - **HTTPステータス**: 200 OK

- **テストの目的**: nullable フィールドの正常動作確認
  - **確認ポイント**: avatarUrlがnullでもレスポンススキーマバリデーションが成功すること

### GET /users の正常系

#### 1-6. ユーザー一覧取得成功（デフォルトパラメータ）

**🟢 信頼性レベル: 青信号（要件定義書のシナリオ2に基づく）**

- **テスト名**: クエリパラメータなしでユーザー一覧が取得される（デフォルト値適用）
  - **何をテストするか**: クエリパラメータ省略時にデフォルト値（limit=20, offset=0）が適用されること
  - **期待される動作**: ListUsersUseCaseが呼ばれ、最大20件のユーザー一覧がレスポンスされる

- **入力値**:
  ```http
  GET /users
  Authorization: Bearer <valid_jwt_token>
  ```
  - **入力データの意味**: クエリパラメータなし（デフォルト値適用）
  - **実際の発生シナリオ**: 管理画面でユーザー一覧の初回表示

- **期待される結果**:
  ```json
  {
    "success": true,
    "data": {
      "users": [
        {
          "id": "550e8400-e29b-41d4-a716-446655440000",
          "externalId": "google-1234567890",
          "provider": "google",
          "email": "user1@example.com",
          "name": "User 1",
          "avatarUrl": "https://example.com/avatar1.jpg",
          "createdAt": "2025-10-19T10:00:00Z",
          "updatedAt": "2025-10-19T10:00:00Z",
          "lastLoginAt": "2025-10-19T10:00:00Z"
        }
      ],
      "total": 150,
      "limit": 20,
      "offset": 0
    }
  }
  ```
  - **期待結果の理由**: デフォルト値（limit=20, offset=0）が適用され、最大20件が返される
  - **HTTPステータス**: 200 OK

- **テストの目的**: デフォルトパラメータの適用確認
  - **確認ポイント**:
    - limitが20として適用されること
    - offsetが0として適用されること
    - レスポンスにusers配列、total、limit、offsetが含まれること

#### 1-7. ユーザー一覧取得成功（プロバイダーフィルタリング）

**🟢 信頼性レベル: 青信号（要件定義書に基づく）**

- **テスト名**: プロバイダーでフィルタリングしたユーザー一覧が取得される
  - **何をテストするか**: provider クエリパラメータで特定プロバイダーのユーザーのみが取得されること
  - **期待される動作**: 指定されたプロバイダーのユーザーのみが返される

- **入力値**:
  ```http
  GET /users?provider=google
  Authorization: Bearer <valid_jwt_token>
  ```
  - **入力データの意味**: Googleアカウントでログインしたユーザーのみを取得
  - **実際の発生シナリオ**: 管理画面でプロバイダー別のユーザー統計を表示する場合

- **期待される結果**:
  ```json
  {
    "success": true,
    "data": {
      "users": [
        {
          "provider": "google",
          ...
        }
      ],
      "total": 50,
      "limit": 20,
      "offset": 0
    }
  }
  ```
  - **期待結果の理由**: provider=googleでフィルタリングされ、Googleユーザーのみが返される
  - **HTTPステータス**: 200 OK

- **テストの目的**: プロバイダーフィルタリング機能の確認
  - **確認ポイント**:
    - クエリパラメータがZodバリデーションを通過すること
    - ListUsersUseCaseにproviderフィルターが渡されること
    - レスポンスのすべてのユーザーが指定プロバイダーであること

#### 1-8. ユーザー一覧取得成功（ページネーション）

**🟢 信頼性レベル: 青信号（要件定義書に基づく）**

- **テスト名**: ページネーションパラメータで指定ページのユーザー一覧が取得される
  - **何をテストするか**: limit と offset パラメータでページネーションが正常に動作すること
  - **期待される動作**: 指定されたoffsetから指定されたlimit件数のユーザーが返される

- **入力値**:
  ```http
  GET /users?limit=10&offset=20
  Authorization: Bearer <valid_jwt_token>
  ```
  - **入力データの意味**: 21〜30件目のユーザーを取得
  - **実際の発生シナリオ**: 管理画面でユーザー一覧の2ページ目を表示する場合

- **期待される結果**:
  ```json
  {
    "success": true,
    "data": {
      "users": [ /* 10件のユーザー */ ],
      "total": 150,
      "limit": 10,
      "offset": 20
    }
  }
  ```
  - **期待結果の理由**: offset=20から10件が返される
  - **HTTPステータス**: 200 OK

- **テストの目的**: ページネーション機能の確認
  - **確認ポイント**:
    - limitとoffsetがZodバリデーションを通過すること
    - レスポンスのusers配列が最大10件であること
    - レスポンスのlimitとoffsetが要求値と一致すること

### PUT /users/{id} の正常系

#### 1-9. ユーザー情報更新成功（名前のみ更新）

**🟢 信頼性レベル: 青信号（要件定義書のシナリオ3に基づく）**

- **テスト名**: 名前のみ更新してユーザー情報が正常に更新される
  - **何をテストするか**: nameフィールドのみを含むリクエストでユーザー情報が更新されること
  - **期待される動作**: UpdateUserUseCaseが呼ばれ、nameのみが更新される

- **入力値**:
  ```http
  PUT /users/550e8400-e29b-41d4-a716-446655440000
  Authorization: Bearer <valid_jwt_token>
  {
    "name": "Updated User Name"
  }
  ```
  - **入力データの意味**: 名前のみを更新するリクエストボディ
  - **実際の発生シナリオ**: ユーザーがプロフィール編集画面で名前のみを変更した場合

- **期待される結果**:
  ```json
  {
    "success": true,
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "externalId": "google-1234567890",
      "provider": "google",
      "email": "user@example.com",
      "name": "Updated User Name",
      "avatarUrl": "https://example.com/avatar.jpg",
      "createdAt": "2025-10-19T10:00:00Z",
      "updatedAt": "2025-10-19T11:00:00Z",
      "lastLoginAt": "2025-10-19T10:00:00Z"
    }
  }
  ```
  - **期待結果の理由**: nameのみが更新され、他のフィールドは変更されない
  - **HTTPステータス**: 200 OK

- **テストの目的**: 部分更新（nameのみ）の確認
  - **確認ポイント**:
    - ボディのZodバリデーションが成功すること
    - nameのみが更新されること
    - updatedAtが更新されること
    - 他のフィールドが変更されないこと

#### 1-10. ユーザー情報更新成功（avatarUrlのみ更新）

**🟢 信頼性レベル: 青信号（要件定義書に基づく）**

- **テスト名**: avatarUrlのみ更新してユーザー情報が正常に更新される
  - **何をテストするか**: avatarUrlフィールドのみを含むリクエストでユーザー情報が更新されること
  - **期待される動作**: UpdateUserUseCaseが呼ばれ、avatarUrlのみが更新される

- **入力値**:
  ```http
  PUT /users/550e8400-e29b-41d4-a716-446655440000
  Authorization: Bearer <valid_jwt_token>
  {
    "avatarUrl": "https://example.com/new-avatar.jpg"
  }
  ```
  - **入力データの意味**: アバターURLのみを更新するリクエストボディ
  - **実際の発生シナリオ**: ユーザーがプロフィール画像のみを変更した場合

- **期待される結果**:
  ```json
  {
    "success": true,
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "externalId": "google-1234567890",
      "provider": "google",
      "email": "user@example.com",
      "name": "User Name",
      "avatarUrl": "https://example.com/new-avatar.jpg",
      "createdAt": "2025-10-19T10:00:00Z",
      "updatedAt": "2025-10-19T11:00:00Z",
      "lastLoginAt": "2025-10-19T10:00:00Z"
    }
  }
  ```
  - **期待結果の理由**: avatarUrlのみが更新され、他のフィールドは変更されない
  - **HTTPステータス**: 200 OK

- **テストの目的**: 部分更新（avatarUrlのみ）の確認
  - **確認ポイント**:
    - ボディのZodバリデーションが成功すること
    - avatarUrlのみが更新されること
    - updatedAtが更新されること

#### 1-11. ユーザー情報更新成功（名前とavatarUrlを同時更新）

**🟢 信頼性レベル: 青信号（要件定義書に基づく）**

- **テスト名**: 名前とavatarUrlを同時に更新してユーザー情報が正常に更新される
  - **何をテストするか**: 複数フィールドを含むリクエストでユーザー情報が更新されること
  - **期待される動作**: UpdateUserUseCaseが呼ばれ、nameとavatarUrlの両方が更新される

- **入力値**:
  ```http
  PUT /users/550e8400-e29b-41d4-a716-446655440000
  Authorization: Bearer <valid_jwt_token>
  {
    "name": "Updated User Name",
    "avatarUrl": "https://example.com/new-avatar.jpg"
  }
  ```
  - **入力データの意味**: 名前とアバターURLの両方を更新するリクエストボディ
  - **実際の発生シナリオ**: ユーザーがプロフィール編集画面で複数項目を一度に変更した場合

- **期待される結果**:
  ```json
  {
    "success": true,
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "externalId": "google-1234567890",
      "provider": "google",
      "email": "user@example.com",
      "name": "Updated User Name",
      "avatarUrl": "https://example.com/new-avatar.jpg",
      "createdAt": "2025-10-19T10:00:00Z",
      "updatedAt": "2025-10-19T11:00:00Z",
      "lastLoginAt": "2025-10-19T10:00:00Z"
    }
  }
  ```
  - **期待結果の理由**: nameとavatarUrlの両方が更新される
  - **HTTPステータス**: 200 OK

- **テストの目的**: 複数フィールドの同時更新確認
  - **確認ポイント**:
    - ボディのZodバリデーションが成功すること
    - nameとavatarUrlの両方が更新されること
    - updatedAtが更新されること

---

## 2. 異常系テストケース（エラーハンドリング）

### GET /users/{id} の異常系

#### 2-1. パスパラメータが不正なUUID形式（EDGE-001）

**🟢 信頼性レベル: 青信号（要件定義書のEDGE-001に基づく）**

- **テスト名**: パスパラメータが不正なUUID形式の場合、400エラーが返る
  - **エラーケースの概要**: UUID v4形式に準拠しないIDが送信された場合
  - **エラー処理の重要性**: 不正なIDでのDB検索を防ぎ、パフォーマンスを維持する

- **入力値**:
  ```http
  GET /users/invalid-uuid
  Authorization: Bearer <valid_jwt_token>
  ```
  - **不正な理由**: "invalid-uuid"はUUID v4形式（8-4-4-4-12桁のハイフン区切り16進数）に準拠していない
  - **実際の発生シナリオ**: クライアント側のバグで不正なIDが送信された場合

- **期待される結果**:
  ```json
  {
    "success": false,
    "error": {
      "code": "VALIDATION_ERROR",
      "message": "バリデーションエラー",
      "details": {
        "id": "有効なUUID v4形式である必要があります"
      }
    }
  }
  ```
  - **エラーメッセージの内容**: UUID形式制約違反を明示
  - **システムの安全性**: 不正なIDでのDB検索が実行されない
  - **HTTPステータス**: 400 Bad Request

- **テストの目的**: パスパラメータのUUIDバリデーション確認
  - **品質保証の観点**: 入力値検証、パフォーマンス維持

#### 2-2. JWKS検証失敗（EDGE-005）

**🟢 信頼性レベル: 青信号（要件定義書のEDGE-005に基づく）**

- **テスト名**: JWKS検証失敗時に401エラーが返る
  - **エラーケースの概要**: JWT署名検証に失敗した場合
  - **エラー処理の重要性**: 不正なJWTによるアクセスを防ぐ

- **入力値**:
  ```http
  GET /users/550e8400-e29b-41d4-a716-446655440000
  Authorization: Bearer <invalid_jwt_token>
  ```
  - **不正な理由**: JWT署名が不正、またはkidが見つからない
  - **実際の発生シナリオ**: 改ざんされたJWT、期限切れのJWT、無効なkid

- **期待される結果**:
  ```json
  {
    "success": false,
    "error": {
      "code": "UNAUTHORIZED",
      "message": "JWKS検証に失敗しました"
    }
  }
  ```
  - **エラーメッセージの内容**: JWKS検証失敗を明示
  - **システムの安全性**: 不正なJWTによるアクセスがブロックされる
  - **HTTPステータス**: 401 Unauthorized

- **テストの目的**: JWKS認証ミドルウェアの確認
  - **品質保証の観点**: セキュリティ（認証フロー）、NFR-301の遵守

#### 2-3. ユーザーが存在しない（EDGE-006）

**🟢 信頼性レベル: 青信号（要件定義書のEDGE-006に基づく）**

- **テスト名**: 存在しないユーザーIDの場合、404エラーが返る
  - **エラーケースの概要**: データベースにユーザーが存在しない場合
  - **エラー処理の重要性**: ユーザーの存在を明確に示し、クライアント側の処理を適切にする

- **入力値**:
  ```http
  GET /users/00000000-0000-0000-0000-000000000000
  Authorization: Bearer <valid_jwt_token>
  ```
  - **不正な理由**: 指定されたUUID v4のユーザーがデータベースに存在しない
  - **実際の発生シナリオ**: ユーザーが削除された後、古いIDでアクセスした場合

- **期待される結果**:
  ```json
  {
    "success": false,
    "error": {
      "code": "NOT_FOUND",
      "message": "ユーザーが見つかりません"
    }
  }
  ```
  - **エラーメッセージの内容**: ユーザーが存在しないことを明示
  - **システムの安全性**: 存在しないユーザーの情報が漏洩しない
  - **HTTPステータス**: 404 Not Found

- **テストの目的**: ユーザー不存在時のエラーハンドリング確認
  - **品質保証の観点**: エラーハンドリング、ユーザーフィードバック

### GET /users の異常系

#### 2-4. limitが範囲外（最大値超過）（EDGE-002）

**🟢 信頼性レベル: 青信号（要件定義書のEDGE-002に基づく）**

- **テスト名**: limitが最大値100を超える場合、400エラーが返る
  - **エラーケースの概要**: ページネーションのlimitパラメータが制約を超えた場合
  - **エラー処理の重要性**: 大量データ取得によるパフォーマンス低下を防ぐ

- **入力値**:
  ```http
  GET /users?limit=200
  Authorization: Bearer <valid_jwt_token>
  ```
  - **不正な理由**: limit=200は最大値100を超えている
  - **実際の発生シナリオ**: クライアント側のバグで過大なlimitが送信された場合

- **期待される結果**:
  ```json
  {
    "success": false,
    "error": {
      "code": "VALIDATION_ERROR",
      "message": "バリデーションエラー",
      "details": {
        "limit": "取得件数は1以上100以下である必要があります"
      }
    }
  }
  ```
  - **エラーメッセージの内容**: limit制約違反を明示
  - **システムの安全性**: 大量データ取得が防止される
  - **HTTPステータス**: 400 Bad Request

- **テストの目的**: ページネーションパラメータの制約確認
  - **品質保証の観点**: パフォーマンス維持（NFR-001）、入力値検証

#### 2-5. limitが範囲外（最小値未満）

**🟢 信頼性レベル: 青信号（Zodスキーマのmin(1)制約に基づく）**

- **テスト名**: limitが最小値1未満の場合、400エラーが返る
  - **エラーケースの概要**: limitが0以下の場合
  - **エラー処理の重要性**: 意味のないリクエストを防ぐ

- **入力値**:
  ```http
  GET /users?limit=0
  Authorization: Bearer <valid_jwt_token>
  ```
  - **不正な理由**: limit=0は最小値1未満
  - **実際の発生シナリオ**: クライアント側のバグで0が送信された場合

- **期待される結果**:
  ```json
  {
    "success": false,
    "error": {
      "code": "VALIDATION_ERROR",
      "message": "バリデーションエラー",
      "details": {
        "limit": "取得件数は1以上100以下である必要があります"
      }
    }
  }
  ```
  - **エラーメッセージの内容**: limit制約違反を明示
  - **システムの安全性**: 無意味なリクエストが防止される
  - **HTTPステータス**: 400 Bad Request

- **テストの目的**: ページネーションパラメータの最小値確認
  - **品質保証の観点**: 入力値検証、データ整合性

#### 2-6. offsetが負の値

**🟢 信頼性レベル: 青信号（Zodスキーマのmin(0)制約に基づく）**

- **テスト名**: offsetが負の値の場合、400エラーが返る
  - **エラーケースの概要**: offsetが0未満の場合
  - **エラー処理の重要性**: 不正なページネーション位置を防ぐ

- **入力値**:
  ```http
  GET /users?offset=-1
  Authorization: Bearer <valid_jwt_token>
  ```
  - **不正な理由**: offset=-1は最小値0未満
  - **実際の発生シナリオ**: クライアント側のバグで負の値が送信された場合

- **期待される結果**:
  ```json
  {
    "success": false,
    "error": {
      "code": "VALIDATION_ERROR",
      "message": "バリデーションエラー",
      "details": {
        "offset": "オフセットは0以上である必要があります"
      }
    }
  }
  ```
  - **エラーメッセージの内容**: offset制約違反を明示
  - **システムの安全性**: 不正なページネーション位置が防止される
  - **HTTPステータス**: 400 Bad Request

- **テストの目的**: ページネーションパラメータのoffset制約確認
  - **品質保証の観点**: 入力値検証、データ整合性

#### 2-7. providerが不正な値

**🟢 信頼性レベル: 青信号（authProviderSchemaの定義に基づく）**

- **テスト名**: providerが列挙型に存在しない値の場合、400エラーが返る
  - **エラーケースの概要**: サポートされていないプロバイダー名でフィルタリングした場合
  - **エラー処理の重要性**: 未サポートのプロバイダーによる不正なフィルタリングを防ぐ

- **入力値**:
  ```http
  GET /users?provider=twitter
  Authorization: Bearer <valid_jwt_token>
  ```
  - **不正な理由**: "twitter"はauthProviderSchemaで定義されていない
  - **実際の発生シナリオ**: 古いクライアントから廃止されたプロバイダー名が送信された場合

- **期待される結果**:
  ```json
  {
    "success": false,
    "error": {
      "code": "VALIDATION_ERROR",
      "message": "バリデーションエラー",
      "details": {
        "provider": "無効なプロバイダー種別です"
      }
    }
  }
  ```
  - **エラーメッセージの内容**: サポートされていないプロバイダーであることを明示
  - **システムの安全性**: 未定義のプロバイダーによる不正フィルタリングを防ぐ
  - **HTTPステータス**: 400 Bad Request

- **テストの目的**: 列挙型バリデーションの確認
  - **品質保証の観点**: 型安全性の維持、API契約の厳格な遵守

### PUT /users/{id} の異常系

#### 2-8. パスパラメータが不正なUUID形式

**🟢 信頼性レベル: 青信号（要件定義書のEDGE-001に基づく）**

- **テスト名**: PUT /users/{id}でパスパラメータが不正なUUID形式の場合、400エラーが返る
  - **エラーケースの概要**: UUID v4形式に準拠しないIDが送信された場合
  - **エラー処理の重要性**: 不正なIDでの更新を防ぐ

- **入力値**:
  ```http
  PUT /users/invalid-uuid
  Authorization: Bearer <valid_jwt_token>
  {
    "name": "Updated Name"
  }
  ```
  - **不正な理由**: "invalid-uuid"はUUID v4形式に準拠していない
  - **実際の発生シナリオ**: クライアント側のバグで不正なIDが送信された場合

- **期待される結果**:
  ```json
  {
    "success": false,
    "error": {
      "code": "VALIDATION_ERROR",
      "message": "バリデーションエラー",
      "details": {
        "id": "有効なUUID v4形式である必要があります"
      }
    }
  }
  ```
  - **エラーメッセージの内容**: UUID形式制約違反を明示
  - **システムの安全性**: 不正なIDでの更新が実行されない
  - **HTTPステータス**: 400 Bad Request

- **テストの目的**: パスパラメータのUUIDバリデーション確認
  - **品質保証の観点**: 入力値検証、データ整合性

#### 2-9. nameが空文字列（EDGE-003）

**🟢 信頼性レベル: 青信号（要件定義書のEDGE-003に基づく）**

- **テスト名**: nameが空文字列の場合、400エラーが返る
  - **エラーケースの概要**: ユーザー名が空文字列の場合
  - **エラー処理の重要性**: 空のユーザー名が保存されるのを防ぐ

- **入力値**:
  ```http
  PUT /users/550e8400-e29b-41d4-a716-446655440000
  Authorization: Bearer <valid_jwt_token>
  {
    "name": ""
  }
  ```
  - **不正な理由**: nameは最小1文字という制約に違反
  - **実際の発生シナリオ**: ユーザーがフォームの名前フィールドを空にして送信した場合

- **期待される結果**:
  ```json
  {
    "success": false,
    "error": {
      "code": "VALIDATION_ERROR",
      "message": "バリデーションエラー",
      "details": {
        "name": "ユーザー名は1文字以上である必要があります"
      }
    }
  }
  ```
  - **エラーメッセージの内容**: 最小文字数制約違反を明示
  - **システムの安全性**: 空のユーザー名が保存されない
  - **HTTPステータス**: 400 Bad Request

- **テストの目的**: 文字列長制約のバリデーション確認
  - **品質保証の観点**: データ整合性、ビジネスロジックの保護

#### 2-10. avatarUrlが不正なURL形式（EDGE-004）

**🟢 信頼性レベル: 青信号（要件定義書のEDGE-004に基づく）**

- **テスト名**: avatarUrlが不正なURL形式の場合、400エラーが返る
  - **エラーケースの概要**: avatarUrlがURL形式でない場合
  - **エラー処理の重要性**: 画像表示エラーの原因となる不正URLの保存を防ぐ

- **入力値**:
  ```http
  PUT /users/550e8400-e29b-41d4-a716-446655440000
  Authorization: Bearer <valid_jwt_token>
  {
    "avatarUrl": "not-a-url"
  }
  ```
  - **不正な理由**: URLスキーム（http://、https://）がなく、URL形式に準拠していない
  - **実際の発生シナリオ**: クライアント側で画像パスを相対パスで誤って送信した場合

- **期待される結果**:
  ```json
  {
    "success": false,
    "error": {
      "code": "VALIDATION_ERROR",
      "message": "バリデーションエラー",
      "details": {
        "avatarUrl": "有効なURL形式である必要があります"
      }
    }
  }
  ```
  - **エラーメッセージの内容**: URL形式制約違反を明示
  - **システムの安全性**: 不正なURLによる画像表示エラーを防ぐ
  - **HTTPステータス**: 400 Bad Request

- **テストの目的**: オプションフィールドのURL形式バリデーション確認
  - **品質保証の観点**: データ品質の維持、フロントエンドエラーの防止

#### 2-11. ボディが空オブジェクト

**🟡 信頼性レベル: 黄信号（Zodスキーマのoptional()定義から推測）**

- **テスト名**: リクエストボディが空オブジェクトの場合、バリデーションが成功する
  - **エラーケースの概要**: すべてのフィールドがオプションのため、空オブジェクトも有効
  - **エラー処理の重要性**: 不要な更新リクエストを受け入れるかどうかの設計判断

- **入力値**:
  ```http
  PUT /users/550e8400-e29b-41d4-a716-446655440000
  Authorization: Bearer <valid_jwt_token>
  {}
  ```
  - **不正な理由**: すべてのフィールドがオプションのため、空オブジェクトも技術的には有効
  - **実際の発生シナリオ**: クライアント側のバグで空のボディが送信された場合

- **期待される結果**: 200 OK（何も更新されない）、または400 Bad Request（実装判断による）
  - **エラーメッセージの内容**: ビジネスロジックの判断に依存
  - **システムの安全性**: 無意味なリクエストの処理方針を明確にする
  - **HTTPステータス**: 200 OK または 400 Bad Request

- **テストの目的**: 空オブジェクトの処理方針確認
  - **品質保証の観点**: ビジネスロジックの明確化、UX向上

#### 2-12. ユーザーが存在しない（EDGE-006）

**🟢 信頼性レベル: 青信号（要件定義書のEDGE-006に基づく）**

- **テスト名**: 存在しないユーザーIDの場合、404エラーが返る
  - **エラーケースの概要**: データベースにユーザーが存在しない場合
  - **エラー処理の重要性**: ユーザーの存在を明確に示し、不正な更新を防ぐ

- **入力値**:
  ```http
  PUT /users/00000000-0000-0000-0000-000000000000
  Authorization: Bearer <valid_jwt_token>
  {
    "name": "Updated Name"
  }
  ```
  - **不正な理由**: 指定されたUUID v4のユーザーがデータベースに存在しない
  - **実際の発生シナリオ**: ユーザーが削除された後、古いIDで更新しようとした場合

- **期待される結果**:
  ```json
  {
    "success": false,
    "error": {
      "code": "NOT_FOUND",
      "message": "ユーザーが見つかりません"
    }
  }
  ```
  - **エラーメッセージの内容**: ユーザーが存在しないことを明示
  - **システムの安全性**: 存在しないユーザーの情報が作成されない
  - **HTTPステータス**: 404 Not Found

- **テストの目的**: ユーザー不存在時のエラーハンドリング確認
  - **品質保証の観点**: エラーハンドリング、ユーザーフィードバック

#### 2-13. 複数フィールドのバリデーションエラー

**🟡 信頼性レベル: 黄信号（Zodのエラーハンドリング動作から推測）**

- **テスト名**: 複数フィールドが不正な場合、すべてのエラーが返る
  - **エラーケースの概要**: 複数のフィールドが同時にバリデーションエラーの場合
  - **エラー処理の重要性**: ユーザーが1回のリクエストですべてのエラーを認識できる

- **入力値**:
  ```http
  PUT /users/invalid-uuid
  Authorization: Bearer <valid_jwt_token>
  {
    "name": "",
    "avatarUrl": "not-a-url"
  }
  ```
  - **不正な理由**: パスパラメータ、name、avatarUrlすべてが制約違反
  - **実際の発生シナリオ**: フォームのバリデーションをバイパスして送信された場合

- **期待される結果**:
  ```json
  {
    "success": false,
    "error": {
      "code": "VALIDATION_ERROR",
      "message": "バリデーションエラー",
      "details": {
        "id": "有効なUUID v4形式である必要があります",
        "name": "ユーザー名は1文字以上である必要があります",
        "avatarUrl": "有効なURL形式である必要があります"
      }
    }
  }
  ```
  - **エラーメッセージの内容**: すべてのフィールドエラーが明示される
  - **システムの安全性**: フィールド単位で詳細なエラー情報を提供
  - **HTTPステータス**: 400 Bad Request

- **テストの目的**: Zodの複数エラーハンドリング動作確認
  - **品質保証の観点**: UX向上（1回で全エラーを通知）、NFR-103の遵守

### 全エンドポイント共通の異常系

#### 2-14. データベース接続エラー（EDGE-007）

**🟢 信頼性レベル: 青信号（要件定義書のEDGE-007に基づく）**

- **テスト名**: データベース接続エラー時に500エラーが返る
  - **エラーケースの概要**: Infrastructure層でDBエラーが発生した場合
  - **エラー処理の重要性**: 内部エラー詳細を隠蔽し、セキュリティを維持する

- **入力値**: 有効なリクエスト（バリデーションは成功）
  - **不正な理由**: リクエスト自体は正常だが、DBが利用不可
  - **実際の発生シナリオ**: PostgreSQL接続プールが枯渇、ネットワーク障害等

- **期待される結果**:
  ```json
  {
    "success": false,
    "error": {
      "code": "INTERNAL_SERVER_ERROR",
      "message": "一時的にサービスが利用できません"
    }
  }
  ```
  - **エラーメッセージの内容**: 内部実装を露出しないユーザーフレンドリーなメッセージ
  - **システムの安全性**: スタックトレースやDB情報を隠蔽
  - **HTTPステータス**: 500 Internal Server Error

- **テストの目的**: Infrastructure層エラーのハンドリング確認
  - **品質保証の観点**: セキュリティ（NFR-303）、エラーログの記録

---

## 3. 境界値テストケース（最小値、最大値、null等）

### GET /users の境界値

#### 3-1. limit が最小値（1件）

**🟢 信頼性レベル: 青信号（Zodスキーマのmin(1)制約に基づく）**

- **テスト名**: limitが最小値1の場合、バリデーションが成功する
  - **境界値の意味**: 最小取得件数制約の境界値（1件ちょうど）
  - **境界値での動作保証**: 1件でも有効なリクエストとして扱われること

- **入力値**:
  ```http
  GET /users?limit=1
  Authorization: Bearer <valid_jwt_token>
  ```
  - **境界値選択の根拠**: `z.coerce.number().int().min(1)`の最小許容値
  - **実際の使用場面**: 最新のユーザー1件のみを取得する場合

- **期待される結果**: 200 OKレスポンスが返る
  - **境界での正確性**: 1件のユーザーが正常に返される
  - **一貫した動作**: 2件以上の場合と同じ動作をする

- **テストの目的**: 最小limit制約の境界値確認
  - **堅牢性の確認**: 境界値でもシステムが正常動作する

#### 3-2. limit が最大値（100件）

**🟢 信頼性レベル: 青信号（Zodスキーマのmax(100)制約に基づく）**

- **テスト名**: limitが最大値100の場合、バリデーションが成功する
  - **境界値の意味**: 最大取得件数制約の境界値（100件ちょうど）
  - **境界値での動作保証**: 100件でも有効なリクエストとして扱われること

- **入力値**:
  ```http
  GET /users?limit=100
  Authorization: Bearer <valid_jwt_token>
  ```
  - **境界値選択の根拠**: `z.coerce.number().int().max(100)`の最大許容値
  - **実際の使用場面**: 一度に最大件数を取得する場合

- **期待される結果**: 200 OKレスポンスが返る
  - **境界での正確性**: 最大100件のユーザーが正常に返される
  - **一貫した動作**: 99件以下の場合と同じ動作をする

- **テストの目的**: 最大limit制約の境界値確認
  - **堅牢性の確認**: 境界値でもシステムが正常動作する

#### 3-3. offset が最小値（0）

**🟢 信頼性レベル: 青信号（Zodスキーマのmin(0)制約に基づく）**

- **テスト名**: offsetが最小値0の場合、バリデーションが成功する
  - **境界値の意味**: 最小オフセット制約の境界値（0ちょうど）
  - **境界値での動作保証**: 先頭から取得する場合が正常に動作すること

- **入力値**:
  ```http
  GET /users?offset=0
  Authorization: Bearer <valid_jwt_token>
  ```
  - **境界値選択の根拠**: `z.coerce.number().int().min(0)`の最小許容値
  - **実際の使用場面**: 1ページ目（先頭）を取得する場合

- **期待される結果**: 200 OKレスポンスが返る
  - **境界での正確性**: 先頭からのユーザーが正常に返される
  - **一貫した動作**: offset=1以上の場合と同じ動作をする

- **テストの目的**: 最小offset制約の境界値確認
  - **堅牢性の確認**: 境界値でもシステムが正常動作する

### PUT /users/{id} の境界値

#### 3-4. name が最小長（1文字）

**🟢 信頼性レベル: 青信号（Zodスキーマのmin(1)制約に基づく）**

- **テスト名**: nameが1文字の場合、バリデーションが成功する
  - **境界値の意味**: 最小文字数制約の境界値（1文字ちょうど）
  - **境界値での動作保証**: 1文字の名前でも有効なユーザーとして扱われること

- **入力値**:
  ```http
  PUT /users/550e8400-e29b-41d4-a716-446655440000
  Authorization: Bearer <valid_jwt_token>
  {
    "name": "A"
  }
  ```
  - **境界値選択の根拠**: `z.string().min(1)`の最小許容値
  - **実際の使用場面**: イニシャルのみで登録するユーザー

- **期待される結果**: 200 OKレスポンスが返る
  - **境界での正確性**: 1文字の名前が正常に更新される
  - **一貫した動作**: 2文字以上の場合と同じ動作をする

- **テストの目的**: 最小長制約の境界値確認
  - **堅牢性の確認**: 境界値でもシステムが正常動作する

#### 3-5. avatarUrl が最小長の有効なURL

**🟢 信頼性レベル: 青信号（Zodスキーマのurl()制約に基づく）**

- **テスト名**: avatarUrlが最小長の有効なURLの場合、バリデーションが成功する
  - **境界値の意味**: 最小のURL形式（スキーム + ホスト）
  - **境界値での動作保証**: 短いURLでも有効なURLとして扱われること

- **入力値**:
  ```http
  PUT /users/550e8400-e29b-41d4-a716-446655440000
  Authorization: Bearer <valid_jwt_token>
  {
    "avatarUrl": "http://a.b"
  }
  ```
  - **境界値選択の根拠**: URLの最小形式（http:// + 1文字ホスト + . + 1文字TLD）
  - **実際の使用場面**: 短縮URLなどの短いURL

- **期待される結果**: 200 OKレスポンスが返る
  - **境界での正確性**: 短いURLが正常に更新される
  - **一貫した動作**: 長いURLの場合と同じ動作をする

- **テストの目的**: URL形式の最小境界値確認
  - **堅牢性の確認**: 境界値でもシステムが正常動作する

#### 3-6. avatarUrl がnullに更新

**🟢 信頼性レベル: 青信号（Zodスキーマのoptional()定義に基づく）**

- **テスト名**: avatarUrlをnullに更新できる
  - **境界値の意味**: オプションフィールドをnullにリセットするパターン
  - **境界値での動作保証**: nullでも有効な更新値として扱われること

- **入力値**:
  ```http
  PUT /users/550e8400-e29b-41d4-a716-446655440000
  Authorization: Bearer <valid_jwt_token>
  {
    "avatarUrl": null
  }
  ```
  - **境界値選択の根拠**: オプションフィールドのnull値
  - **実際の使用場面**: ユーザーがアバター画像を削除した場合

- **期待される結果**: 200 OKレスポンスが返り、avatarUrlがnullで更新される
  - **境界での正確性**: nullが正しくハンドリングされる
  - **一貫した動作**: URL文字列の場合と同じフローで処理される

- **テストの目的**: オプションフィールドのnullハンドリング確認
  - **堅牢性の確認**: オプションフィールドの全パターンで正常動作する

---

## テストケース実装時の日本語コメント指針

### 🟢 信頼性レベル: 青信号（プロジェクトCLAUDE.mdに基づく）

すべてのテストケースは以下のコメントパターンに従って実装してください：

### テストケース開始時のコメント

```typescript
// 【テスト目的】: このテストで何を確認するかを日本語で明記
// 【テスト内容】: 具体的にどのような処理をテストするかを説明
// 【期待される動作】: 正常に動作した場合の結果を説明
// 🟢 この内容の信頼性レベルを記載
```

### Given（準備フェーズ）のコメント

```typescript
// 【テストデータ準備】: なぜこのデータを用意するかの理由
// 【初期条件設定】: テスト実行前の状態を説明
// 【前提条件確認】: テスト実行に必要な前提条件を明記
```

### When（実行フェーズ）のコメント

```typescript
// 【実際の処理実行】: どの機能/メソッドを呼び出すかを説明
// 【処理内容】: 実行される処理の内容を日本語で説明
// 【実行タイミング】: なぜこのタイミングで実行するかを説明
```

### Then（検証フェーズ）のコメント

```typescript
// 【結果検証】: 何を検証するかを具体的に説明
// 【期待値確認】: 期待される結果とその理由を説明
// 【品質保証】: この検証がシステム品質にどう貢献するかを説明
```

### 各expectステートメントのコメント例

```typescript
// 【検証項目】: HTTPステータスコードが200であることを確認
// 🟢 要件定義書のシナリオ1に基づく
expect(response.status).toBe(200);

// 【検証項目】: レスポンスボディがgetUserResponseSchemaに一致することを確認
// 🟢 shared-schemas/users.tsのスキーマ定義に基づく
expect(() => getUserResponseSchema.parse(responseData)).not.toThrow();

// 【検証項目】: バリデーションエラー時のエラーメッセージが詳細であることを確認
// 🟢 REQ-104（詳細エラーメッセージ返却）に基づく
expect(responseData.error.details.id).toBe('有効なUUID v4形式である必要があります');

// 【検証項目】: ページネーションパラメータがデフォルト値で適用されることを確認
// 🟢 listUsersQuerySchemaのdefault()定義に基づく
expect(responseData.data.limit).toBe(20);
expect(responseData.data.offset).toBe(0);
```

---

## テストファイル構成

### 🟢 信頼性レベル: 青信号（既存テストファイルの構成に基づく）

```
app/server/src/presentation/http/routes/__tests__/
├── userRoutes.openapi.test.ts         # OpenAPIルート定義の単体テスト（新規）
└── userRoutes.integration.test.ts     # ユーザー管理APIの統合テスト（更新）
```

### テストファイルの責務

**userRoutes.openapi.test.ts（新規作成）**:
- OpenAPIルート定義の登録確認（3エンドポイント）
- createRouteの引数検証
- Zodスキーマの統合確認
- OpenAPI仕様書への反映確認

**userRoutes.integration.test.ts（既存ファイル更新）**:
- ユーザー管理APIの全体フローテスト
- リクエスト→JWKS認証→バリデーション→UseCase→レスポンスの統合テスト
- エラーハンドリングの検証（3エンドポイント × 各種エラー）

---

## 品質判定

### ✅ 高品質

- **テストケース分類**: 正常系（11ケース）・異常系（14ケース）・境界値（6ケース）が網羅されている
- **期待値定義**: 各テストケースの期待値が明確（HTTPステータス、レスポンスボディ、エラーメッセージ）
- **技術選択**: TypeScript 5.9.2 + Bun標準テストランナーで確定（プロジェクトCLAUDE.mdに準拠）
- **実装可能性**: TASK-902のauthRoutes.test.tsを参考にして実装可能

### テストケースの網羅性

| 観点 | カバー状況 | 詳細 |
|------|------------|------|
| 正常系 | ✅ | OpenAPIルート定義（3パターン）、各エンドポイントの正常動作（8パターン） |
| 異常系 | ✅ | バリデーションエラー（13パターン）、DBエラー |
| 境界値 | ✅ | limit最小・最大、offset最小、name最小長、avatarUrl最小・null |
| EARS要件 | ✅ | REQ-104（詳細エラー）、NFR-303（内部情報隠蔽）、NFR-001（パフォーマンス）に対応 |
| エッジケース | ✅ | EDGE-001〜EDGE-007すべてをカバー |

### 3エンドポイントの網羅状況

| エンドポイント | 正常系 | 異常系 | 境界値 | 合計 |
|---------------|--------|--------|--------|------|
| GET /users/{id} | 3 | 3 | 0 | 6 |
| GET /users | 3 | 5 | 3 | 11 |
| PUT /users/{id} | 5 | 5 | 3 | 13 |
| 共通 | 0 | 1 | 0 | 1 |
| **合計** | **11** | **14** | **6** | **31** |

※ OpenAPIルート定義テスト（3ケース）を含めると **合計34テストケース**

---

## 次のステップ

**次のお勧めステップ**: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。

### Redフェーズで実施すること

1. **userRoutes.openapi.test.ts（新規作成）**:
   - OpenAPIルート定義の単体テスト実装（3エンドポイント）
   - 初期状態ではテストが失敗（ルート未実装のため）

2. **userRoutes.integration.test.ts（更新）**:
   - ユーザー管理APIの統合テスト追加
   - 31テストケースすべてを実装
   - 初期状態ではテストが失敗（OpenAPIルート未実装のため）

3. **テスト実行コマンド**:
   ```bash
   docker compose exec server bun test src/presentation/http/routes/__tests__/userRoutes.openapi.test.ts
   docker compose exec server bun test src/presentation/http/routes/__tests__/userRoutes.integration.test.ts
   ```
