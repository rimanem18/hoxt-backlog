# TDDテストケース一覧：TASK-301 フロントエンド認証フロー

**作成日**: 2025-08-30  
**更新日**: 2025-08-30  
**機能名**: mvp-google-auth (フロントエンド認証フロー)  
**タスクID**: TASK-301  
**ブランチ**: issue#21_frontend-auth-flow  

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript + React
  - **言語選択の理由**: 型安全性とReactコンポーネントのテストに最適
  - **テストに適した機能**: 静的型チェック・コンパイル時エラー検出・IDE支援
- **テストフレームワーク**: Bun Test + @testing-library/react
  - **フレームワーク選択の理由**: 高速実行・内蔵モック機能・Next.js 15対応
  - **テスト実行環境**: JSDOM + test-setup.ts環境変数設定
- 🟢 **信頼性レベル**: プロジェクト技術スタック要件（REQ-101）から確定

---

## 1. 正常系テストケース（基本的な動作）

### 1-1. LoginButton基本動作テスト（プロバイダー非依存）

- **テスト名**: 汎用ログインボタン表示とプロバイダー選択動作確認
  - **何をテストするか**: LoginButtonコンポーネントのプロバイダー非依存UI表示とクリックイベント処理
  - **期待される動作**: プロバイダー指定に基づいて適切なボタンが表示され、クリック時に対応する認証処理が開始される
- **入力値**: `{ provider: 'google' }` props + ボタンクリックイベント
  - **入力データの意味**: ユーザーのログイン意図とプロバイダー選択を表すUI操作
- **期待される結果**: 
  - ボタンが「Googleでログイン」テキストで表示される（プロバイダーに応じて動的変更）
  - `authService.signIn('google')`が正しく呼び出される（抽象化層経由）
  - **期待結果の理由**: プロバイダー非依存設計とREQ-102（認証フロー実装）で定義
- **テストの目的**: プロバイダー抽象化による汎用認証開始処理の確実な実行
  - **確認ポイント**: AuthService抽象化層の正しいパラメータ設定とプロバイダー選択機能
- 🟡 **信頼性レベル**: プロバイダー非依存設計要件と既存実装から妥当な抽象化推測

### 1-2. UserProfile情報表示テスト

- **テスト名**: 認証済みユーザー情報の正確な表示確認
  - **何をテストするか**: UserProfileコンポーネントでのユーザー情報（名前・メール・アバター）表示
  - **期待される動作**: 渡されたユーザーオブジェクトの各プロパティが正しく画面表示される
- **入力値**: User型オブジェクト
  ```typescript
  const testUser: User = {
    id: "test-uuid",
    name: "山田太郎",
    email: "user@example.com", 
    avatarUrl: "https://example.com/avatar.jpg"
  }
  ```
  - **入力データの意味**: 認証完了後にバックエンドAPIから取得されるユーザー情報
- **期待される結果**: 
  - 名前「山田太郎」が見出しとして表示
  - メールアドレス「user@example.com」がテキスト表示
  - アバター画像が指定URLで表示
  - **期待結果の理由**: 要件REQ-104（認証済みUI表示）で明示
- **テストの目的**: ユーザー情報の視覚的確認機能の保証
  - **確認ポイント**: User型のプロパティとUI要素の正確な対応関係
- 🟢 **信頼性レベル**: interfaces.ts User型定義、要件REQ-104から直接抽出

### 1-3. authSlice状態管理テスト

- **テスト名**: 認証成功時のRedux状態更新確認
  - **何をテストするか**: authSuccessアクション実行時のAuthState更新処理
  - **期待される動作**: 認証成功時に適切な状態変更が行われる
- **入力値**: authSuccessアクション + AuthSuccessPayload
  ```typescript
  const payload: AuthSuccessPayload = {
    user: testUser,
    isNewUser: false
  }
  ```
  - **入力データの意味**: バックエンドAPIからの認証完了レスポンス
- **期待される結果**:
  - `isAuthenticated: true`に更新
  - `user`プロパティにユーザー情報設定
  - `isLoading: false`に更新（処理完了）
  - `error: null`に更新（エラー状態クリア）
  - **期待結果の理由**: AuthState型定義とauthSlice実装に基づく
- **テストの目的**: 認証状態管理の整合性確認
  - **確認ポイント**: Redux Toolkitの状態イミュータブル更新と型安全性
- 🟢 **信頼性レベル**: interfaces.ts AuthState型、authSlice.ts実装から直接抽出

### 1-4. セッション復元機能テスト（未実装・プロバイダー非依存）

- **テスト名**: アプリケーション起動時の自動認証状態復元確認
  - **何をテストするか**: ページリロード・初回アクセス時のAuthService経由セッション確認と状態復元
  - **期待される動作**: 既存の有効セッションが検出され、プロバイダーに関係なく自動的に認証済み状態に遷移
- **入力値**: `authService.getCurrentSession()`からの有効セッション（プロバイダー情報含む）
  - **入力データの意味**: ブラウザに保存された前回認証セッションの継続状態（プロバイダー非依存）
- **期待される結果**:
  - AuthService抽象化層経由でユーザー情報取得APIが呼び出される
  - Redux stateが認証済み状態に更新される（プロバイダー情報も含む）
  - UserProfileコンポーネントが表示される（プロバイダー非依存表示）
  - **期待結果の理由**: dataflow.md「2回目以降のログインフロー」とプロバイダー抽象化設計で定義
- **テストの目的**: プロバイダー非依存セッション継続によるユーザビリティ向上の保証
  - **確認ポイント**: AuthService抽象化層でのセッション有効性判定とAPIコール自動化
- 🟡 **信頼性レベル**: dataflow.md設計とプロバイダー抽象化要件から妥当な実装推測

### 1-5. バックエンドAPI連携テスト

- **テスト名**: JWT認証でのユーザー情報取得確認
  - **何をテストするか**: 認証後のバックエンドAPI `/api/user/profile`との正常連携
  - **期待される動作**: JWTトークンでAPIリクエストし、ユーザー情報を正常取得
- **入力値**: 有効なJWTトークン
  - **入力データの意味**: Supabase Authから発行された認証証明書
- **期待される結果**:
  - APIレスポンス形式: `{ success: true, data: User }`
  - HTTP Status: 200 OK  
  - Redux stateにユーザー情報反映
  - **期待結果の理由**: api-endpoints.md GET /api/user/profile仕様で定義
- **テストの目的**: フロントエンド・バックエンド間認証連携の確認
  - **確認ポイント**: JWTヘッダー設定とAPIレスポンス処理
- 🟢 **信頼性レベル**: api-endpoints.md、interfaces.ts GetUserProfileResponseから直接抽出

---

## 2. 異常系テストケース（エラーハンドリング）

### 2-1. Google認証キャンセルエラーテスト

- **テスト名**: Google認証ページでのユーザーキャンセル処理確認
  - **エラーケースの概要**: ユーザーがGoogle認証ページで「キャンセル」ボタンをクリックした状況
  - **エラー処理の重要性**: 認証中断時の適切な状態管理とUI復旧が必要
- **入力値**: Supabase認証エラー `{ error: { message: 'User cancelled' } }`
  - **不正な理由**: ユーザー意図による認証プロセス中断
  - **実際の発生シナリオ**: 認証確認画面での意図的または誤操作による中断
- **期待される結果**:
  - エラーメッセージ表示なし（正常な中断として扱う）
  - Redux state: `{ isAuthenticated: false, isLoading: false, error: null }`
  - GoogleLoginButtonが再度表示される
  - **エラーメッセージの内容**: ユーザー操作なので特別なメッセージは不要
  - **システムの安全性**: 認証前の未認証状態に適切に復帰
- **テストの目的**: ユーザー意図による中断への適切な対応確認
  - **品質保証の観点**: ユーザビリティを損なわない自然な認証再試行環境の提供
- 🟡 **信頼性レベル**: EDGE-101（認証キャンセル）から妥当な推測

### 2-2. ネットワークエラーテスト

- **テスト名**: インターネット接続断時のエラーハンドリング確認
  - **エラーケースの概要**: Google認証またはAPI通信中のネットワーク接続不良
  - **エラー処理の重要性**: 通信エラー時のユーザーへの適切なフィードバックとリトライ機能
- **入力値**: Network Error `{ error: { code: 'NETWORK_ERROR' } }`
  - **不正な理由**: インフラ側の接続不良による通信失敗
  - **実際の発生シナリオ**: WiFi接続断・モバイル通信不良・サーバー一時停止
- **期待される結果**:
  - エラーメッセージ: 「インターネット接続を確認してください」
  - Redux state: `{ isAuthenticated: false, isLoading: false, error: 'NETWORK_ERROR' }`
  - 再試行ボタンまたは自動リトライ機能提供
  - **エラーメッセージの内容**: ユーザーが理解しやすく、対処方法が明確
  - **システムの安全性**: エラー状態からの復旧可能性を保持
- **テストの目的**: 通信障害時の堅牢なエラー処理確認
  - **品質保証の観点**: システム障害時でもユーザーが適切に対処できる情報提供
- 🟡 **信頼性レベル**: EDGE-102（ネットワークエラー）から妥当な推測

### 2-3. バックエンドAPI接続失敗テスト

- **テスト名**: バックエンドサーバーエラー時の処理確認
  - **エラーケースの概要**: JWT認証後のユーザー情報取得API（/api/user/profile）接続失敗
  - **エラー処理の重要性**: フロントエンド・バックエンド連携エラーの適切な処理
- **入力値**: HTTP 500 Internal Server Error レスポンス
  - **不正な理由**: バックエンドサーバーの一時的な障害・データベース接続エラー
  - **実際の発生シナリオ**: サーバー高負荷・DB接続プール枯渇・アプリケーションエラー
- **期待される結果**:
  - エラーメッセージ: 「サーバーとの通信に失敗しました。しばらく待ってから再度お試しください」
  - Redux state: `{ isAuthenticated: false, isLoading: false, error: 'SERVER_ERROR' }`
  - 認証状態のロールバック（JWT無効化）
  - **エラーメッセージの内容**: サーバー側問題であることの明示と再試行の推奨
  - **システムの安全性**: 不完全な認証状態の回避と整合性保持
- **テストの目的**: サーバーサイドエラーでの堅牢な処理確認
  - **品質保証の観点**: システム障害時の安全なフォールバック処理
- 🟡 **信頼性レベル**: EDGE-103（API接続失敗）から妥当な推測

### 2-4. JWT期限切れエラーテスト

- **テスト名**: JWT有効期限切れ時の自動ログアウト処理確認  
  - **エラーケースの概要**: 長時間利用後のJWTトークン有効期限切れ
  - **エラー処理の重要性**: セキュリティ維持のための適切な認証状態クリア
- **入力値**: HTTP 401 Unauthorized `{ error: { code: 'TOKEN_EXPIRED' } }`
  - **不正な理由**: 時間経過による認証証明書の自然失効
  - **実際の発生シナリオ**: 長時間のページ表示・一定時間後のAPI呼び出し
- **期待される結果**:
  - 自動ログアウト処理実行
  - Redux state: `{ isAuthenticated: false, user: null, isLoading: false, error: null }`
  - GoogleLoginButtonの表示（再認証促進）
  - 通知メッセージ: 「セッションが終了しました。再度ログインしてください」
  - **エラーメッセージの内容**: セキュリティ上の正常な処理であることの説明
  - **システムの安全性**: 期限切れ認証情報の完全クリアと再認証要求
- **テストの目的**: セキュリティ要件に基づく適切な認証管理確認
  - **品質保証の観点**: 不正アクセス防止とセキュアな認証ライフサイクル管理
- 🟡 **信頼性レベル**: EDGE-104（JWT期限切れ）から妥当な推測

### 2-5. アバター画像取得失敗テスト

- **テスト名**: ユーザーアバター画像URL無効時のフォールバック確認
  - **エラーケースの概要**: ユーザーのアバター画像URLが無効・アクセス不可の状況
  - **エラー処理の重要性**: UI表示の完全性維持とユーザビリティ確保
- **入力値**: `avatarUrl: null` または無効URL
  - **不正な理由**: 外部画像サーバー削除・URL変更・権限エラー
  - **実際の発生シナリオ**: GoogleプロフィールOAUTHサーバー・CDN障害・権限変更
- **期待される結果**:
  - デフォルト画像 `/default-avatar.png` の表示
  - エラー表示なし（ユーザビリティ優先）
  - 他のユーザー情報（名前・メール）は正常表示継続
  - **エラーメッセージの内容**: エラーメッセージは表示せず、シームレスなフォールバック
  - **システムの安全性**: 画像エラーが他の機能に影響しない分離設計
- **テストの目的**: UI部分エラーでの堅牢な表示確認
  - **品質保証の観点**: 外部リソース依存部分での品質維持
- 🟢 **信頼性レベル**: 既存実装UserProfile.tsxで確認済み、EDGE-105で明示

---

## 3. 境界値テストケース（最小値、最大値、null等）

### 3-1. ユーザー名長さ境界値テスト

- **テスト名**: ユーザー名の最小・最大文字数での表示確認
  - **境界値の意味**: UI表示領域とデータベース制約の境界での動作確認
  - **境界値での動作保証**: 極端な文字数でのレイアウト崩れ防止
- **入力値**: 
  - 最小値: `name: "田"` （1文字）
  - 最大値: `name: "あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん"` （50文字）
  - **境界値選択の根拠**: 一般的なname varchar(50)制約とUI表示限界を想定
  - **実際の使用場面**: 本名が短い外国人・長い複合姓名での利用
- **期待される結果**:
  - 1文字: 正常表示、レイアウト維持
  - 50文字: テキスト折り返しまたは省略表示（...）
  - UI崩れなし、他要素への影響なし
  - **境界での正確性**: 文字数に関わらず正確な文字列表示
  - **一貫した動作**: フォント・行高・要素間隔の維持
- **テストの目的**: UI表示の堅牢性確認
  - **堅牢性の確認**: 極端なデータでのUI安定性保証
- 🟡 **信頼性レベル**: 一般的なWeb UI制約から妥当な推測

### 3-2. JWT有効期限境界値テスト

- **テスト名**: JWT期限切れ直前・直後での認証状態確認
  - **境界値の意味**: トークン有効期限の境界での認証判定動作
  - **境界値での動作保証**: 期限切れタイミングでの一貫した認証処理
- **入力値**:
  - 期限1秒前: `exp: Math.floor(Date.now()/1000) + 1`
  - 期限1秒後: `exp: Math.floor(Date.now()/1000) - 1`
  - **境界値選択の根拠**: JWT有効期限判定のUNIX時刻境界
  - **実際の使用場面**: 長時間利用後のAPI呼び出し・ページ表示継続
- **期待される結果**:
  - 期限前: 認証継続、API呼び出し成功
  - 期限後: 自動ログアウト、401エラー適切処理
  - **境界での正確性**: 秒単位での正確な期限判定
  - **一貫した動作**: 期限切れ直後の即座な認証状態クリア
- **テストの目的**: セキュリティ境界での正確な認証管理
  - **堅牢性の確認**: 時刻境界での認証制御の信頼性
- 🟢 **信頼性レベル**: JWT仕様（RFC 7519）とSupabase Auth仕様から確定

### 3-3. Redux初期状態境界値テスト

- **テスト名**: AuthState初期化時の各プロパティnull/undefined処理確認
  - **境界値の意味**: 認証前の未定義状態での安全な初期化動作
  - **境界値での動作保証**: undefined・nullでのアプリケーション安定性
- **入力値**:
  - `user: null` (初期状態)
  - `user: undefined` (予期しない状態)
  - `error: null` vs `error: ""` (エラー状態の境界)
  - **境界値選択の根拠**: TypeScript strict nullチェックでの境界条件
  - **実際の使用場面**: アプリケーション初回起動・セッションクリア後
- **期待される結果**:
  - null値での正常動作、エラー発生なし
  - undefined値での適切なフォールバック処理
  - UI表示での条件分岐正常動作
  - **境界での正確性**: null/undefined判定での条件分岐の正確性
  - **一貫した動作**: 初期化パターンに関わらず同一の初期状態到達
- **テストの目的**: 型安全性と初期化処理の堅牢性確認
  - **堅牢性の確認**: TypeScript strict mode下での null安全性保証
- 🟢 **信頼性レベル**: authSlice.ts実装とTypeScript型定義から確定

### 3-4. 環境変数未設定境界値テスト

- **テスト名**: Supabase環境変数未設定時のエラーハンドリング確認
  - **境界値の意味**: 必須環境変数の存在・非存在境界での動作確認
  - **境界値での動作保証**: 設定ミス・未設定時の適切なエラー表示
- **入力値**:
  - `NEXT_PUBLIC_SUPABASE_URL: undefined`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY: ""`（空文字列）
  - **境界値選択の根拠**: 本番デプロイ時の設定ミス・環境変数漏れを想定
  - **実際の使用場面**: 新環境デプロイ・CI/CD設定ミス・ローカル開発初期設定
- **期待される結果**:
  - アプリケーション起動時エラー
  - 明確なエラーメッセージ: 「環境変数が設定されていません」
  - Supabaseクライアント初期化失敗の適切な処理
  - **境界での正確性**: 未設定検出の確実性とエラー内容の具体性
  - **一貫した動作**: 環境変数不足時の統一されたエラーハンドリング
- **テストの目的**: 設定ミス時の開発者フレンドリーなエラー表示
  - **堅牢性の確認**: デプロイ失敗時の迅速な問題特定支援
- 🟡 **信頼性レベル**: 一般的なWeb開発での環境変数管理ベストプラクティスから推測

### 3-5. ネットワーク通信タイムアウト境界値テスト

- **テスト名**: API通信タイムアウト時間での境界動作確認
  - **境界値の意味**: 通信タイムアウト設定値での成功・失敗境界
  - **境界値での動作保証**: 遅延通信での適切なタイムアウト処理
- **入力値**:
  - タイムアウト直前応答: 9.9秒後レスポンス（タイムアウト10秒設定時）
  - タイムアウト直後応答: 10.1秒後レスポンス
  - **境界値選択の根拠**: 一般的なHTTP通信タイムアウト設定（10秒）
  - **実際の使用場面**: 低速ネットワーク・サーバー高負荷時の通信
- **期待される結果**:
  - 9.9秒: 正常レスポンス受信、認証成功
  - 10.1秒: タイムアウトエラー、適切なエラー表示
  - ユーザーへの適切な待機表示（ローディング）
  - **境界での正確性**: タイムアウト判定の時刻精度
  - **一貫した動作**: タイムアウト後の確実なエラー処理とリトライ可能性
- **テストの目的**: 通信品質境界での堅牢な処理確認
  - **堅牢性の確認**: ネットワーク環境に依存しない安定性保証
- 🟡 **信頼性レベル**: 一般的なHTTP通信タイムアウト設定から妥当な推測

---

## テストケース実装時の日本語コメント指針

### テストケース開始時のコメント

```javascript
// 【テスト目的】: [このテストで何を確認するかを日本語で明記]
// 【テスト内容】: [具体的にどのような処理をテストするかを説明]
// 【期待される動作】: [正常に動作した場合の結果を説明]
// 🟢🟡🔴 この内容の信頼性レベルを記載
```

### Given（準備フェーズ）のコメント

```javascript
// 【テストデータ準備】: [なぜこのデータを用意するかの理由]
// 【初期条件設定】: [テスト実行前の状態を説明]
// 【前提条件確認】: [テスト実行に必要な前提条件を明記]
```

### When（実行フェーズ）のコメント

```javascript
// 【実際の処理実行】: [どの機能/メソッドを呼び出すかを説明]
// 【処理内容】: [実行される処理の内容を日本語で説明]
// 【実行タイミング】: [なぜこのタイミングで実行するかを説明]
```

### Then（検証フェーズ）のコメント

```javascript
// 【結果検証】: [何を検証するかを具体的に説明]
// 【期待値確認】: [期待される結果とその理由を説明]
// 【品質保証】: [この検証がシステム品質にどう貢献するかを説明]
```

### 各expectステートメントのコメント

```javascript
// 【検証項目】: [この検証で確認している具体的な項目]
// 🟢🟡🔴 この内容の信頼性レベルを記載
expect(result.isAuthenticated).toBe(true); // 【確認内容】: 認証成功時にisAuthenticatedフラグがtrueに更新されることを確認
expect(result.user).toEqual(testUser); // 【確認内容】: ユーザー情報が正確にRedux stateに保存されることを確認
```

### セットアップ・クリーンアップのコメント

```javascript
beforeEach(() => {
  // 【テスト前準備】: [各テスト実行前に行う準備作業の説明]
  // 【環境初期化】: [テスト環境をクリーンな状態にする理由と方法]
});

afterEach(() => {
  // 【テスト後処理】: [各テスト実行後に行うクリーンアップ作業の説明]
  // 【状態復元】: [次のテストに影響しないよう状態を復元する理由]
});
```

---

## テストケース分類別実装優先度

### 🟥 優先度1：未実装の核心機能（緊急）
1. セッション復元テスト（1-4）
2. エラーハンドリングテスト（2-1～2-5）
3. JWT期限境界値テスト（3-2）

### 🟨 優先度2：既存機能の品質向上（重要）
1. 既存コンポーネントテスト強化（1-1～1-3）
2. バックエンド連携テスト（1-5）
3. Redux状態管理境界値テスト（3-3）

### 🟩 優先度3：堅牢性向上テスト（推奨）
1. UI境界値テスト（3-1）
2. 環境設定テスト（3-4）
3. 通信タイムアウトテスト（3-5）

---

## 実装予定テストファイル構成（プロバイダー非依存設計）

```
app/client/src/features/auth/__tests__/
├── integration/
│   ├── AuthFlow.test.tsx          // 認証フロー統合テスト（プロバイダー非依存）
│   ├── SessionRestore.test.tsx    // セッション復元テスト（プロバイダー非依存）
│   └── ApiIntegration.test.tsx    // バックエンド連携テスト
├── components/
│   ├── LoginButton.test.tsx       // 抽象化版（プロバイダー選択・エラーハンドリング）
│   ├── LogoutButton.test.tsx      // 汎用ログアウトボタンテスト
│   └── UserProfile.test.tsx       // 拡張版（境界値テスト追加）
├── services/
│   ├── authService.test.ts        // 認証サービス抽象化層テスト
│   └── providers/
│       ├── googleAuthProvider.test.ts    // Google認証プロバイダーテスト
│       ├── authProviderInterface.test.ts // インターフェース準拠テスト
│       └── mockAuthProvider.test.ts      // テスト用モックプロバイダー
├── store/
│   ├── authSlice.test.ts          // 拡張版（全アクション追加）
│   └── authActions.test.ts        // 新規（authStart・authFailure・logout）
├── hooks/
│   ├── useAuth.test.ts            // 認証状態管理カスタムフック
│   └── useAuthActions.test.ts     // 認証アクションカスタムフック
└── utils/
    ├── errorHandling.test.ts      // エラーハンドリングユーティリティ
    ├── tokenValidation.test.ts    // JWT有効期限検証
    └── providerUtils.test.ts      // プロバイダー関連ユーティリティ
```
