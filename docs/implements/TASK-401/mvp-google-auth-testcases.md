# TASK-401 E2Eテストスイート実装 - TDDテストケース一覧

作成日: 2025-01-22
更新日: 2025-01-22

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript
  - **言語選択の理由**: 既存のフロントエンド・バックエンド実装との整合性とタイプセーフティの確保
  - **テストに適した機能**: 型チェックによる早期エラー検出とIntelliSenseによる開発効率向上
- **テストフレームワーク**: Playwright
  - **フレームワーク選択の理由**: タスク仕様で明示的に指定済み、複数ブラウザ対応とE2Eテストに最適化
  - **テスト実行環境**: Docker Composeのplaywrightコンテナ内でBunテストランナー使用
- 🟢 この内容の信頼性レベル（タスク仕様で明示的に指定済み）

## 1. 正常系テストケース（基本的な動作）

### T001: 初回ログインフロー（JITプロビジョニング）
- **テスト名**: 新規ユーザーのGoogle OAuth初回ログインでJITプロビジョニングが正常動作する
  - **何をテストするか**: 未登録ユーザーが初回ログイン時に自動でユーザー作成される機能
  - **期待される動作**: Google OAuth→JWT取得→バックエンド検証→新規ユーザー作成→プロフィール表示
- **入力値**: テスト用Googleアカウント（未登録状態）
  - **入力データの意味**: 実際の新規ユーザー登録フローを代表する最も重要なテストケース
- **期待される結果**: ログイン成功・ユーザープロフィール画面表示・`isNewUser: true`フラグ確認
  - **期待結果の理由**: JITプロビジョニングの核心機能が正常動作することの証明
- **テストの目的**: 新規ユーザー獲得フローの品質保証
  - **確認ポイント**: データベースへの新規ユーザー作成・認証状態の正常な確立
- 🟢 このテストケースの信頼性レベル（タスク仕様で明示的に指定）

### T002: 既存ユーザーの再ログインフロー
- **テスト名**: 登録済みユーザーのGoogle OAuth再ログインが正常動作する
  - **何をテストするか**: 既存ユーザーの通常のログイン処理とセッション確立
  - **期待される動作**: Google OAuth→JWT取得→既存ユーザー確認→lastLoginAt更新→プロフィール表示
- **入力値**: テスト用Googleアカウント（登録済み状態）
  - **入力データの意味**: 日常的なユーザーログイン操作を代表する最も頻度の高いケース
- **期待される結果**: ログイン成功・ユーザープロフィール画面表示・`isNewUser: false`フラグ確認
  - **期待結果の理由**: 既存ユーザーの継続利用フローが正常動作することの保証
- **テストの目的**: 継続利用ユーザーの認証品質保証
  - **確認ポイント**: lastLoginAt更新・認証状態の正常復元・既存データの保持
- 🟢 このテストケースの信頼性レベル（タスク仕様で明示的に指定）

### T003: ログアウトフロー
- **テスト名**: 認証済みユーザーのログアウト処理が正常動作する
  - **何をテストするか**: セッション削除・認証状態クリア・画面遷移の完全性
  - **期待される動作**: ログアウトボタン→認証状態クリア→ログイン画面への遷移
- **入力値**: 認証済み状態のユーザーセッション
  - **入力データの意味**: ユーザーの意図的なログアウト操作を代表
- **期待される結果**: 認証状態のクリア・localStorage/sessionStorageの削除・ログイン画面表示
  - **期待結果の理由**: セキュリティ要件としてのセッション適切な終了の保証
- **テストの目的**: セッション管理の完全性とセキュリティ確保
  - **確認ポイント**: トークン完全削除・認証が必要なページへの自動リダイレクト
- 🟢 このテストケースの信頼性レベル（タスク仕様で明示的に指定）

### T004: ページリロード時の認証状態復元
- **テスト名**: ブラウザリロード後に認証状態が正常に復元される
  - **何をテストするか**: 永続化されたトークンからの認証状態自動復元機能
  - **期待される動作**: ページリロード→localStorage/sessionStorageからトークン読み込み→認証状態復元
- **入力値**: 認証済み状態でのブラウザリロード操作
  - **入力データの意味**: ユーザーの一般的なブラウザ操作に対する堅牢性確保
- **期待される結果**: 認証状態の維持・ユーザープロフィール画面の継続表示
  - **期待結果の理由**: ユーザビリティ向上とセッション継続性の保証
- **テストの目的**: 認証持続性の品質保証
  - **確認ポイント**: トークン有効性検証・自動的なユーザー情報取得
- 🟢 このテストケースの信頼性レベル（タスク仕様で明示的に指定）

## 2. 異常系テストケース（エラーハンドリング）

### T005: 認証エラー時のハンドリング（無効JWT）
- **テスト名**: 無効なJWTトークンに対する適切なエラーハンドリング
  - **エラーケースの概要**: 改ざんされたJWTや署名不正JWTでのアクセス試行
  - **エラー処理の重要性**: セキュリティホールの防止と不正アクセス検知
- **入力値**: 改ざんされたJWTトークン
  - **不正な理由**: 署名検証に失敗するため認証として無効
  - **実際の発生シナリオ**: 悪意のあるユーザーによるトークン改ざん攻撃
- **期待される結果**: 401 Unauthorizedエラー・ログイン画面への自動リダイレクト・適切なエラーメッセージ表示
  - **エラーメッセージの内容**: 「認証に失敗しました。再度ログインしてください。」
  - **システムの安全性**: 不正トークンでのアクセスを完全に遮断
- **テストの目的**: セキュリティ要件の遵守確認
  - **品質保証の観点**: 不正アクセス防止機能の動作保証
- 🟢 このテストケースの信頼性レベル（セキュリティ要件として必須）

### T006: 期限切れJWTエラーハンドリング
- **テスト名**: 期限切れJWTトークンに対する適切なエラーハンドリング
  - **エラーケースの概要**: 有効期限を過ぎたJWTでのアクセス試行
  - **エラー処理の重要性**: セッション有効期限管理とセキュリティ確保
- **入力値**: 有効期限切れのJWTトークン
  - **不正な理由**: 時刻検証でexpiredとして認証失敗
  - **実際の発生シナリオ**: 長時間利用後のセッション期限切れ
- **期待される結果**: 401 Unauthorizedエラー・自動的な再認証プロンプト表示
  - **エラーメッセージの内容**: 「セッションの有効期限が切れました。再度ログインしてください。」
  - **システムの安全性**: 期限切れセッションでの不正利用防止
- **テストの目的**: セッション管理機能の信頼性確保
  - **品質保証の観点**: 時間ベースのセキュリティ制御の動作確認
- 🟢 このテストケースの信頼性レベル（JWT標準仕様として必須）

### T007: ネットワークエラー時のフォールバック
- **テスト名**: ネットワーク接続エラー時の適切なフォールバック処理
  - **エラーケースの概要**: API通信失敗・タイムアウト・接続断絶時の処理
  - **エラー処理の重要性**: ユーザビリティ確保とシステム堅牢性の維持
- **入力値**: ネットワーク接続断絶状態でのログイン試行
  - **不正な理由**: 物理的なネットワーク問題によりAPI呼び出しが不可能
  - **実際の発生シナリオ**: Wi-Fi接続不良・サーバーメンテナンス時
- **期待される結果**: 接続エラーメッセージ表示・再試行ボタン・オフライン状態の適切な表示
  - **エラーメッセージの内容**: 「ネットワーク接続を確認してください。」
  - **システムの安全性**: エラー状態でのアプリクラッシュ回避
- **テストの目的**: ネットワーク堅牢性の品質保証
  - **品質保証の観点**: 外部依存エラーに対する適切な対応機能の確認
- 🟡 このテストケースの信頼性レベル（一般的なWebアプリ要件として妥当な推測）

### T008: Google OAuth認証失敗時のエラー表示
- **テスト名**: Google OAuth プロバイダー側認証失敗時の適切なエラー処理
  - **エラーケースの概要**: Googleアカウント認証拒否・OAuth設定エラー時の処理
  - **エラー処理の重要性**: 外部プロバイダー依存エラーの適切なハンドリング
- **入力値**: Google OAuth認証拒否（ユーザーがキャンセル）
  - **不正な理由**: ユーザーの意図的な認証拒否またはGoogleアカウント問題
  - **実際の発生シナリオ**: ユーザーがGoogleログインをキャンセル・Googleアカウント停止状態
- **期待される結果**: 認証キャンセルメッセージ表示・ログイン画面に留まる・再試行可能状態
  - **エラーメッセージの内容**: 「Googleログインがキャンセルされました。」
  - **システムの安全性**: 認証失敗でのアプリ状態の安定性維持
- **テストの目的**: 外部プロバイダー連携の堅牢性確保
  - **品質保証の観点**: サードパーティ連携エラーへの適切な対応確認
- 🟡 このテストケースの信頼性レベル（OAuth標準フローとして妥当な推測）

## 3. 境界値テストケース（極限条件での動作確認）

### T009: 複数タブでの同時ログイン
- **テスト名**: 同一ブラウザの複数タブでの同時認証処理
  - **境界値の意味**: セッション共有とタブ間状態同期の限界テスト
  - **境界値での動作保証**: 複数セッションでの一貫した認証状態管理
- **入力値**: 同一ブラウザで2つのタブから同時ログイン実行
  - **境界値選択の根拠**: ユーザーが最も頻繁に行う複数タブ操作の代表
  - **実際の使用場面**: ユーザーが複数タブでアプリを開いて同時作業
- **期待される結果**: 両タブで一貫した認証状態・セッション競合の適切な解決
  - **境界での正確性**: 最後にログインしたタブの状態が他タブに反映
  - **一貫した動作**: すべてのタブで同一ユーザー情報表示
- **テストの目的**: マルチタブ環境での状態管理堅牢性確認
  - **堅牢性の確認**: セッション競合・レースコンディション対応
- 🔴 このテストケースの信頼性レベル（タスク仕様にない推測ベース）

### T010: 認証中のブラウザクローズ・再開
- **テスト名**: 認証処理中のブラウザ強制終了・再起動での状態復元
  - **境界値の意味**: 認証処理の中断・再開に対する堅牢性の限界テスト
  - **境界値での動作保証**: 処理中断からの適切な状態復元
- **入力値**: OAuth認証中のブラウザ強制終了→再起動→ページアクセス
  - **境界値選択の根拠**: 最も予期しないタイミングでの処理中断
  - **実際の使用場面**: ブラウザクラッシュ・PCシャットダウン・タスクキル
- **期待される結果**: 未完了認証の適切な破棄・初期状態からの再認証促進
  - **境界での正確性**: 半端な認証状態の残存なし
  - **一貫した動作**: 常に明確な認証状態（認証済み or 未認証）
- **テストの目的**: 異常終了からの回復機能確認
  - **堅牢性の確認**: システムが常に一貫した状態を維持
- 🔴 このテストケースの信頼性レベル（タスク仕様にない推測ベース）

### T011: セッション期限切れ中のページ遷移
- **テスト名**: JWT期限切れ状態でのページ遷移時の適切な認証制御
  - **境界値の意味**: 認証状態とページアクセス権限の境界条件
  - **境界値での動作保証**: 期限切れ検出タイミングでの適切な制御
- **入力値**: JWT期限切れ状態で認証が必要なページへの遷移試行
  - **境界値選択の根拠**: セッション期限切れが最も問題となるタイミング
  - **実際の使用場面**: 長時間放置後のページ操作・ブックマークからの直接アクセス
- **期待される結果**: 自動的な認証ページリダイレクト・現在ページの保護・適切な認証促進
  - **境界での正確性**: 認証が必要なコンテンツの確実な保護
  - **一貫した動作**: すべての保護ページで統一された認証チェック
- **テストの目的**: 認証制御機能の完全性確保
  - **堅牢性の確認**: セキュリティホールの不存在確認
- 🟡 このテストケースの信頼性レベル（一般的な認証システム要件として妥当）

## テストケース実装時の日本語コメント指針

### テストケース開始時のコメント

```typescript
// 【テスト目的】: [このテストで何を確認するかを日本語で明記]
// 【テスト内容】: [具体的にどのような処理をテストするかを説明]
// 【期待される動作】: [正常に動作した場合の結果を説明]
// 🟢🟡🔴 この内容の信頼性レベルを記載
```

### Given（準備フェーズ）のコメント

```typescript
// 【テストデータ準備】: [なぜこのデータを用意するかの理由]
// 【初期条件設定】: [テスト実行前の状態を説明]
// 【前提条件確認】: [テスト実行に必要な前提条件を明記]
```

### When（実行フェーズ）のコメント

```typescript
// 【実際の処理実行】: [どの機能/メソッドを呼び出すかを説明]
// 【処理内容】: [実行される処理の内容を日本語で説明]
// 【実行タイミング】: [なぜこのタイミングで実行するかを説明]
```

### Then（検証フェーズ）のコメント

```typescript
// 【結果検証】: [何を検証するかを具体的に説明]
// 【期待値確認】: [期待される結果とその理由を説明]
// 【品質保証】: [この検証がシステム品質にどう貢献するかを説明]
```

### 各expectステートメントのコメント

```typescript
// 【検証項目】: [この検証で確認している具体的な項目]
// 🟢🟡🔴 この内容の信頼性レベルを記載
expect(result.user).toBeDefined(); // 【確認内容】: ユーザー情報が正常に取得されることを確認
expect(result.isNewUser).toBe(true); // 【確認内容】: 新規ユーザーフラグが正しく設定されることを確認
```

### セットアップ・クリーンアップのコメント

```typescript
beforeEach(() => {
  // 【テスト前準備】: [各テスト実行前に行う準備作業の説明]
  // 【環境初期化】: [テスト環境をクリーンな状態にする理由と方法]
});

afterEach(() => {
  // 【テスト後処理】: [各テスト実行後に行うクリーンアップ作業の説明]
  // 【状態復元】: [次のテストに影響しないよう状態を復元する理由]
});
```

## パフォーマンステスト要件

各テストケースで以下のパフォーマンス要件を検証：

- **認証フロー全体**: 10秒以内
- **JWT検証**: 1秒以内
- **JITプロビジョニング**: 2秒以内
- **ユーザー情報取得**: 500ms以内

## テストケース実装優先度

1. **高優先度（必須実装）**: T001〜T004（正常系）
2. **中優先度（推奨実装）**: T005〜T008（異常系）
3. **低優先度（任意実装）**: T009〜T011（境界値）

## テスト環境要件

- **テスト用Supabaseプロジェクト**: 本番環境と分離
- **テスト用PostgreSQLデータベース**: 独立したテスト専用DB
- **Google OAuthモック**: 外部依存を排除したモック実装
- **Docker Compose**: e2e コンテナでのPlaywright実行
