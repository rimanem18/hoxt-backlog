# TASK-401 E2Eテストスイート実装 - TDD要件定義書

作成日: 2025-01-22
更新日: 2025-01-22

## ユーザーによる手動変更

- `/` に認証済みでアクセスした場合、`dashboard` にリダイレクトを実装
- `/dashboard` の内容に、 UserProfile コンポーネントを使用した状態に変更（tsx の実装）

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

- 🟢 **何をする機能か**: フロントエンドの認証フロー全体をEnd-to-Endでテストする自動化テストスイートの実装
- 🟢 **解決する問題**: 手動テストによる品質確認の工数削減と、CI/CDパイプラインでの継続的品質保証
- 🟢 **想定されるユーザー**: 開発チーム（品質保証・リリース確認用）
- 🟢 **システム内での位置づけ**: 品質保証レイヤー（既存の単体・統合テストの上位に位置する最終品質ゲート）
- **参照したEARS要件**: [タスクドキュメント: TASK-401 E2Eテストスイート実装]
- **参照した設計文書**: [frontend-tasks.md フェーズ7統合・品質保証セクション]

## 2. 入力・出力の仕様（EARS機能要件・TypeScript型定義ベース）

- 🟢 **入力パラメータ**: 
  - テスト実行コマンド（`bun test:e2e` 等）
  - 環境変数（テスト用Supabase設定、テスト用データベース設定）
  - テストシナリオ設定（ブラウザ、デバイス、並列実行数）
- 🟢 **出力値**:
  - テスト実行結果レポート（成功/失敗、実行時間、スクリーンショット）
  - パフォーマンス測定結果（認証フロー時間、API応答時間）
  - JUnit XML形式のテスト結果（CI/CD統合用）
- 🟢 **データフロー**: ブラウザ → フロントエンド → バックエンドAPI → データベース → レスポンス確認
- **参照したEARS要件**: [TASK-401テストシナリオ・パフォーマンス要件]
- **参照した設計文書**: [dataflow.md 認証フロー図]

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

- 🟢 **パフォーマンス要件**:
  - 認証フロー全体: 10秒以内
  - JWT検証: 1秒以内  
  - JITプロビジョニング: 2秒以内
  - ユーザー情報取得: 500ms以内
- 🟢 **技術制約**: 
  - Playwright使用必須
  - Docker Compose環境での実行
  - テスト用データベースの分離
- 🟡 **セキュリティ要件**: テスト用認証データの適切な管理（テスト用トークン・シークレット）
- 🟢 **環境制約**: クライアントコンテナ内でのBunテストランナー実行
- **参照したEARS要件**: [TASK-401パフォーマンステスト要件]
- **参照した設計文書**: [architecture.md DDD+クリーンアーキテクチャ制約]

## 4. 想定される使用例（EARSEdgeケース・データフローベース）

- 🟢 **基本的な使用パターン**:
  - 初回ログインフロー（JITプロビジョニング発生）
  - 2回目以降ログインフロー（既存ユーザー認証）
  - ログアウトフロー
  - ページリロード時の認証状態復元
- 🟡 **エラーケース**:
  - 認証エラー時のハンドリング（無効JWT、期限切れトークン）
  - ネットワークエラー時の適切なフォールバック
  - Google OAuth認証失敗時のエラー表示
- 🔴 **エッジケース**（推測ベース）:
  - 複数タブでの同時ログイン
  - 認証中のブラウザクローズ・再開
  - セッション期限切れ中のページ遷移
- **参照したEARS要件**: [TASK-401テストシナリオ項目]
- **参照した設計文書**: [dataflow.md 認証フロー図・エラーハンドリング]

## 5. EARS要件・設計文書との対応関係

- **参照したタスク仕様**: TASK-401 E2Eテストスイート実装
- **参照した機能要件**: [フロントエンド認証フロー、ユーザープロフィール表示]
- **参照した非機能要件**: [パフォーマンス要件: 10秒以内認証完了等]
- **参照したEdgeケース**: [認証エラー時ハンドリング]
- **参照した受け入れ基準**: [全E2Eテスト通過、パフォーマンス目標クリア]
- **参照した設計文書**:
  - **タスク仕様**: [frontend-tasks.md TASK-401項目]
  - **データフロー**: [dataflow.md 認証フロー図]
  - **API仕様**: [api-endpoints.md 認証・ユーザーAPI]
  - **アーキテクチャ**: [architecture.md Next.js + Hono構成]

## 6. 技術仕様詳細

### 6.1 Playwright設定要件
- TypeScript設定
- 複数ブラウザ対応（Chromium, Firefox, Safari）
- ヘッドレス・ヘッド付き実行対応
- スクリーンショット・動画記録

### 6.2 テスト環境分離
- テスト用Supabaseプロジェクト
- テスト用PostgreSQLデータベース
- テストデータのセットアップ・クリーンアップ
- 環境変数による設定切り替え

### 6.3 モック化対象
- Google OAuth フロー
- 外部API呼び出し
- タイムゾーン・日時固定

### 6.4 CI/CD統合
- GitHub Actions統合
- JUnit XML レポート出力
- 成果物のアーカイブ（スクリーンショット等）

## 7. 実装優先度

1. **高優先度（必須）**: 基本認証フローE2Eテスト
2. **中優先度（推奨）**: エラーケースE2Eテスト  
3. **低優先度（任意）**: エッジケースE2Eテスト、パフォーマンステスト
