# TASK-104: Supabase認証プロバイダー実装 - Redフェーズ

作成日: 2025-08-17  
フェーズ: Red（失敗するテスト作成）

## 実装したテストケース

### 1. テストファイル配置
- **ファイル**: `app/server/src/infrastructure/auth/__tests__/SupabaseAuthProvider.test.ts`
- **テストフレームワーク**: Bun標準テスト
- **言語**: TypeScript

### 2. テストケース詳細

#### verifyTokenメソッドテスト
1. **有効なGoogle OAuth JWTが正常に検証される**
   - 🟢 要件定義書・JWTペイロード仕様から明確に定義済み
   - 正常系の核心機能テスト
   - JWT署名検証・ペイロード抽出・型安全性の確認

2. **不正な署名のJWTが確実に拒否される**
   - 🟢 EARS要件EDGE-002から明確に定義済み
   - セキュリティ要件の確認
   - 改ざんされたトークンでの不正認証防止

3. **有効期限が切れたJWTが確実に拒否される**
   - 🟢 セキュリティ要件・JWT仕様から明確に定義済み
   - セッション期限管理の確認
   - 古いトークンによる不正アクセス防止

4. **JWT形式に準拠しないトークンが確実に拒否される**
   - 🟢 JWT仕様・エラーハンドリング要件から明確に定義済み
   - 入力検証機能の確認
   - 不正な入力によるシステム不安定化防止

5. **空文字列やnullトークンが適切に拒否される**
   - 🟢 入力検証要件から明確に定義済み
   - 境界値テスト
   - null値チェックの正常動作保証

#### getExternalUserInfoメソッドテスト
1. **完全なJWTペイロードから正確なユーザー情報が抽出される**
   - 🟢 ExternalUserInfo型定義から明確に定義済み
   - データ変換処理の正確性確認
   - 日本語名の適切な処理確認

2. **avatar_urlが存在しない場合に適切に処理される**
   - 🟢 オプションフィールド仕様から明確に定義済み
   - オプションフィールド処理の確認
   - undefined値の適切な処理

3. **必須フィールド不足ペイロードでエラーが発生する**
   - 🟢 要件定義書エッジケースから明確に定義済み
   - データ検証機能の確認
   - 不完全なデータによるシステム不整合防止

### 3. テストコード特徴

#### 日本語コメント実装
- **テスト目的**: 各テストで何を確認するかを明記
- **テスト内容**: 具体的な処理内容の説明
- **期待される動作**: 正常動作時の結果説明
- **信頼性レベル**: 🟢🟡🔴による情報源の明示

#### Given-When-Thenパターン
```typescript
// Given（準備）
// 【テストデータ準備】: データ準備の理由説明
// 【初期条件設定】: テスト実行前の状態説明

// When（実行）
// 【実際の処理実行】: 呼び出し機能の説明
// 【処理内容】: 実行される処理の内容説明

// Then（検証）
// 【結果検証】: 検証する内容の説明
// 【期待値確認】: 期待される結果とその理由
```

#### 詳細なアサーション
- 各`expect`ステートメントに日本語コメント
- 検証項目の具体的な内容説明
- 信頼性レベル（🟢🟡🔴）の併記

### 4. テスト実行結果

#### 期待された失敗
```bash
error: Cannot find module '../SupabaseAuthProvider' from '/home/bun/app/server/src/infrastructure/auth/__tests__/SupabaseAuthProvider.test.ts'
```

#### 失敗理由分析
- **原因**: `SupabaseAuthProvider`クラスが未実装
- **TDD適合性**: Redフェーズでは実装前にテストを作成するため、期待通りの失敗
- **次のステップ**: Greenフェーズで最小実装を行い、テストを通す

### 5. 品質評価

#### 高品質な要素
✅ **テストケース設計**:
- 正常系・異常系・境界値テストを網羅
- セキュリティ要件を重視したテストケース
- 型安全性を考慮したTypeScript実装

✅ **コメント品質**:
- 日本語による詳細な説明
- テスト目的・内容・期待動作の明確化
- 信頼性レベル指標による透明性確保

✅ **技術適合性**:
- プロジェクトの技術スタック（Bun、TypeScript）に準拠
- DDD + クリーンアーキテクチャに適合した構造
- IAuthProviderインターフェースへの準拠確認

#### 信頼性レベル
- 🟢 **90%**: EARS要件定義書・設計文書・型定義から明確に定義
- 🟡 **10%**: JWT仕様・境界値設定から妥当な推測
- 🔴 **0%**: 根拠のない推測は含まれていない

### 6. 次のフェーズへの要求事項

#### Greenフェーズで実装必要な項目
1. **SupabaseAuthProviderクラス**: IAuthProviderインターフェース実装
2. **verifyTokenメソッド**: JWT検証機能の最小実装
3. **getExternalUserInfoメソッド**: ペイロード変換の最小実装
4. **環境変数処理**: SUPABASE_JWT_SECRET読み込み機能
5. **基本的なエラーハンドリング**: 例外処理の実装

#### 実装方針
- 最小限の機能でテストを通すことを優先
- セキュリティ要件は妥協しない
- 型安全性を保った実装
- DIP（依存性逆転の原則）の遵守