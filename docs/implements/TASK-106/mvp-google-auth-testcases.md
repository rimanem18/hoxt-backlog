# TDDテストケースの洗い出し

**【機能名】**: mvp-google-auth (TASK-106: ユーザープロフィール取得UseCase)

## テストケース分類

### 1. 正常系テストケース（基本的な動作）

#### ① ユーザープロフィール取得成功テスト
- **テスト名**: 存在するユーザーIDでプロフィール取得が成功する
  - **何をテストするか**: 有効なuserIdを指定した場合の正常なプロフィール情報取得
  - **期待される動作**: UserRepositoryから対象ユーザー情報を取得し、適切な形式で返却
- **入力値**: `{ userId: "12345678-1234-1234-1234-123456789012" }`（有効なUUID）
  - **入力データの意味**: データベースに存在する実際のユーザーIDを代表
- **期待される結果**: `{ user: User }` 形式でユーザー情報を返却
  - **期待結果の理由**: 要件定義REQ-005に基づく正常系の基本動作確認
- **テストの目的**: Application層の基本機能確認
  - **確認ポイント**: UserRepository.findByIdの正常呼び出しと戻り値の構造
- 🔵 要件定義書・設計文書から明確に抽出

#### ② レスポンス時間要件テスト
- **テスト名**: プロフィール取得が500ms以内で完了する
  - **何をテストするか**: NFR-002のパフォーマンス要件達成確認
  - **期待される動作**: 処理時間測定し500ms以内で完了
- **入力値**: `{ userId: "12345678-1234-1234-1234-123456789012" }`（標準的なケース）
  - **入力データの意味**: 通常の処理負荷でのパフォーマンス測定
- **期待される結果**: 実行時間 < 500ms
  - **期待結果の理由**: NFR-002の非機能要件に基づく品質保証
- **テストの目的**: パフォーマンス要件の確認
  - **確認ポイント**: 処理時間の正確な測定と閾値以内完了
- 🔵 要件定義書NFR-002から明確に抽出

### 2. 異常系テストケース（エラーハンドリング）

#### ① ユーザー未存在エラーテスト
- **テスト名**: 存在しないユーザーIDでUserNotFoundErrorが発生する
  - **エラーケースの概要**: データベースに存在しないuserIdを指定した場合
  - **エラー処理の重要性**: 不正アクセスや削除済みユーザーへの適切な対応
- **入力値**: `{ userId: "00000000-0000-0000-0000-000000000000" }`（存在しないUUID）
  - **不正な理由**: データベースに存在しない架空のユーザーID
  - **実際の発生シナリオ**: 削除済みアカウント・無効なリンク・不正アクセス
- **期待される結果**: `UserNotFoundError` 例外のスロー
  - **エラーメッセージの内容**: "指定されたユーザーが見つかりません"
  - **システムの安全性**: 情報漏洩なく適切にエラー処理
- **テストの目的**: 不正データに対するエラーハンドリング確認
  - **品質保証の観点**: セキュリティ・ユーザビリティ・システム安定性向上
- 🔵 要件定義書EDGE-001から明確に抽出

#### ② UUID形式バリデーションエラーテスト
- **テスト名**: 無効なUUID形式でValidationErrorが発生する
  - **エラーケースの概要**: UUID形式でない不正な文字列を指定した場合
  - **エラー処理の重要性**: 入力値の整合性チェックによる処理の安定化
- **入力値**: `{ userId: "invalid-user-id" }`（非UUID形式文字列）
  - **不正な理由**: UUID v4規格に準拠しない形式の文字列
  - **実際の発生シナリオ**: フロントエンドバグ・APIの不正使用・手動テスト
- **期待される結果**: `ValidationError` 例外のスロー
  - **エラーメッセージの内容**: "ユーザーIDの形式が正しくありません"
  - **システムの安全性**: 不正入力による予期しないエラーの防止
- **テストの目的**: 入力値バリデーションの確認
  - **品質保証の観点**: データ整合性・予期しない動作の防止
- 🔵 要件定義書EDGE-002から明確に抽出

#### ③ データベース接続エラーテスト  
- **テスト名**: データベース接続障害でInfrastructureErrorが発生する
  - **エラーケースの概要**: データベース接続やクエリ実行時の障害
  - **エラー処理の重要性**: インフラ障害時の適切なエラー処理とログ出力
- **入力値**: `{ userId: "12345678-1234-1234-1234-123456789012" }`（正常なUUID）
  - **不正な理由**: 入力値は正常だが、インフラ層で障害発生をシミュレート
  - **実際の発生シナリオ**: DB接続断・メンテナンス・負荷過多・ネットワーク障害
- **期待される結果**: `InfrastructureError` 例外のスロー
  - **エラーメッセージの内容**: "システム内部エラーが発生しました"
  - **システムの安全性**: 詳細なエラー情報を隠蔽しユーザーには一般的なメッセージ
- **テストの目的**: インフラ層障害に対するエラーハンドリング確認
  - **品質保証の観点**: 障害時の系統的な対応・ログ出力・監視との連携
- 🔵 要件定義書EDGE-003から明確に抽出

### 3. 境界値テストケース（最小値、最大値、null等）

#### ① null入力値テスト
- **テスト名**: null値のuserIdでValidationErrorが発生する
  - **境界値の意味**: 必須パラメータの最小境界（null/undefined）
  - **境界値での動作保証**: 必須入力値の確実なチェック
- **入力値**: `{ userId: null }`（null値）
  - **境界値選択の根拠**: TypeScript上は許可されるがビジネス的に無効な値
  - **実際の使用場面**: フロントエンドの実装ミス・APIの不適切な呼び出し
- **期待される結果**: `ValidationError` 例外のスロー
  - **境界での正確性**: null値の適切な検出と拒否
  - **一貫した動作**: undefined・空文字との一貫したエラー処理
- **テストの目的**: 必須入力値の境界条件確認
  - **堅牢性の確認**: 予期しない入力値に対するシステムの防御能力
- 🟡 要件から妥当な推測（必須フィールドの境界値テスト）

#### ② 空文字入力値テスト
- **テスト名**: 空文字のuserIdでValidationErrorが発生する  
  - **境界値の意味**: 文字列長の最小境界（空文字）
  - **境界値での動作保証**: 意味のない入力値の適切な処理
- **入力値**: `{ userId: "" }`（空文字）
  - **境界値選択の根拠**: 最小長文字列として技術的に有効だが業務的に無効
  - **実際の使用場面**: フォーム未入力・クライアント側処理ミス
- **期待される結果**: `ValidationError` 例外のスロー
  - **境界での正確性**: 空文字の適切な検出と拒否
  - **一貫した動作**: null・undefined と同様のエラー処理
- **テストの目的**: 文字列境界値の確認
  - **堅牢性の確認**: 空データに対する適切な処理
- 🟡 要件から妥当な推測（文字列の境界値テスト）

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript
  - **言語選択の理由**: プロジェクトの標準技術スタック、型安全性確保
  - **テストに適した機能**: 型推論・インターフェース・型安全なモック
- **テストフレームワーク**: Bun標準テスト (`bun:test`)
  - **フレームワーク選択の理由**: プロジェクト標準、高速実行、TypeScript統合
  - **テスト実行環境**: Dockerコンテナ内（`docker compose exec server bun test`）
- 🔵 プロジェクトのCLAUDE.mdから明確に抽出

## テストケース実装構造

各テストケースは以下の構造で実装：

```typescript
describe('GetUserProfileUseCase', () => {
  describe('正常系テスト', () => {
    test('存在するユーザーIDでプロフィール取得が成功する', async () => {
      // 【テスト目的】: 認証済みユーザーのプロフィール情報取得機能の正常動作確認
      // 【テスト内容】: 有効なuserIdでUserRepository.findByIdを呼び出し、適切な形式で結果を返却
      // 【期待される動作】: User エンティティを含むGetUserProfileUseCaseOutputが返却される
      // 🔵 要件定義書REQ-005から明確に抽出

      // 【テストデータ準備】: データベースに存在するユーザーIDでテスト実行
      const userId = "12345678-1234-1234-1234-123456789012";
      
      // 【実際の処理実行】: GetUserProfileUseCaseのexecuteメソッド呼び出し
      const result = await sut.useCase.execute({ userId });
      
      // 【結果検証】: 返却された結果の構造と内容を確認
      // 【検証項目】: User エンティティが適切に格納されていることを確認
      expect(result.user).toBeDefined();
      expect(result.user.id).toBe(userId);
    });
  });
  
  describe('異常系テスト', () => {
    test('存在しないユーザーIDでUserNotFoundErrorが発生する', async () => {
      // 【テスト目的】: 存在しないユーザーIDに対するエラーハンドリング確認
      // 【テスト内容】: 未存在userIdでの適切な例外処理とエラーメッセージ確認  
      // 【期待される動作】: UserNotFoundError例外がスローされる
      // 🔵 要件定義書EDGE-001から明確に抽出
    });
  });
  
  describe('境界値テスト', () => {
    test('null値のuserIdでValidationErrorが発生する', async () => {
      // 【テスト目的】: 必須入力値の境界条件確認
      // 【テスト内容】: null値入力に対する適切なバリデーションエラー処理
      // 【期待される動作】: ValidationError例外がスローされる
      // 🟡 要件から妥当な推測（必須フィールドの境界値テスト）
    });
  });
  
  describe('パフォーマンステスト', () => {
    test('プロフィール取得が500ms以内で完了する', async () => {
      // 【テスト目的】: NFR-002パフォーマンス要件の達成確認
      // 【テスト内容】: 処理時間測定と閾値以内での完了確認
      // 【期待される動作】: 実行時間が500ms未満
      // 🔵 要件定義書NFR-002から明確に抽出
    });
  });
});
```

## テストファイル構成

```
app/server/src/application/usecases/__tests__/get-user-profile/
├── success.spec.ts              # 正常系テスト
├── user-not-found.spec.ts       # ユーザー未存在エラー
├── validation-error.spec.ts     # バリデーションエラー
├── infrastructure-error.spec.ts # インフラエラー
├── performance.spec.ts          # パフォーマンステスト
└── helpers/
    ├── makeSUT.ts              # SUTファクトリ
    ├── userFactory.ts          # テストデータファクトリ
    └── matchers.ts             # カスタムマッチャ
```
