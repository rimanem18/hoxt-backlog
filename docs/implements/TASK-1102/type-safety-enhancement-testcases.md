# TASK-1102: レスポンスバリデーション実装（開発環境）- TDDテストケース一覧

**作成日**: 2025-11-02
**更新日**: 2025-11-02
**タスクID**: TASK-1102
**機能名**: type-safety-enhancement（レスポンスバリデーション）

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript 5.9.2
  - **言語選択の理由**: プロジェクト全体でTypeScriptを採用しており、型安全性が保証される
  - **テストに適した機能**: 型推論により期待値の型が明確になり、テストの可読性が向上する
- **テストフレームワーク**: Bun標準テストフレームワーク（`bun:test`）
  - **フレームワーク選択の理由**: プロジェクトで統一されたテストフレームワークであり、高速に実行できる
  - **テスト実行環境**: Dockerコンテナ内のBunランタイム（`docker compose exec server bun test`）
- 🟢 **信頼性レベル**: 青信号（プロジェクト標準に従っており推測なし）

## テストケース分類

---

## 1. 正常系テストケース（基本的な動作）

### TC001: レスポンスバリデーション成功（開発環境）

- **テスト名**: 開発環境で正しいレスポンスデータがバリデーションに成功する
  - **何をテストするか**: 開発環境でレスポンススキーマに適合するデータが正常にバリデーションを通過すること
  - **期待される動作**: Zodバリデーションが成功し、レスポンスデータがそのまま返却される
- **入力値**:
  ```typescript
  NODE_ENV = 'development'
  responseData = {
    success: true,
    data: {
      id: "550e8400-e29b-41d4-a716-446655440000",
      externalId: "google_user_123",
      provider: "google",
      email: "test@example.com",
      name: "Test User",
      avatarUrl: "https://example.com/avatar.jpg",
      createdAt: "2025-11-02T10:00:00Z",
      updatedAt: "2025-11-02T10:00:00Z",
      lastLoginAt: "2025-11-02T10:00:00Z"
    }
  }
  ```
  - **入力データの意味**: ユーザー取得APIの正常なレスポンスデータ。すべてのフィールドがスキーマ定義に適合している
- **期待される結果**:
  - HTTPステータスコード: `200 OK`
  - レスポンスボディ: 入力データと同一
  - ログ出力: なし（正常動作のため）
  - **期待結果の理由**: バリデーションが成功すればレスポンスデータはそのまま返却され、エラーログは出力されない
- **テストの目的**: 開発環境で正常なレスポンスデータがバリデーションを通過することを確認
  - **確認ポイント**: Zodスキーマの `safeParse()` が `success: true` を返すこと
- 🟢 **信頼性レベル**: 青信号（要件定義REQ-006、architecture.mdのバリデーション戦略に基づく）

---

### TC002: レスポンスバリデーションスキップ（本番環境）

- **テスト名**: 本番環境でレスポンスバリデーションがスキップされる
  - **何をテストするか**: `NODE_ENV=production` の場合、レスポンスバリデーションが実行されないこと
  - **期待される動作**: Zodバリデーションをスキップし、パフォーマンスへの影響をゼロにする
- **入力値**:
  ```typescript
  NODE_ENV = 'production'
  responseData = { /* 任意のデータ */ }
  ```
  - **入力データの意味**: 本番環境でのレスポンスデータ。バリデーションが実行されないため、データの正当性は問わない
- **期待される結果**:
  - HTTPステータスコード: `200 OK`
  - レスポンスボディ: 入力データと同一
  - Zodバリデーション: 実行されない
  - ログ出力: なし
  - **期待結果の理由**: 本番環境ではパフォーマンス優先のため、バリデーションを無効化する設計
- **テストの目的**: 本番環境でレスポンスバリデーションがスキップされることを確認
  - **確認ポイント**: `process.env.NODE_ENV === 'production'` 分岐が正しく動作すること
- 🟢 **信頼性レベル**: 青信号（architecture.md「バリデーション戦略」、要件REQ-105に基づく）

---

### TC003: レスポンスバリデーション有効化（テスト環境）

- **テスト名**: テスト環境でレスポンスバリデーションが有効化される
  - **何をテストするか**: `NODE_ENV=test` の場合、レスポンスバリデーションが実行されること
  - **期待される動作**: 開発環境と同様にZodバリデーションが実行される
- **入力値**:
  ```typescript
  NODE_ENV = 'test'
  responseData = { /* 正しいスキーマのデータ */ }
  ```
  - **入力データの意味**: テスト環境での正常なレスポンスデータ。信頼性テストのためバリデーションが必要
- **期待される結果**:
  - HTTPステータスコード: `200 OK`
  - Zodバリデーション: 実行される
  - バリデーション成功時は正常レスポンス返却
  - **期待結果の理由**: テスト環境では信頼性テストのためバリデーションを有効にする設計
- **テストの目的**: テスト環境でレスポンスバリデーションが有効化されることを確認
  - **確認ポイント**: `NODE_ENV !== 'production'` の場合にバリデーションが実行されること
- 🟢 **信頼性レベル**: 青信号（architecture.md「環境分離」に基づく）

---

## 2. 異常系テストケース（エラーハンドリング）

### TC101: レスポンスバリデーション失敗（UUID形式エラー）

- **テスト名**: 開発環境でUUID形式が不正なレスポンスデータがバリデーションに失敗する
  - **エラーケースの概要**: レスポンスデータの `id` フィールドがUUID形式ではない場合
  - **エラー処理の重要性**: フロントエンドがUUID形式を期待しているため、不正なデータを送信するとランタイムエラーが発生する
- **入力値**:
  ```typescript
  NODE_ENV = 'development'
  responseData = {
    success: true,
    data: {
      id: "invalid-uuid", // UUID形式ではない
      externalId: "google_user_123",
      provider: "google",
      email: "test@example.com",
      name: "Test User",
      // ... 他のフィールド
    }
  }
  ```
  - **不正な理由**: `id` フィールドはUUID v4形式（`xxxxxxxx-xxxx-4xxx-xxxx-xxxxxxxxxxxx`）である必要があるが、`"invalid-uuid"` は形式に適合しない
  - **実際の発生シナリオ**: データベースから不正なデータが取得された場合や、Use Caseでのデータ生成ロジックにバグがある場合
- **期待される結果**:
  - HTTPステータスコード: `500 Internal Server Error`
  - レスポンスボディ:
    ```json
    {
      "success": false,
      "error": {
        "code": "INTERNAL_ERROR",
        "message": "サーバーエラー"
      }
    }
    ```
  - ログ出力:
    ```
    [ERROR] Response validation failed
    {
      "error": { /* Zodエラー詳細 */ },
      "endpoint": "/users/{id}",
      "method": "GET",
      "timestamp": "2025-11-02T10:00:00Z"
    }
    ```
  - **エラーメッセージの内容**: クライアントには具体的なエラー詳細を露出せず、安全なメッセージのみ返却
  - **システムの安全性**: バリデーション失敗時にシステムは安全な500エラーを返し、内部エラー詳細はログにのみ記録
- **テストの目的**: レスポンスバリデーション失敗時のエラーハンドリングを確認
  - **品質保証の観点**: 不正なデータがフロントエンドに送信されることを防ぎ、システムの信頼性を向上させる
- 🟢 **信頼性レベル**: 青信号（要件REQ-105、NFR-303、EDGE-005に基づく）

---

### TC102: レスポンスバリデーション失敗（必須フィールド欠落）

- **テスト名**: 開発環境で必須フィールドが欠落したレスポンスデータがバリデーションに失敗する
  - **エラーケースの概要**: レスポンスデータに必須フィールド（`email`など）が含まれていない場合
  - **エラー処理の重要性**: フロントエンドは必須フィールドの存在を前提としているため、欠落するとランタイムエラーが発生する
- **入力値**:
  ```typescript
  NODE_ENV = 'development'
  responseData = {
    success: true,
    data: {
      id: "550e8400-e29b-41d4-a716-446655440000",
      externalId: "google_user_123",
      provider: "google",
      // email フィールドが欠落
      name: "Test User",
      // ... 他のフィールド
    }
  }
  ```
  - **不正な理由**: `email` は必須フィールドであり、Zodスキーマで `z.email()` として定義されている
  - **実際の発生シナリオ**: データベースのデータ不整合や、Use Caseでのデータマッピングミス
- **期待される結果**:
  - HTTPステータスコード: `500 Internal Server Error`
  - レスポンスボディ: TC101と同様の安全なエラーレスポンス
  - ログ出力: Zodエラー詳細（`email`フィールド欠落）を含む
  - **エラーメッセージの内容**: クライアントには `"サーバーエラー"` のみ返却
  - **システムの安全性**: 内部エラー詳細を露出せず、ログに記録
- **テストの目的**: 必須フィールド欠落時のエラーハンドリングを確認
  - **品質保証の観点**: データ不整合を開発時に検出し、本番環境でのエラーを未然に防ぐ
- 🟢 **信頼性レベル**: 青信号（要件REQ-105、NFR-303に基づく）

---

### TC103: レスポンスバリデーション失敗（型の不一致）

- **テスト名**: 開発環境でフィールドの型が不正なレスポンスデータがバリデーションに失敗する
  - **エラーケースの概要**: レスポンスデータのフィールド型がスキーマ定義と一致しない場合
  - **エラー処理の重要性**: 型の不一致はフロントエンドでの型エラーやランタイムエラーの原因となる
- **入力値**:
  ```typescript
  NODE_ENV = 'development'
  responseData = {
    success: true,
    data: {
      id: "550e8400-e29b-41d4-a716-446655440000",
      externalId: 12345, // 数値型（string型であるべき）
      provider: "google",
      email: "test@example.com",
      name: "Test User",
      // ... 他のフィールド
    }
  }
  ```
  - **不正な理由**: `externalId` は文字列型であるべきだが、数値型になっている
  - **実際の発生シナリオ**: データベースの型定義ミスや、Use Caseでのデータ変換エラー
- **期待される結果**:
  - HTTPステータスコード: `500 Internal Server Error`
  - レスポンスボディ: TC101と同様の安全なエラーレスポンス
  - ログ出力: Zodエラー詳細（型の不一致）を含む
  - **エラーメッセージの内容**: クライアントには具体的なエラー内容を露出しない
  - **システムの安全性**: 型の不一致を開発時に検出し、安全にエラーレスポンスを返却
- **テストの目的**: 型の不一致時のエラーハンドリングを確認
  - **品質保証の観点**: TypeScriptの型システムとZodバリデーションの二重チェックにより、型安全性を強化
- 🟢 **信頼性レベル**: 青信号（要件REQ-006、REQ-105に基づく）

---

### TC104: エラーログの適切な出力

- **テスト名**: レスポンスバリデーション失敗時に詳細なエラーログが出力される
  - **エラーケースの概要**: バリデーション失敗時にサーバーログに詳細な情報が記録されること
  - **エラー処理の重要性**: 開発者がエラー原因を特定するために詳細なログ情報が必要
- **入力値**: TC101と同様（UUID形式エラー）
- **期待される結果**:
  - ログ出力フォーマット:
    ```
    logger.error('Response validation failed', {
      error: {
        issues: result.error.issues, // Zodエラー詳細
        name: result.error.name
      },
      endpoint: '/users/{id}',
      method: 'GET',
      timestamp: '2025-11-02T10:00:00.000Z'
    })
    ```
  - ログに含まれる情報:
    - Zodエラー詳細（`issues`配列）
    - エンドポイントパス
    - HTTPメソッド
    - タイムスタンプ
  - **エラーメッセージの内容**: 開発者が原因を特定できる詳細な情報
  - **システムの安全性**: ログは内部のみで、クライアントには露出しない
- **テストの目的**: エラーログが適切に出力されることを確認
  - **品質保証の観点**: エラー原因の迅速な特定により、開発効率を向上させる
- 🟢 **信頼性レベル**: 青信号（要件REQ-105、エラーケース1に基づく）

---

## 3. 境界値テストケース（最小値、最大値、null等）

### TC201: レスポンススキーマ未定義エンドポイント

- **テスト名**: レスポンススキーマが定義されていないエンドポイントでバリデーションがスキップされる
  - **境界値の意味**: スキーマが未定義（`undefined`）の状態は、バリデーション対象外の境界条件
  - **境界値での動作保証**: スキーマが未定義でもシステムがエラーにならず、安全にスキップすること
- **入力値**:
  ```typescript
  NODE_ENV = 'development'
  responseSchema = undefined // スキーマ未定義
  responseData = { /* 任意のデータ */ }
  ```
  - **境界値選択の根拠**: 新規エンドポイント追加時や、スキーマ定義前の状態を想定
  - **実際の使用場面**: 開発初期段階でスキーマ定義が未完成の場合
- **期待される結果**:
  - HTTPステータスコード: `200 OK`
  - レスポンスボディ: 入力データと同一
  - ログ出力:
    ```
    logger.warn('Response schema not defined', { endpoint: '/new-endpoint' })
    ```
  - **境界での正確性**: スキーマ未定義でもシステムは正常動作し、警告ログを出力
  - **一貫した動作**: バリデーションスキップは本番環境と同じ動作
- **テストの目的**: スキーマ未定義時の安全な動作を確認
  - **堅牢性の確認**: 想定外の状態でもシステムがクラッシュしないこと
- 🟡 **信頼性レベル**: 黄信号（要件定義書のエラーケース2から妥当な推測）

---

### TC202: 環境変数未設定時のデフォルト動作

- **テスト名**: `NODE_ENV` が未設定の場合、開発環境として扱われる
  - **境界値の意味**: 環境変数が未定義（`undefined`）の状態は、環境判定の境界条件
  - **境界値での動作保証**: 環境変数未設定でもデフォルトで安全な動作（開発環境として扱う）
- **入力値**:
  ```typescript
  process.env.NODE_ENV = undefined // 環境変数未設定
  responseData = { /* 正しいスキーマのデータ */ }
  ```
  - **境界値選択の根拠**: 本番環境以外はすべて開発環境として扱う安全な設計
  - **実際の使用場面**: ローカル開発時に環境変数が設定されていない場合
- **期待される結果**:
  - バリデーション: 実行される（開発環境として扱う）
  - `isProduction = process.env.NODE_ENV === 'production'` → `false`
  - **境界での正確性**: 未設定時は安全側（開発環境）に倒す設計
  - **一貫した動作**: `NODE_ENV=development` と同じ動作
- **テストの目的**: 環境変数未設定時のデフォルト動作を確認
  - **堅牢性の確認**: 環境設定ミスがあっても安全にバリデーションが実行されること
- 🟡 **信頼性レベル**: 黄信号（要件定義書のEDGE-006から妥当な推測）

---

### TC203: null値を含むレスポンスデータ

- **テスト名**: nullable フィールドに `null` が含まれるレスポンスデータがバリデーションに成功する
  - **境界値の意味**: `null` はnullableフィールドの有効な値であり、境界条件
  - **境界値での動作保証**: `null` を正常な値として受け入れること
- **入力値**:
  ```typescript
  NODE_ENV = 'development'
  responseData = {
    success: true,
    data: {
      id: "550e8400-e29b-41d4-a716-446655440000",
      externalId: "google_user_123",
      provider: "google",
      email: "test@example.com",
      name: "Test User",
      avatarUrl: null, // nullable フィールド
      lastLoginAt: null, // nullable フィールド
      createdAt: "2025-11-02T10:00:00Z",
      updatedAt: "2025-11-02T10:00:00Z"
    }
  }
  ```
  - **境界値選択の根拠**: `avatarUrl` と `lastLoginAt` はスキーマ定義で `nullable` として定義されている
  - **実際の使用場面**: ユーザーがアバター画像を未設定の場合や、初回ログイン時
- **期待される結果**:
  - HTTPステータスコード: `200 OK`
  - Zodバリデーション: 成功（`null` は有効な値）
  - レスポンスボディ: 入力データと同一
  - **境界での正確性**: `null` を正常な値として扱い、エラーにならない
  - **一貫した動作**: 非null値と同様に正常にバリデーションを通過
- **テストの目的**: nullable フィールドの境界値テスト
  - **堅牢性の確認**: `null` が正しくハンドリングされること
- 🟢 **信頼性レベル**: 青信号（interfaces.ts「User」型定義、Zodスキーマの `nullable()` に基づく）

---

## 4. パフォーマンステストケース

### TC301: Zodバリデーションのレスポンスタイムへの影響測定

- **テスト名**: 開発環境でZodバリデーションによるレスポンスタイムへの影響が許容範囲内である
  - **パフォーマンス要件**: NFR-001「Zodバリデーションによるレスポンスタイムへの影響を測定し、著しい劣化がないこと」
  - **許容範囲**: 🟡 バリデーションオーバーヘッドが50ms以内（TASK-1101のベンチマーク基準から推測）
- **入力値**:
  ```typescript
  NODE_ENV = 'development'
  responseData = { /* 大量のフィールドを含む正常なデータ */ }
  ```
  - **テスト方法**: 1000回のバリデーション実行時間を測定し、平均レスポンスタイムを算出
- **期待される結果**:
  - 平均バリデーション時間: 50ms以内
  - 全体レスポンスタイムへの影響: 10%以内
  - **パフォーマンス基準の理由**: ユーザー体験を損なわない範囲でのバリデーション実行
- **テストの目的**: Zodバリデーションのパフォーマンス影響を測定
  - **確認ポイント**: 開発環境で許容可能なパフォーマンスであること
- 🟡 **信頼性レベル**: 黄信号（NFR-001から妥当な推測、具体的な閾値はTASK-1101の実績から推測）

---

### TC302: 本番環境でのバリデーションスキップによるパフォーマンス最適化

- **テスト名**: 本番環境でバリデーションをスキップすることによりパフォーマンスへの影響がゼロである
  - **パフォーマンス要件**: 本番環境ではレスポンスバリデーション無効化（パフォーマンス優先）
- **入力値**:
  ```typescript
  NODE_ENV = 'production'
  responseData = { /* 任意のデータ */ }
  ```
  - **テスト方法**: 本番環境と開発環境でのレスポンスタイムを比較
- **期待される結果**:
  - バリデーション実行: なし
  - レスポンスタイムへの影響: ゼロ（バリデーション分のオーバーヘッドなし）
  - **パフォーマンス基準の理由**: 本番環境では最大限のパフォーマンスを優先
- **テストの目的**: 本番環境でのバリデーションスキップによるパフォーマンス最適化を確認
  - **確認ポイント**: バリデーション処理が完全にスキップされること
- 🟢 **信頼性レベル**: 青信号（architecture.md「パフォーマンス設計」、NFR-001に基づく）

---

## テストケース実装時の日本語コメント指針

### テストケース開始時のコメント

```typescript
// 【テスト目的】: レスポンスバリデーション成功時の正常動作を確認
// 【テスト内容】: 開発環境で正しいスキーマのレスポンスデータがバリデーションを通過すること
// 【期待される動作】: Zodバリデーションが成功し、200 OKレスポンスが返却される
// 🟢 信頼性レベル: 青信号（要件REQ-006に基づく）
```

### Given（準備フェーズ）のコメント

```typescript
// 【テストデータ準備】: 正しいスキーマに適合するユーザーレスポンスデータを作成
// 【初期条件設定】: NODE_ENV=developmentで開発環境をシミュレート
// 【前提条件確認】: Zodスキーマが正しく定義されていること
```

### When（実行フェーズ）のコメント

```typescript
// 【実際の処理実行】: Zodスキーマでレスポンスデータをバリデーション
// 【処理内容】: getUserResponseSchema.safeParse(responseData)を実行
// 【実行タイミング】: レスポンス送信前にバリデーションを実行
```

### Then（検証フェーズ）のコメント

```typescript
// 【結果検証】: バリデーション結果が成功であることを確認
// 【期待値確認】: result.success === true であることを検証
// 【品質保証】: レスポンスデータの型安全性が保証されることを確認
```

### 各expectステートメントのコメント

```typescript
// 【検証項目】: Zodバリデーションの成功フラグ
// 🟢 信頼性レベル: 青信号
expect(result.success).toBe(true); // 【確認内容】: バリデーションが成功したこと

// 【検証項目】: HTTPステータスコード
expect(response.status).toBe(200); // 【確認内容】: 正常レスポンスが返却されたこと

// 【検証項目】: レスポンスボディの内容
expect(response.body).toEqual(expectedData); // 【確認内容】: 期待されるデータが返却されたこと
```

### セットアップ・クリーンアップのコメント

```typescript
beforeEach(() => {
  // 【テスト前準備】: 環境変数を開発環境に設定
  // 【環境初期化】: 各テストが独立して実行できるようにモックをリセット
  process.env.NODE_ENV = 'development';
  vi.clearAllMocks();
});

afterEach(() => {
  // 【テスト後処理】: 環境変数を元に戻す
  // 【状態復元】: 次のテストに影響しないようモックをクリア
  delete process.env.NODE_ENV;
  vi.restoreAllMocks();
});
```

---

## テストケース実装の優先順位

### 優先度: 高（Phase 1）
1. **TC001**: レスポンスバリデーション成功（開発環境）
2. **TC002**: レスポンスバリデーションスキップ（本番環境）
3. **TC101**: レスポンスバリデーション失敗（UUID形式エラー）
4. **TC104**: エラーログの適切な出力

### 優先度: 中（Phase 2）
5. **TC003**: レスポンスバリデーション有効化（テスト環境）
6. **TC102**: レスポンスバリデーション失敗（必須フィールド欠落）
7. **TC103**: レスポンスバリデーション失敗（型の不一致）
8. **TC203**: null値を含むレスポンスデータ

### 優先度: 低（Phase 3）
9. **TC201**: レスポンススキーマ未定義エンドポイント
10. **TC202**: 環境変数未設定時のデフォルト動作
11. **TC301**: Zodバリデーションのレスポンスタイムへの影響測定
12. **TC302**: 本番環境でのバリデーションスキップによるパフォーマンス最適化

---

## 品質判定

### ✅ テストケースの品質: 高品質

- **テストケース分類**: 正常系（3件）・異常系（4件）・境界値（3件）・パフォーマンス（2件）が網羅されている
- **期待値定義**: 各テストケースの期待値が明確に定義されている
- **技術選択**: TypeScript + Bun標準テストフレームワーク（プロジェクト標準）
- **実装可能性**: 既存テストコード（get-user-profile/success.test.ts等）を参考に実現可能

### 判定理由
- EARS要件定義書（REQ-006, REQ-105, NFR-001, NFR-303）に基づき、テストケースを網羅的に定義
- architecture.md、dataflow.mdの設計に沿った実装可能なテストケース
- 既存のテストコードスタイルに準拠した日本語コメント指針
- Given-When-Thenパターンを明確に定義

---

## 次のステップ

次のお勧めステップ: **`/tdd-red`** でRedフェーズ（失敗テスト作成）を開始します。
